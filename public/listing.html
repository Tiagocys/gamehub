<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Anúncio</title>
  <link rel="stylesheet" href="css/global.css" />
  <style>
    .seller-profile-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--ink);
      text-decoration: none;
      font-weight: 700;
    }

    .seller-profile-link:hover {
      text-decoration: underline;
    }

    .seller-profile-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: #fff;
      display: block;
    }

    .seller-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .seller-discord {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      word-break: break-word;
    }

    .seller-discord-icon {
      width: 14px;
      height: 14px;
      object-fit: contain;
      display: block;
    }

    .seller-recommendations {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #76a8ff;
      font-weight: 700;
      white-space: nowrap;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }

    .seller-recommendations img {
      width: 14px;
      height: 14px;
      object-fit: contain;
      display: block;
    }

    .listing-report-card {
      margin-top: 2px;
      padding: 12px;
    }

    .report-trigger {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .report-icon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      display: block;
    }

    .report-form {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(12, 21, 51, 0.03);
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .report-form textarea {
      min-height: 92px;
      resize: vertical;
    }

    .report-feedback {
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
    }

    .report-success-banner {
      margin-top: 10px;
      border: 1px solid #bfe6c8;
      border-radius: 12px;
      padding: 10px 12px;
      background: #ecfff1;
      color: #146c2e;
      font-size: 14px;
    }

    .recommenders-modal {
      position: fixed;
      inset: 0;
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(12, 21, 51, 0.56);
    }

    .recommenders-modal.open {
      display: flex;
    }

    .recommenders-modal-card {
      width: min(560px, 100%);
      max-height: min(80vh, 640px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .recommenders-modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }

    .recommenders-modal-head h3 {
      font-size: 18px;
      margin: 0;
    }

    .recommenders-modal-close {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .recommenders-wrap {
      overflow-y: auto;
      display: grid;
      gap: 0;
    }

    .recommender-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: var(--ink);
    }

    .recommender-item:last-child {
      border-bottom: none;
    }

    .recommender-item:hover {
      background: rgba(14, 165, 233, 0.08);
    }

    .recommender-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: #fff;
      display: block;
    }

    .recommender-name {
      font-weight: 700;
      font-size: 13px;
      line-height: 1.2;
    }

    .recommenders-empty {
      padding: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .recommenders-loading {
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--border);
      background: rgba(12, 21, 51, 0.02);
    }
  </style>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <site-navbar></site-navbar>

    <main class="section listing-page">
      <div class="listing-hero-card">
        <div class="listing-hero-copy">
          <h1 id="listing-title">Carregando...</h1>
          <div class="seller-meta-row">
            <a id="seller-profile-link" class="seller-profile-link" href="#" style="display:none;"></a>
            <button id="seller-recommendations" class="seller-recommendations" type="button" style="display:none;" aria-expanded="false"></button>
          </div>
          <span id="seller-discord" class="seller-discord" style="display:none;"></span>
          <div id="listing-contact-actions" class="inline-actions listing-contact-actions" style="display:none;">
            <a id="telegram-chat" class="btn btn-telegram btn-contact-cta" href="#" target="_blank" rel="noopener" style="display:none;">
              Conversar no Telegram
              <img src="img/telegram.webp" alt="" class="btn-icon" />
            </a>
            <a id="whatsapp-chat" class="btn btn-whatsapp btn-contact-cta" href="#" target="_blank" rel="noopener" style="display:none;">
              Conversar no WhatsApp
              <img src="img/wtsp.png" alt="" class="btn-icon" />
            </a>
          </div>
          <div id="listing-meta" class="pill-trail"></div>
          <p id="listing-description" class="listing-description-preserve">Carregando descrição...</p>
        </div>
        <div class="listing-gallery">
          <div id="listing-main" class="listing-gallery-main">Sem imagem</div>
          <div id="listing-thumbs" class="listing-thumb-grid"></div>
          <section id="report-listing-card" class="hero-card listing-report-card">
            <button id="report-listing-btn" class="btn btn-ghost report-trigger" type="button">
              <img src="img/flag.png" alt="" class="report-icon" />
              Denunciar anúncio
            </button>
            <div id="report-listing-form" class="report-form" style="display:none;">
              <label for="report-listing-reason">Descreva o problema</label>
              <textarea id="report-listing-reason" placeholder="Explique por que este anúncio deve ser analisado."></textarea>
              <label for="report-listing-files">Anexos (opcional, até 4 imagens)</label>
              <input id="report-listing-files" class="input" type="file" accept="image/*" multiple />
              <div id="report-listing-files-info" class="helper">Nenhuma imagem selecionada.</div>
              <div class="inline-actions">
                <button id="report-listing-submit" class="btn btn-primary" type="button">Enviar denúncia</button>
                <button id="report-listing-cancel" class="btn btn-ghost" type="button">Cancelar</button>
              </div>
              <div id="report-listing-feedback" class="report-feedback"></div>
            </div>
            <div id="report-listing-success" class="report-success-banner" style="display:none;" role="status" aria-live="polite"></div>
          </section>
        </div>
      </div>
    </main>

    <site-footer></site-footer>
  </div>
  <div id="recommenders-modal" class="recommenders-modal" aria-hidden="true">
    <div class="recommenders-modal-card">
      <div class="recommenders-modal-head">
        <h3>Usuários que recomendaram</h3>
        <button id="recommenders-modal-close" class="recommenders-modal-close" type="button" aria-label="Fechar">×</button>
      </div>
      <div id="recommenders-wrap" class="recommenders-wrap">
        <div id="recommenders-list"></div>
        <div id="recommenders-loading" class="recommenders-loading" style="display:none;">Carregando mais perfis...</div>
      </div>
      <p id="recommenders-empty" class="recommenders-empty" style="display:none;">Nenhuma recomendação ainda.</p>
    </div>
  </div>

  <script src="env.js"></script>
  <script src="js/site-navbar.js"></script>
  <script src="js/site-footer.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    await (window.__NAVBAR_READY__ || Promise.resolve());

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
    const R2_PUBLIC_URL = env.R2_PUBLIC_URL || "";
    const R2_BUCKET = env.R2_BUCKET || "";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const createListingBtn = document.getElementById("create-listing-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const profileLink = document.getElementById("profile-link");
    const titleEl = document.getElementById("listing-title");
    const sellerProfileLink = document.getElementById("seller-profile-link");
    const sellerDiscord = document.getElementById("seller-discord");
    const sellerRecommendations = document.getElementById("seller-recommendations");
    const descriptionEl = document.getElementById("listing-description");
    const metaEl = document.getElementById("listing-meta");
    const contactActionsRow = document.getElementById("listing-contact-actions");
    const telegramChat = document.getElementById("telegram-chat");
    const whatsappChat = document.getElementById("whatsapp-chat");
    const mainMedia = document.getElementById("listing-main");
    const thumbGrid = document.getElementById("listing-thumbs");
    const reportListingBtn = document.getElementById("report-listing-btn");
    const reportListingCard = document.getElementById("report-listing-card");
    const reportListingForm = document.getElementById("report-listing-form");
    const reportListingReason = document.getElementById("report-listing-reason");
    const reportListingFiles = document.getElementById("report-listing-files");
    const reportListingFilesInfo = document.getElementById("report-listing-files-info");
    const reportListingSubmit = document.getElementById("report-listing-submit");
    const reportListingCancel = document.getElementById("report-listing-cancel");
    const reportListingFeedback = document.getElementById("report-listing-feedback");
    const reportListingSuccess = document.getElementById("report-listing-success");
    const recommendersModal = document.getElementById("recommenders-modal");
    const recommendersModalClose = document.getElementById("recommenders-modal-close");
    const recommendersWrap = document.getElementById("recommenders-wrap");
    const recommendersList = document.getElementById("recommenders-list");
    const recommendersLoadingEl = document.getElementById("recommenders-loading");
    const recommendersEmpty = document.getElementById("recommenders-empty");

    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let avatarReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !avatarReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });

    let supabase;
    let currentUser = null;
    let avatarLoaded = false;
    let currentListing = null;
    let currentGalleryImages = [];
    let lightboxImages = [];
    let lightboxIndex = 0;
    let lightboxRoot = null;
    let recommendersTargetUserId = null;
    let recommendersOffset = 0;
    let recommendersHasMore = true;
    let recommendersLoading = false;
    let recommendersFetched = false;
    const RECOMMENDERS_PAGE_SIZE = 8;
    const REPORT_MAX_ATTACHMENTS = 4;
    const REPORT_MAX_FILE_BYTES = 6 * 1024 * 1024;
    const REPORT_MAX_DIMENSION = 1600;
    const REPORT_WEBP_QUALITY = 0.82;
    let reportSuccessTimer = null;
    if (avatarImg) avatarImg.referrerPolicy = "no-referrer";

    const CATEGORY_LABELS = {
      item: "Item ou itens",
      currency: "Moeda do game",
      account: "Conta ou personagem",
      service: "Serviço",
      other: "Outro"
    };

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        titleEl.textContent = "Supabase não configurado.";
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        if (profileLink) profileLink.href = `user.html?id=${encodeURIComponent(currentUser.id)}`;
        loadUserAvatar();
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        return;
      }
      authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (profileLink) profileLink.href = "profile.html";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      avatarLoaded = false;
      markAvatarReady();
    }

    function getReportFiles() {
      return Array.from(reportListingFiles?.files || []).slice(0, REPORT_MAX_ATTACHMENTS);
    }

    function updateReportFilesInfo() {
      if (!reportListingFilesInfo) return;
      const rawCount = reportListingFiles?.files?.length || 0;
      if (rawCount === 0) {
        reportListingFilesInfo.textContent = "Nenhuma imagem selecionada.";
        return;
      }
      if (rawCount > REPORT_MAX_ATTACHMENTS) {
        reportListingFilesInfo.textContent = `Você selecionou ${rawCount} imagens. Serão enviadas apenas ${REPORT_MAX_ATTACHMENTS}.`;
        return;
      }
      reportListingFilesInfo.textContent = `${rawCount} imagem(ns) selecionada(s).`;
    }

    function hideReportSuccess() {
      if (!reportListingSuccess) return;
      reportListingSuccess.style.display = "none";
      reportListingSuccess.textContent = "";
      if (reportSuccessTimer) {
        clearTimeout(reportSuccessTimer);
        reportSuccessTimer = null;
      }
    }

    function showReportSuccess(message) {
      if (!reportListingSuccess) return;
      reportListingSuccess.textContent = message;
      reportListingSuccess.style.display = "block";
      if (reportSuccessTimer) {
        clearTimeout(reportSuccessTimer);
      }
      reportSuccessTimer = setTimeout(() => {
        hideReportSuccess();
      }, 7000);
    }

    function renderRecommendersEmpty(show) {
      if (recommendersEmpty) {
        recommendersEmpty.style.display = show ? "block" : "none";
      }
      if (recommendersWrap) {
        recommendersWrap.style.display = show ? "none" : "block";
      }
    }

    function openRecommendersModal() {
      if (!recommendersModal) return;
      recommendersModal.classList.add("open");
      recommendersModal.setAttribute("aria-hidden", "false");
      document.body.classList.add("no-scroll");
      if (sellerRecommendations) {
        sellerRecommendations.setAttribute("aria-expanded", "true");
      }
    }

    function closeRecommendersModal() {
      if (!recommendersModal) return;
      recommendersModal.classList.remove("open");
      recommendersModal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("no-scroll");
      if (sellerRecommendations) {
        sellerRecommendations.setAttribute("aria-expanded", "false");
      }
    }

    function setRecommendersLoading(show) {
      if (recommendersLoadingEl) {
        recommendersLoadingEl.style.display = show ? "block" : "none";
      }
    }

    function appendRecommenderItem(recommendation, user) {
      if (!recommendersList) return;
      const link = document.createElement("a");
      link.className = "recommender-item";
      link.href = `user.html?id=${encodeURIComponent(recommendation.author_id)}`;

      const avatar = document.createElement("img");
      avatar.className = "recommender-avatar";
      avatar.src = user?.avatar_url || "img/avatar.svg";
      avatar.alt = "Avatar do usuário";
      avatar.referrerPolicy = "no-referrer";
      avatar.loading = "lazy";
      avatar.addEventListener("error", () => {
        avatar.src = "img/avatar.svg";
      });

      const copy = document.createElement("div");
      const firstName = (user?.first_name || "").trim();
      const lastName = (user?.last_name || "").trim();
      const fullName = `${firstName} ${lastName}`.trim() || "Usuário da comunidade";
      const nameEl = document.createElement("div");
      nameEl.className = "recommender-name";
      nameEl.textContent = fullName;
      copy.appendChild(nameEl);

      link.appendChild(avatar);
      link.appendChild(copy);
      recommendersList.appendChild(link);
    }

    async function loadMoreRecommenders({ reset = false } = {}) {
      if (!recommendersTargetUserId || recommendersLoading) return;
      if (!reset && !recommendersHasMore) return;

      if (reset) {
        recommendersOffset = 0;
        recommendersHasMore = true;
        if (recommendersList) recommendersList.innerHTML = "";
      }

      recommendersLoading = true;
      setRecommendersLoading(true);
      try {
        const from = recommendersOffset;
        const to = recommendersOffset + RECOMMENDERS_PAGE_SIZE - 1;
        const { data, error } = await supabase
          .from("recommendations")
          .select("id,author_id,created_at")
          .eq("user_id", recommendersTargetUserId)
          .order("created_at", { ascending: false })
          .range(from, to);
        if (error) throw error;

        const rows = data || [];
        if (reset && rows.length === 0) {
          renderRecommendersEmpty(true);
          recommendersHasMore = false;
          return;
        }

        renderRecommendersEmpty(false);
        recommendersOffset += rows.length;
        if (rows.length < RECOMMENDERS_PAGE_SIZE) {
          recommendersHasMore = false;
        }

        const authorIds = Array.from(new Set(rows.map((row) => row.author_id).filter(Boolean)));
        let usersMap = new Map();
        if (authorIds.length > 0) {
          const { data: usersData, error: usersError } = await supabase
            .from("users")
            .select("id,first_name,last_name,avatar_url")
            .in("id", authorIds);
          if (usersError) throw usersError;
          usersMap = new Map((usersData || []).map((user) => [user.id, user]));
        }

        rows.forEach((row) => {
          appendRecommenderItem(row, usersMap.get(row.author_id));
        });
      } catch (err) {
        console.error(err);
      } finally {
        recommendersLoading = false;
        setRecommendersLoading(false);
      }
    }

    async function convertImageToWebp(file) {
      if (!file?.type || !file.type.startsWith("image/")) {
        throw new Error("Selecione apenas imagens válidas nos anexos.");
      }
      if (file.size > REPORT_MAX_FILE_BYTES) {
        throw new Error("Cada imagem anexa deve ter no máximo 6MB.");
      }
      const bitmap = await createImageBitmap(file);
      const maxSide = Math.max(bitmap.width, bitmap.height);
      const scale = Math.min(1, REPORT_MAX_DIMENSION / maxSide);
      const canvas = document.createElement("canvas");
      canvas.width = Math.max(1, Math.round(bitmap.width * scale));
      canvas.height = Math.max(1, Math.round(bitmap.height * scale));
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("Falha ao processar imagem anexa.");
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/webp", REPORT_WEBP_QUALITY));
      if (!blob) throw new Error("Falha ao converter anexo para WebP.");
      const baseName = file.name.replace(/\.[^.]+$/, "") || "report";
      return new File([blob], `${baseName}.webp`, { type: "image/webp" });
    }

    async function requestReportSignedUpload(file) {
      ensureClient();
      const { data } = await supabase.auth.getSession();
      const token = data.session?.access_token;
      if (!token) throw new Error("Sessão expirada. Faça login novamente.");

      const extension = (file.name.split(".").pop() || "").toLowerCase();
      const response = await fetch(`${SUPABASE_URL}/functions/v1/r2_sign_upload`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          apikey: SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({
          contentType: file.type || "application/octet-stream",
          extension,
          userToken: token,
          assetType: "report",
        }),
      });
      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.error || "Erro ao solicitar upload de anexo.");
      }
      return response.json();
    }

    async function uploadReportEvidence(files, onProgress) {
      const uploaded = [];
      for (let index = 0; index < files.length; index += 1) {
        const webp = await convertImageToWebp(files[index]);
        const signed = await requestReportSignedUpload(webp);
        const uploadRes = await fetch(signed.uploadUrl, {
          method: "PUT",
          headers: {
            "Content-Type": webp.type || "application/octet-stream",
          },
          body: webp,
        });
        if (!uploadRes.ok) throw new Error("Falha ao enviar anexo da denúncia.");
        uploaded.push(signed.publicUrl);
        if (typeof onProgress === "function") onProgress(index + 1, files.length);
      }
      return uploaded.filter(Boolean);
    }

    async function setAvatarImage(src) {
      if (!avatarImg) return;
      const finalSrc = src || "img/avatar.svg";
      avatarImg.src = finalSrc;
      try {
        await avatarImg.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          avatarImg.src = "img/avatar.svg";
          try {
            await avatarImg.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      } finally {
        markAvatarReady();
      }
    }

    async function loadUserAvatar() {
      if (!avatarImg || !currentUser || avatarLoaded) return;
      try {
        ensureClient();
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatar);
        } catch (_innerErr) {
          await setAvatarImage("img/avatar.svg");
        }
      } finally {
        avatarLoaded = true;
      }
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
      }
    }

    function formatCategory(category) {
      return CATEGORY_LABELS[category] || "Anúncio";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getListingCategories(listing) {
      const raw = Array.isArray(listing?.categories) ? listing.categories : [];
      const normalized = raw
        .map((value) => String(value || "").trim())
        .filter(Boolean);
      if (normalized.length > 0) return normalized;
      if (listing?.category) return [String(listing.category)];
      return [];
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const parts = rest.split("/");
        if (parts.length === 0) return null;
        let bucket = parts[0];
        let pathParts = parts.slice(1);
        if (bucket === "public" || bucket === "authenticated" || bucket === "sign") {
          bucket = parts[1];
          pathParts = parts.slice(2);
        }
        if (!bucket || pathParts.length === 0) return null;
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    function normalizeR2PublicUrl(urlString) {
      try {
        const url = new URL(urlString);
        if (R2_PUBLIC_URL) {
          const publicHost = new URL(R2_PUBLIC_URL).host;
          if (url.hostname.endsWith(".r2.dev") && url.hostname !== publicHost) {
            return `${R2_PUBLIC_URL.replace(/\/$/, "")}${url.pathname}`;
          }
        }
        if (!url.hostname.endsWith(".r2.cloudflarestorage.com")) return urlString;
        const parts = url.pathname.split("/").filter(Boolean);
        if (parts.length === 0) return urlString;
        const accountId = url.hostname.split(".")[0];
        let bucket = R2_BUCKET;
        let keyParts = parts;
        if (bucket) {
          if (parts[0] === bucket) {
            keyParts = parts.slice(1);
          }
        } else {
          bucket = parts[0];
          keyParts = parts.slice(1);
        }
        if (!bucket || keyParts.length === 0) return urlString;
        const base = R2_PUBLIC_URL ? R2_PUBLIC_URL.replace(/\/$/, "") : `https://${bucket}.${accountId}.r2.dev`;
        return `${base}/${keyParts.join("/")}`;
      } catch (_err) {
        return urlString;
      }
    }

    async function resolveImageUrl(urlString) {
      if (!urlString) return urlString;
      const normalized = normalizeR2PublicUrl(urlString);
      if (!normalized.includes(SUPABASE_URL) || !normalized.includes("/storage/v1/object/")) {
        return normalized;
      }
      const parsed = parseStoragePath(normalized);
      if (!parsed) return normalized;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || normalized;
      } catch (err) {
        console.warn("Falha ao assinar imagem do anuncio", err);
        return normalized;
      }
    }

    async function resolveImageUrls(images) {
      const list = Array.isArray(images) ? images : [];
      const resolved = await Promise.all(list.map((url) => resolveImageUrl(url)));
      return resolved.filter(Boolean);
    }

    function ensureLightbox() {
      if (lightboxRoot) return lightboxRoot;
      lightboxRoot = document.createElement("div");
      lightboxRoot.className = "image-lightbox";
      lightboxRoot.innerHTML = `
        <div class="image-lightbox-frame">
          <button type="button" class="image-lightbox-btn image-lightbox-close" data-action="close" aria-label="Fechar">×</button>
          <img class="image-lightbox-img" alt="Imagem ampliada" />
          <div class="image-lightbox-controls">
            <button type="button" class="image-lightbox-btn" data-action="prev" aria-label="Anterior">‹</button>
            <span class="image-lightbox-count"></span>
            <button type="button" class="image-lightbox-btn" data-action="next" aria-label="Próxima">›</button>
          </div>
        </div>
      `;
      document.body.appendChild(lightboxRoot);
      lightboxRoot.addEventListener("click", (event) => {
        const action = event.target?.getAttribute("data-action");
        if (event.target === lightboxRoot || action === "close") {
          closeLightbox();
          return;
        }
        if (action === "prev") {
          lightboxIndex = Math.max(0, lightboxIndex - 1);
          renderLightbox();
          return;
        }
        if (action === "next") {
          lightboxIndex = Math.min(lightboxImages.length - 1, lightboxIndex + 1);
          renderLightbox();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (!lightboxRoot?.classList.contains("open")) return;
        if (event.key === "Escape") {
          closeLightbox();
          return;
        }
        if (event.key === "ArrowLeft") {
          lightboxIndex = Math.max(0, lightboxIndex - 1);
          renderLightbox();
          return;
        }
        if (event.key === "ArrowRight") {
          lightboxIndex = Math.min(lightboxImages.length - 1, lightboxIndex + 1);
          renderLightbox();
        }
      });
      return lightboxRoot;
    }

    function renderLightbox() {
      if (!lightboxRoot) return;
      const imageEl = lightboxRoot.querySelector(".image-lightbox-img");
      const countEl = lightboxRoot.querySelector(".image-lightbox-count");
      const prevBtn = lightboxRoot.querySelector('[data-action="prev"]');
      const nextBtn = lightboxRoot.querySelector('[data-action="next"]');
      const hasMany = lightboxImages.length > 1;
      imageEl.src = lightboxImages[lightboxIndex] || "";
      countEl.textContent = `${lightboxIndex + 1}/${Math.max(1, lightboxImages.length)}`;
      prevBtn.disabled = !hasMany || lightboxIndex <= 0;
      nextBtn.disabled = !hasMany || lightboxIndex >= lightboxImages.length - 1;
    }

    function openLightbox(images, index = 0) {
      if (!Array.isArray(images) || images.length === 0) return;
      ensureLightbox();
      lightboxImages = images.slice();
      lightboxIndex = Math.min(Math.max(index, 0), lightboxImages.length - 1);
      renderLightbox();
      lightboxRoot.classList.add("open");
      document.body.classList.add("no-scroll");
    }

    function closeLightbox() {
      if (!lightboxRoot) return;
      lightboxRoot.classList.remove("open");
      document.body.classList.remove("no-scroll");
    }

    function setNotFound(message) {
      titleEl.textContent = message || "Anúncio não encontrado.";
      descriptionEl.textContent = "Este anúncio foi excluído ou não está mais disponível.";
      currentGalleryImages = [];
      currentListing = null;
      recommendersTargetUserId = null;
      recommendersFetched = false;
      closeRecommendersModal();
      if (telegramChat) telegramChat.style.display = "none";
      if (whatsappChat) whatsappChat.style.display = "none";
      if (contactActionsRow) contactActionsRow.style.display = "none";
      if (sellerProfileLink) sellerProfileLink.style.display = "none";
      if (sellerDiscord) sellerDiscord.style.display = "none";
      if (sellerRecommendations) sellerRecommendations.style.display = "none";
      if (reportListingBtn) reportListingBtn.style.display = "none";
      if (reportListingCard) reportListingCard.style.display = "none";
      if (reportListingForm) reportListingForm.style.display = "none";
      if (metaEl) metaEl.innerHTML = "";
      if (mainMedia) mainMedia.textContent = "Anúncio indisponível.";
      if (thumbGrid) {
        thumbGrid.innerHTML = "";
        thumbGrid.style.display = "none";
      }
    }

    function isMissingListingError(error) {
      if (!error) return false;
      const code = String(error.code || "").toUpperCase();
      const message = String(error.message || "").toLowerCase();
      return (
        code === "PGRST116" ||
        message.includes("cannot coerce the result to a single json object") ||
        message.includes("no rows")
      );
    }

    function renderGallery(images) {
      if (!mainMedia || !thumbGrid) return;
      const list = Array.isArray(images) ? images.filter(Boolean) : [];
      currentGalleryImages = list.slice();
      if (list.length === 0) {
        mainMedia.textContent = "Sem imagem";
        thumbGrid.innerHTML = "";
        thumbGrid.style.display = "none";
        return;
      }

      const items = list.map((src, index) => ({ src, index }));
      let mainItem = items[0];
      let thumbItems = items.slice(1);

      function renderState() {
        const mainUrl = encodeURI(mainItem.src);
        mainMedia.innerHTML = `<img src="${mainUrl}" alt="Imagem principal do anúncio" loading="lazy" data-image-index="${mainItem.index}" style="width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain;object-position:center center;display:block;background:#ffffff;" />`;

        thumbGrid.innerHTML = "";
        if (thumbItems.length === 0) {
          thumbGrid.style.display = "none";
          return;
        }
        thumbGrid.style.display = "grid";

        thumbItems.forEach((item, thumbIndex) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "listing-thumb";
          const thumbUrl = encodeURI(item.src);
          button.innerHTML = `<img src="${thumbUrl}" alt="Miniatura ${thumbIndex + 1}" loading="lazy" />`;
          button.addEventListener("click", () => {
            const previousMain = mainItem;
            mainItem = item;
            thumbItems[thumbIndex] = previousMain;
            renderState();
          });
          thumbGrid.appendChild(button);
        });
      }

      renderState();
    }

    function renderListing(listing) {
      if (!listing) {
        setNotFound();
        return;
      }
      currentListing = listing;
      const firstName = (listing.user_first_name || "").trim();
      const lastName = (listing.user_last_name || "").trim();
      const fullName = `${firstName} ${lastName}`.trim() || "Anunciante";
      const displayFirstName = firstName || "anunciante";
      const discordUsername = String(listing.user_discord_username || "").trim();

      titleEl.textContent = listing.title;
      descriptionEl.textContent = listing.description || "Sem descrição informada.";

      if (metaEl) {
        const categoriesHtml = getListingCategories(listing)
          .map((category) => `<span class="pill">${formatCategory(category)}</span>`)
          .join("");
        metaEl.innerHTML = categoriesHtml || '<span class="pill">Sem categoria</span>';
      }

      if (sellerProfileLink) {
        if (listing.user_profile_id) {
          sellerProfileLink.href = `user.html?id=${encodeURIComponent(listing.user_profile_id)}`;
          sellerProfileLink.innerHTML = "";
          const avatar = document.createElement("img");
          avatar.className = "seller-profile-avatar";
          avatar.src = listing.user_avatar_url || "img/avatar.svg";
          avatar.alt = `Avatar de ${fullName}`;
          avatar.referrerPolicy = "no-referrer";
          avatar.loading = "lazy";
          avatar.addEventListener("error", () => {
            avatar.src = "img/avatar.svg";
          });
          const name = document.createElement("span");
          name.textContent = fullName;
          sellerProfileLink.appendChild(avatar);
          sellerProfileLink.appendChild(name);
          sellerProfileLink.style.display = "inline-flex";
        } else {
          sellerProfileLink.style.display = "none";
        }
      }

      if (sellerDiscord) {
        if (discordUsername) {
          sellerDiscord.innerHTML = "";
          const icon = document.createElement("img");
          icon.src = "img/discord.svg";
          icon.alt = "";
          icon.className = "seller-discord-icon";
          const name = document.createElement("span");
          name.textContent = discordUsername;
          sellerDiscord.appendChild(icon);
          sellerDiscord.appendChild(name);
          sellerDiscord.style.display = "inline-flex";
        } else {
          sellerDiscord.style.display = "none";
        }
      }

      if (sellerRecommendations) {
        const totalRecommendations = Number(listing.user_recommendations_count || 0);
        const label = totalRecommendations === 1
          ? "1 recomendação"
          : `${totalRecommendations} recomendações`;
        sellerRecommendations.innerHTML = `<img src="img/rec.png" alt="" /> ${escapeHtml(label)}`;
        sellerRecommendations.style.display = listing.user_profile_id ? "inline-flex" : "none";
        sellerRecommendations.setAttribute("aria-expanded", "false");
      }
      recommendersTargetUserId = listing.user_profile_id || null;
      recommendersFetched = false;

      if (telegramChat) {
        if (listing.user_phone) {
          const phone = String(listing.user_phone).replace(/\D/g, "");
          telegramChat.href = `https://t.me/+${phone}`;
          telegramChat.innerHTML = `Conversar com ${escapeHtml(displayFirstName)} no telegram <img src="img/telegram.webp" alt="" class="btn-icon" />`;
          telegramChat.style.display = "inline-flex";
        } else {
          telegramChat.style.display = "none";
        }
      }

      if (whatsappChat) {
        const digits = listing.user_phone ? String(listing.user_phone).replace(/\D/g, "") : "";
        if (listing.user_show_whatsapp && digits) {
          whatsappChat.href = `https://wa.me/${digits}`;
          whatsappChat.innerHTML = `Conversar com ${escapeHtml(displayFirstName)} no whatsapp <img src="img/wtsp.png" alt="" class="btn-icon" />`;
          whatsappChat.style.display = "inline-flex";
        } else {
          whatsappChat.style.display = "none";
        }
      }
      if (contactActionsRow) {
        const hasVisibleContact =
          (telegramChat && telegramChat.style.display !== "none") ||
          (whatsappChat && whatsappChat.style.display !== "none");
        contactActionsRow.style.display = hasVisibleContact ? "flex" : "none";
      }

      const ownListing = !!currentUser && !!listing.user_profile_id && currentUser.id === listing.user_profile_id;
      if (reportListingCard) {
        reportListingCard.style.display = ownListing ? "none" : "block";
      }
      if (reportListingBtn) {
        reportListingBtn.style.display = ownListing ? "none" : "inline-flex";
      }
      if (reportListingForm) {
        reportListingForm.style.display = "none";
      }
      if (reportListingReason) {
        reportListingReason.value = "";
      }
      if (reportListingFeedback) {
        reportListingFeedback.textContent = "";
      }
      if (reportListingFiles) reportListingFiles.value = "";
      updateReportFilesInfo();

      renderGallery(listing.images);
    }

    async function fetchRecommendationsCount(userId) {
      if (!userId) return 0;
      try {
        ensureClient();
        const { count, error } = await supabase
          .from("recommendations")
          .select("id", { count: "exact", head: true })
          .eq("user_id", userId);
        if (error) throw error;
        return count || 0;
      } catch (err) {
        console.warn("Falha ao carregar recomendações do anunciante.", err);
        return 0;
      }
    }

    async function fetchListing(listingId) {
      try {
        ensureClient();
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,category,categories,status,server_id,created_at,user_id,users(id,phone,show_whatsapp_button,first_name,last_name,avatar_url,discord_username)")
          .eq("id", listingId)
          .single();
        if (error) {
          if (isMissingListingError(error)) {
            return { listing: null };
          }
          throw error;
        }
        if (data?.images) {
          data.images = await resolveImageUrls(data.images);
        }
        const resolvedAvatarUrl = data?.users?.avatar_url
          ? await resolveImageUrl(data.users.avatar_url)
          : "";
        const phone = data?.users?.phone || null;
        const userShowWhatsapp = !!data?.users?.show_whatsapp_button;
        const userFirstName = data?.users?.first_name || "anunciante";
        const userLastName = data?.users?.last_name || "";
        const userAvatarUrl = resolvedAvatarUrl || "";
        const userDiscordUsername = data?.users?.discord_username || "";
        const userProfileId = data?.users?.id || data?.user_id || null;
        const userRecommendationsCount = await fetchRecommendationsCount(userProfileId);
        return {
          listing: {
            ...data,
            user_phone: phone,
            user_show_whatsapp: userShowWhatsapp,
            user_first_name: userFirstName,
            user_last_name: userLastName,
            user_avatar_url: userAvatarUrl,
            user_discord_username: userDiscordUsername,
            user_profile_id: userProfileId,
            user_recommendations_count: userRecommendationsCount,
          },
        };
      } catch (err) {
        console.warn("Falha ao buscar anuncio com join, tentando separado.", err);
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,category,categories,status,server_id,created_at,user_id")
          .eq("id", listingId)
          .single();
        if (error) {
          if (isMissingListingError(error)) {
            return { listing: null };
          }
          throw error;
        }
        if (data?.images) {
          data.images = await resolveImageUrls(data.images);
        }
        let userPhone = null;
        let userShowWhatsapp = false;
        let userFirstName = "anunciante";
        let userLastName = "";
        let userAvatarUrl = "";
        let userDiscordUsername = "";
        let userProfileId = data?.user_id || null;
        if (data?.user_id) {
          const { data: userData } = await supabase
            .from("users")
            .select("id,phone,show_whatsapp_button,first_name,last_name,avatar_url,discord_username")
            .eq("id", data.user_id)
            .single();
          userProfileId = userData?.id || userProfileId;
          userPhone = userData?.phone || null;
          userShowWhatsapp = !!userData?.show_whatsapp_button;
          userFirstName = userData?.first_name || "anunciante";
          userLastName = userData?.last_name || "";
          userAvatarUrl = userData?.avatar_url
            ? await resolveImageUrl(userData.avatar_url)
            : "";
          userDiscordUsername = userData?.discord_username || "";
        }
        const userRecommendationsCount = await fetchRecommendationsCount(userProfileId);
        return {
          listing: {
            ...data,
            user_phone: userPhone,
            user_show_whatsapp: userShowWhatsapp,
            user_first_name: userFirstName,
            user_last_name: userLastName,
            user_avatar_url: userAvatarUrl,
            user_discord_username: userDiscordUsername || "",
            user_profile_id: userProfileId,
            user_recommendations_count: userRecommendationsCount,
          },
        };
      }
    }

    async function init() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();

        const params = new URLSearchParams(window.location.search);
        const listingId = params.get("id");
        if (!listingId) {
          setNotFound("Anúncio não encontrado.");
          return;
        }
        const result = await fetchListing(listingId);
        if (!result?.listing) {
          setNotFound("Este anúncio foi excluído.");
          return;
        }
        renderListing(result.listing);
      } catch (err) {
        console.error(err);
        if (isMissingListingError(err)) {
          setNotFound("Este anúncio foi excluído.");
          return;
        }
        setNotFound("Este anúncio foi excluído ou não está disponível.");
      }
    }

    authBtn?.addEventListener("click", handleAuthClick);
    reportListingBtn?.addEventListener("click", () => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      hideReportSuccess();
      if (!currentListing) return;
      if (currentListing.user_profile_id && currentUser.id === currentListing.user_profile_id) {
        if (reportListingFeedback) reportListingFeedback.textContent = "Você não pode denunciar seu próprio anúncio.";
        return;
      }
      if (reportListingForm) {
        const showing = reportListingForm.style.display !== "none";
        reportListingForm.style.display = showing ? "none" : "grid";
        if (!showing && reportListingReason) {
          reportListingReason.focus();
        }
      }
    });
    reportListingCancel?.addEventListener("click", () => {
      if (reportListingForm) reportListingForm.style.display = "none";
      if (reportListingReason) reportListingReason.value = "";
      if (reportListingFeedback) reportListingFeedback.textContent = "";
      if (reportListingFiles) reportListingFiles.value = "";
      updateReportFilesInfo();
    });
    sellerRecommendations?.addEventListener("click", async () => {
      try {
        if (!recommendersTargetUserId) return;
        openRecommendersModal();
        if (!recommendersFetched) {
          recommendersFetched = true;
          await loadMoreRecommenders({ reset: true });
        }
        const shouldShowEmpty = !!recommendersFetched && !recommendersHasMore && (!recommendersList || recommendersList.childElementCount === 0);
        renderRecommendersEmpty(shouldShowEmpty);
      } catch (err) {
        console.error(err);
      }
    });
    reportListingFiles?.addEventListener("change", updateReportFilesInfo);
    reportListingSubmit?.addEventListener("click", async () => {
      try {
        if (!currentUser) {
          window.location.href = "login.html";
          return;
        }
        hideReportSuccess();
        if (!currentListing?.id) return;
        const reason = String(reportListingReason?.value || "").trim();
        if (reason.length < 10) {
          if (reportListingFeedback) reportListingFeedback.textContent = "Descreva o problema com pelo menos 10 caracteres.";
          return;
        }
        const files = getReportFiles();
        reportListingSubmit.disabled = true;
        if (reportListingFeedback) reportListingFeedback.textContent = "Enviando denúncia...";
        let evidenceImages = [];
        if (files.length > 0) {
          evidenceImages = await uploadReportEvidence(files, (done, total) => {
            if (reportListingFeedback) {
              reportListingFeedback.textContent = `Enviando anexos ${done}/${total}...`;
            }
          });
        }
        if (reportListingFeedback) reportListingFeedback.textContent = "Registrando denúncia...";
        ensureClient();
        const { error } = await supabase.from("reports").insert({
          reporter_id: currentUser.id,
          target_type: "listing",
          listing_id: currentListing.id,
          reason,
          evidence_images: evidenceImages,
        });
        if (error) {
          if (error.code === "23505") {
            throw new Error("Você já possui uma denúncia pendente para este anúncio.");
          }
          throw error;
        }
        if (reportListingFeedback) reportListingFeedback.textContent = "Denúncia enviada para análise.";
        showReportSuccess("Sua denúncia foi enviada com sucesso. Nossa equipe vai analisar o caso.");
        if (reportListingReason) reportListingReason.value = "";
        if (reportListingFiles) reportListingFiles.value = "";
        updateReportFilesInfo();
        if (reportListingForm) reportListingForm.style.display = "none";
      } catch (err) {
        console.error(err);
        if (reportListingFeedback) {
          reportListingFeedback.textContent = err?.message || "Erro ao enviar denúncia.";
        }
      } finally {
        if (reportListingSubmit) reportListingSubmit.disabled = false;
      }
    });
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    recommendersWrap?.addEventListener("scroll", () => {
      if (!recommendersWrap || recommendersLoading || !recommendersHasMore) return;
      const threshold = 24;
      const reachedBottom = recommendersWrap.scrollTop + recommendersWrap.clientHeight >= recommendersWrap.scrollHeight - threshold;
      if (reachedBottom) {
        loadMoreRecommenders();
      }
    });
    recommendersModalClose?.addEventListener("click", closeRecommendersModal);
    recommendersModal?.addEventListener("click", (event) => {
      if (event.target === recommendersModal) {
        closeRecommendersModal();
      }
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && recommendersModal?.classList.contains("open")) {
        closeRecommendersModal();
      }
    });
    mainMedia?.addEventListener("click", (event) => {
      const image = event.target.closest("img");
      if (!image || currentGalleryImages.length === 0) return;
      const imageIndex = Number(image.getAttribute("data-image-index") || "0");
      openLightbox(currentGalleryImages, imageIndex);
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
      }
    });
    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "listing-create.html";
    }
    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });

    init();
  </script>
</body>
</html>
