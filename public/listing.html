<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gimerr - Anúncio</title>
  <link rel="stylesheet" href="css/global.css" />
  <style>
    .seller-profile-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--ink);
      text-decoration: none;
      font-weight: 700;
    }

    .seller-profile-link:hover {
      text-decoration: underline;
    }

    .seller-profile-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: #fff;
      display: block;
    }

    .seller-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .seller-discord {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      word-break: break-word;
    }

    .seller-discord-icon {
      width: 14px;
      height: 14px;
      object-fit: contain;
      display: block;
    }
  </style>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <header class="site-nav">
      <a href="index.html" class="brand">
        <img src="img/logo.png" alt="Gimerr" class="brand-logo" />
        <div class="brand-copy">
          <span class="brand-tagline">Detalhes do anúncio</span>
        </div>
      </a>
      <div class="nav-actions">
        <button id="create-listing-btn" class="btn btn-ghost create-listing-btn" type="button" style="display:none;">Criar anúncio</button>
        <button id="auth-btn" class="btn btn-primary">Entrar com Google</button>
        <div id="user-menu" class="nav-user">
          <button id="avatar-btn" class="avatar-btn" type="button" aria-label="Abrir menu do usuário">
            <img id="avatar-img" class="avatar-img" src="img/avatar.svg" alt="Foto do usuário" />
          </button>
          <div class="user-dropdown">
            <button id="menu-create-listing" class="menu-item create-listing-menu" type="button">Criar anúncio</button>
            <a id="my-listings-link" class="menu-item" href="my-listings.html">Meus anúncios</a>
            <a id="profile-link" class="menu-item" href="profile.html">Meu perfil</a>
            <button id="logout-btn" class="menu-item" type="button">Sair</button>
          </div>
        </div>
      </div>
    </header>

    <main class="section listing-page">
      <div class="listing-hero-card">
        <div class="listing-hero-copy">
          <h1 id="listing-title">Carregando...</h1>
          <div class="seller-meta-row">
            <a id="seller-profile-link" class="seller-profile-link" href="#" style="display:none;"></a>
            <span id="seller-discord" class="seller-discord" style="display:none;"></span>
          </div>
          <div id="listing-meta" class="pill-trail"></div>
        </div>
        <div class="listing-gallery">
          <div id="listing-main" class="listing-gallery-main">Sem imagem</div>
          <div id="listing-thumbs" class="listing-thumb-grid"></div>
        </div>
      </div>

      <div class="inline-actions listing-contact-actions">
        <a id="telegram-chat" class="btn btn-telegram btn-contact-cta" href="#" target="_blank" rel="noopener" style="display:none;">
          Conversar no Telegram
          <img src="img/telegram.webp" alt="" class="btn-icon" />
        </a>
        <a id="whatsapp-chat" class="btn btn-whatsapp btn-contact-cta" href="#" target="_blank" rel="noopener" style="display:none;">
          Conversar no WhatsApp
          <img src="img/wtsp.png" alt="" class="btn-icon" />
        </a>
      </div>

      <section class="hero-card">
        <h3>Descrição do anúncio</h3>
        <p id="listing-description" class="listing-description-preserve">Carregando descrição...</p>
      </section>
    </main>
  </div>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
    const R2_PUBLIC_URL = env.R2_PUBLIC_URL || "";
    const R2_BUCKET = env.R2_BUCKET || "";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const createListingBtn = document.getElementById("create-listing-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const titleEl = document.getElementById("listing-title");
    const sellerProfileLink = document.getElementById("seller-profile-link");
    const sellerDiscord = document.getElementById("seller-discord");
    const descriptionEl = document.getElementById("listing-description");
    const metaEl = document.getElementById("listing-meta");
    const telegramChat = document.getElementById("telegram-chat");
    const whatsappChat = document.getElementById("whatsapp-chat");
    const mainMedia = document.getElementById("listing-main");
    const thumbGrid = document.getElementById("listing-thumbs");

    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let avatarReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !avatarReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });

    let supabase;
    let currentUser = null;
    let avatarLoaded = false;
    let currentGalleryImages = [];
    let lightboxImages = [];
    let lightboxIndex = 0;
    let lightboxRoot = null;
    if (avatarImg) avatarImg.referrerPolicy = "no-referrer";

    const CATEGORY_LABELS = {
      item: "Item ou itens",
      currency: "Moeda do game",
      account: "Conta ou personagem",
      service: "Serviço",
      other: "Outro"
    };

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        titleEl.textContent = "Supabase não configurado.";
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        loadUserAvatar();
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        return;
      }
      authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      avatarLoaded = false;
      markAvatarReady();
    }

    async function setAvatarImage(src) {
      if (!avatarImg) return;
      const finalSrc = src || "img/avatar.svg";
      avatarImg.src = finalSrc;
      try {
        await avatarImg.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          avatarImg.src = "img/avatar.svg";
          try {
            await avatarImg.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      } finally {
        markAvatarReady();
      }
    }

    async function loadUserAvatar() {
      if (!avatarImg || !currentUser || avatarLoaded) return;
      try {
        ensureClient();
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatar);
        } catch (_innerErr) {
          await setAvatarImage("img/avatar.svg");
        }
      } finally {
        avatarLoaded = true;
      }
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
      }
    }

    function formatCategory(category) {
      return CATEGORY_LABELS[category] || "Anúncio";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getListingCategories(listing) {
      const raw = Array.isArray(listing?.categories) ? listing.categories : [];
      const normalized = raw
        .map((value) => String(value || "").trim())
        .filter(Boolean);
      if (normalized.length > 0) return normalized;
      if (listing?.category) return [String(listing.category)];
      return [];
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const parts = rest.split("/");
        if (parts.length === 0) return null;
        let bucket = parts[0];
        let pathParts = parts.slice(1);
        if (bucket === "public" || bucket === "authenticated" || bucket === "sign") {
          bucket = parts[1];
          pathParts = parts.slice(2);
        }
        if (!bucket || pathParts.length === 0) return null;
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    function normalizeR2PublicUrl(urlString) {
      try {
        const url = new URL(urlString);
        if (R2_PUBLIC_URL) {
          const publicHost = new URL(R2_PUBLIC_URL).host;
          if (url.hostname.endsWith(".r2.dev") && url.hostname !== publicHost) {
            return `${R2_PUBLIC_URL.replace(/\/$/, "")}${url.pathname}`;
          }
        }
        if (!url.hostname.endsWith(".r2.cloudflarestorage.com")) return urlString;
        const parts = url.pathname.split("/").filter(Boolean);
        if (parts.length === 0) return urlString;
        const accountId = url.hostname.split(".")[0];
        let bucket = R2_BUCKET;
        let keyParts = parts;
        if (bucket) {
          if (parts[0] === bucket) {
            keyParts = parts.slice(1);
          }
        } else {
          bucket = parts[0];
          keyParts = parts.slice(1);
        }
        if (!bucket || keyParts.length === 0) return urlString;
        const base = R2_PUBLIC_URL ? R2_PUBLIC_URL.replace(/\/$/, "") : `https://${bucket}.${accountId}.r2.dev`;
        return `${base}/${keyParts.join("/")}`;
      } catch (_err) {
        return urlString;
      }
    }

    async function resolveImageUrl(urlString) {
      if (!urlString) return urlString;
      const normalized = normalizeR2PublicUrl(urlString);
      if (!normalized.includes(SUPABASE_URL) || !normalized.includes("/storage/v1/object/")) {
        return normalized;
      }
      const parsed = parseStoragePath(normalized);
      if (!parsed) return normalized;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || normalized;
      } catch (err) {
        console.warn("Falha ao assinar imagem do anuncio", err);
        return normalized;
      }
    }

    async function resolveImageUrls(images) {
      const list = Array.isArray(images) ? images : [];
      const resolved = await Promise.all(list.map((url) => resolveImageUrl(url)));
      return resolved.filter(Boolean);
    }

    function ensureLightbox() {
      if (lightboxRoot) return lightboxRoot;
      lightboxRoot = document.createElement("div");
      lightboxRoot.className = "image-lightbox";
      lightboxRoot.innerHTML = `
        <div class="image-lightbox-frame">
          <button type="button" class="image-lightbox-btn image-lightbox-close" data-action="close" aria-label="Fechar">×</button>
          <img class="image-lightbox-img" alt="Imagem ampliada" />
          <div class="image-lightbox-controls">
            <button type="button" class="image-lightbox-btn" data-action="prev" aria-label="Anterior">‹</button>
            <span class="image-lightbox-count"></span>
            <button type="button" class="image-lightbox-btn" data-action="next" aria-label="Próxima">›</button>
          </div>
        </div>
      `;
      document.body.appendChild(lightboxRoot);
      lightboxRoot.addEventListener("click", (event) => {
        const action = event.target?.getAttribute("data-action");
        if (event.target === lightboxRoot || action === "close") {
          closeLightbox();
          return;
        }
        if (action === "prev") {
          lightboxIndex = Math.max(0, lightboxIndex - 1);
          renderLightbox();
          return;
        }
        if (action === "next") {
          lightboxIndex = Math.min(lightboxImages.length - 1, lightboxIndex + 1);
          renderLightbox();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (!lightboxRoot?.classList.contains("open")) return;
        if (event.key === "Escape") {
          closeLightbox();
          return;
        }
        if (event.key === "ArrowLeft") {
          lightboxIndex = Math.max(0, lightboxIndex - 1);
          renderLightbox();
          return;
        }
        if (event.key === "ArrowRight") {
          lightboxIndex = Math.min(lightboxImages.length - 1, lightboxIndex + 1);
          renderLightbox();
        }
      });
      return lightboxRoot;
    }

    function renderLightbox() {
      if (!lightboxRoot) return;
      const imageEl = lightboxRoot.querySelector(".image-lightbox-img");
      const countEl = lightboxRoot.querySelector(".image-lightbox-count");
      const prevBtn = lightboxRoot.querySelector('[data-action="prev"]');
      const nextBtn = lightboxRoot.querySelector('[data-action="next"]');
      const hasMany = lightboxImages.length > 1;
      imageEl.src = lightboxImages[lightboxIndex] || "";
      countEl.textContent = `${lightboxIndex + 1}/${Math.max(1, lightboxImages.length)}`;
      prevBtn.disabled = !hasMany || lightboxIndex <= 0;
      nextBtn.disabled = !hasMany || lightboxIndex >= lightboxImages.length - 1;
    }

    function openLightbox(images, index = 0) {
      if (!Array.isArray(images) || images.length === 0) return;
      ensureLightbox();
      lightboxImages = images.slice();
      lightboxIndex = Math.min(Math.max(index, 0), lightboxImages.length - 1);
      renderLightbox();
      lightboxRoot.classList.add("open");
      document.body.classList.add("no-scroll");
    }

    function closeLightbox() {
      if (!lightboxRoot) return;
      lightboxRoot.classList.remove("open");
      document.body.classList.remove("no-scroll");
    }

    function setNotFound(message) {
      titleEl.textContent = message || "Anúncio não encontrado.";
      descriptionEl.textContent = "Sem dados para exibir.";
      currentGalleryImages = [];
      if (telegramChat) telegramChat.style.display = "none";
      if (whatsappChat) whatsappChat.style.display = "none";
      if (sellerProfileLink) sellerProfileLink.style.display = "none";
      if (sellerDiscord) sellerDiscord.style.display = "none";
      if (metaEl) metaEl.innerHTML = "";
      if (mainMedia) mainMedia.textContent = "Sem imagem";
      if (thumbGrid) {
        thumbGrid.innerHTML = "";
        thumbGrid.style.display = "none";
      }
    }

    function renderGallery(images) {
      if (!mainMedia || !thumbGrid) return;
      const list = Array.isArray(images) ? images.filter(Boolean) : [];
      currentGalleryImages = list.slice();
      if (list.length === 0) {
        mainMedia.textContent = "Sem imagem";
        thumbGrid.innerHTML = "";
        thumbGrid.style.display = "none";
        return;
      }

      const items = list.map((src, index) => ({ src, index }));
      let mainItem = items[0];
      let thumbItems = items.slice(1);

      function renderState() {
        const mainUrl = encodeURI(mainItem.src);
        mainMedia.innerHTML = `<img src="${mainUrl}" alt="Imagem principal do anúncio" loading="lazy" data-image-index="${mainItem.index}" style="width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain;object-position:center center;display:block;background:#ffffff;" />`;

        thumbGrid.innerHTML = "";
        if (thumbItems.length === 0) {
          thumbGrid.style.display = "none";
          return;
        }
        thumbGrid.style.display = "grid";

        thumbItems.forEach((item, thumbIndex) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "listing-thumb";
          const thumbUrl = encodeURI(item.src);
          button.innerHTML = `<img src="${thumbUrl}" alt="Miniatura ${thumbIndex + 1}" loading="lazy" />`;
          button.addEventListener("click", () => {
            const previousMain = mainItem;
            mainItem = item;
            thumbItems[thumbIndex] = previousMain;
            renderState();
          });
          thumbGrid.appendChild(button);
        });
      }

      renderState();
    }

    function renderListing(listing) {
      if (!listing) {
        setNotFound();
        return;
      }
      const firstName = (listing.user_first_name || "").trim();
      const lastName = (listing.user_last_name || "").trim();
      const fullName = `${firstName} ${lastName}`.trim() || "Anunciante";
      const displayFirstName = firstName || "anunciante";
      const discordUsername = String(listing.user_discord_username || "").trim();

      titleEl.textContent = listing.title;
      descriptionEl.textContent = listing.description || "Sem descrição informada.";

      if (metaEl) {
        const categoriesHtml = getListingCategories(listing)
          .map((category) => `<span class="pill">${formatCategory(category)}</span>`)
          .join("");
        metaEl.innerHTML = categoriesHtml || '<span class="pill">Sem categoria</span>';
      }

      if (sellerProfileLink) {
        if (listing.user_profile_id) {
          sellerProfileLink.href = `user.html?id=${encodeURIComponent(listing.user_profile_id)}`;
          sellerProfileLink.innerHTML = "";
          const avatar = document.createElement("img");
          avatar.className = "seller-profile-avatar";
          avatar.src = listing.user_avatar_url || "img/avatar.svg";
          avatar.alt = `Avatar de ${fullName}`;
          avatar.referrerPolicy = "no-referrer";
          avatar.loading = "lazy";
          avatar.addEventListener("error", () => {
            avatar.src = "img/avatar.svg";
          });
          const name = document.createElement("span");
          name.textContent = fullName;
          sellerProfileLink.appendChild(avatar);
          sellerProfileLink.appendChild(name);
          sellerProfileLink.style.display = "inline-flex";
        } else {
          sellerProfileLink.style.display = "none";
        }
      }

      if (sellerDiscord) {
        if (discordUsername) {
          sellerDiscord.innerHTML = "";
          const icon = document.createElement("img");
          icon.src = "img/discord.svg";
          icon.alt = "";
          icon.className = "seller-discord-icon";
          const name = document.createElement("span");
          name.textContent = discordUsername;
          sellerDiscord.appendChild(icon);
          sellerDiscord.appendChild(name);
          sellerDiscord.style.display = "inline-flex";
        } else {
          sellerDiscord.style.display = "none";
        }
      }

      if (telegramChat) {
        if (listing.user_phone) {
          const phone = String(listing.user_phone).replace(/\D/g, "");
          telegramChat.href = `https://t.me/+${phone}`;
          telegramChat.innerHTML = `Conversar com ${escapeHtml(displayFirstName)} no telegram <img src="img/telegram.webp" alt="" class="btn-icon" />`;
          telegramChat.style.display = "inline-flex";
        } else {
          telegramChat.style.display = "none";
        }
      }

      if (whatsappChat) {
        const digits = listing.user_phone ? String(listing.user_phone).replace(/\D/g, "") : "";
        if (listing.user_show_whatsapp && digits) {
          whatsappChat.href = `https://wa.me/${digits}`;
          whatsappChat.innerHTML = `Conversar com ${escapeHtml(displayFirstName)} no whatsapp <img src="img/wtsp.png" alt="" class="btn-icon" />`;
          whatsappChat.style.display = "inline-flex";
        } else {
          whatsappChat.style.display = "none";
        }
      }

      renderGallery(listing.images);
    }

    async function fetchListing(listingId) {
      try {
        ensureClient();
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,category,categories,status,server_id,created_at,user_id,users(id,phone,show_whatsapp_button,first_name,last_name,avatar_url,discord_username)")
          .eq("id", listingId)
          .single();
        if (error) throw error;
        if (data?.images) {
          data.images = await resolveImageUrls(data.images);
        }
        const resolvedAvatarUrl = data?.users?.avatar_url
          ? await resolveImageUrl(data.users.avatar_url)
          : "";
        const phone = data?.users?.phone || null;
        const userShowWhatsapp = !!data?.users?.show_whatsapp_button;
        const userFirstName = data?.users?.first_name || "anunciante";
        const userLastName = data?.users?.last_name || "";
        const userAvatarUrl = resolvedAvatarUrl || "";
        const userDiscordUsername = data?.users?.discord_username || "";
        const userProfileId = data?.users?.id || data?.user_id || null;
        return {
          listing: {
            ...data,
            user_phone: phone,
            user_show_whatsapp: userShowWhatsapp,
            user_first_name: userFirstName,
            user_last_name: userLastName,
            user_avatar_url: userAvatarUrl,
            user_discord_username: userDiscordUsername,
            user_profile_id: userProfileId,
          },
        };
      } catch (err) {
        console.warn("Falha ao buscar anuncio com join, tentando separado.", err);
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,category,categories,status,server_id,created_at,user_id")
          .eq("id", listingId)
          .single();
        if (error) throw error;
        if (data?.images) {
          data.images = await resolveImageUrls(data.images);
        }
        let userPhone = null;
        let userShowWhatsapp = false;
        let userFirstName = "anunciante";
        let userLastName = "";
        let userAvatarUrl = "";
        let userDiscordUsername = "";
        let userProfileId = data?.user_id || null;
        if (data?.user_id) {
          const { data: userData } = await supabase
            .from("users")
            .select("id,phone,show_whatsapp_button,first_name,last_name,avatar_url,discord_username")
            .eq("id", data.user_id)
            .single();
          userProfileId = userData?.id || userProfileId;
          userPhone = userData?.phone || null;
          userShowWhatsapp = !!userData?.show_whatsapp_button;
          userFirstName = userData?.first_name || "anunciante";
          userLastName = userData?.last_name || "";
          userAvatarUrl = userData?.avatar_url
            ? await resolveImageUrl(userData.avatar_url)
            : "";
          userDiscordUsername = userData?.discord_username || "";
        }
        return {
          listing: {
            ...data,
            user_phone: userPhone,
            user_show_whatsapp: userShowWhatsapp,
            user_first_name: userFirstName,
            user_last_name: userLastName,
            user_avatar_url: userAvatarUrl,
            user_discord_username: userDiscordUsername || "",
            user_profile_id: userProfileId,
          },
        };
      }
    }

    async function init() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();

        const params = new URLSearchParams(window.location.search);
        const listingId = params.get("id");
        if (!listingId) {
          setNotFound("Anúncio não encontrado.");
          return;
        }
        const result = await fetchListing(listingId);
        renderListing(result.listing);
      } catch (err) {
        console.error(err);
        setNotFound(err?.message || "Erro ao carregar anúncio.");
      }
    }

    authBtn?.addEventListener("click", handleAuthClick);
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    mainMedia?.addEventListener("click", (event) => {
      const image = event.target.closest("img");
      if (!image || currentGalleryImages.length === 0) return;
      const imageIndex = Number(image.getAttribute("data-image-index") || "0");
      openLightbox(currentGalleryImages, imageIndex);
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
      }
    });
    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "listing-create.html";
    }
    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });

    init();
  </script>
</body>
</html>
