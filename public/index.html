<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gimerr - Marketplace gamer</title>
  <link rel="stylesheet" href="css/global.css" />
</head>
<body>
  <div class="page">
    <header class="site-nav">
      <a href="index.html" class="brand">
        <img src="img/logo.png" alt="Gimerr" class="brand-logo" />
        <div class="brand-copy">
          <span class="brand-tagline">Play to earn</span>
        </div>
      </a>
      <button id="auth-btn" class="btn btn-primary">Entrar com Google</button>
    </header>

    <main>
      <section class="hero">
        <video class="hero-video" autoplay muted loop playsinline>
          <source src="videos/bg.webm" type="video/webm" />
        </video>
        <div class="hero-overlay"></div>
        <div class="hero-grid single">
          <div class="hero-copy">
            <h1 style="font-size: 100px; text-align: center;">Play to Earn</h1>
            <h1>Encontre freelancers, itens e contas do seu game favorito à venda.</h1>
            <p class="lede">Cada game tem seu próprio marketplace operado 100% por players.</p>
            <form class="search" id="game-search">
              <div class="search-bar">
                <input id="game-search-input" class="search-input" type="search" placeholder="Pesquise aqui um game" aria-label="Pesquise aqui um game" autocomplete="off" />
                <button type="submit" class="btn btn-ghost">Buscar</button>
              </div>
              <div class="suggestions">
                <div id="search-suggestions" class="suggestions-panel" style="display:none;"></div>
              </div>
              <p id="search-feedback" class="search-feedback">Não encontrou um game que procurava? <a id="anchor-cadastro-game" class="link-ghost" href="#" data-action="game-submit">Clique aqui</a> para cadastrá-lo.</p>
            </form>
            <div class="inline-actions">
              <button id="create-listing-btn" class="btn btn-primary" type="button" style="display:none;">Criar anúncio</button>
            </div>

            <div class="pill-trail">
              <span class="pill">Itens</span>
              <span class="pill">Serviços</span>
              <span class="pill">Contas verificadas</span>
            </div>
          </div>
        </div>
      </section>

      <section class="section popular">
        <div class="section-header">
          <div>
            <span class="eyebrow">Primeira sessão</span>
            <h2>Games mais populares agora</h2>
            <p class="section-sub">Escolha um título e navegue no marketplace alimentado pela própria comunidade.</p>
          </div>
          <button class="btn btn-ghost" type="button" id="view-all-games">Ver todos os games</button>
        </div>
        <div id="games-grid" class="games-grid"></div>
        <p id="games-empty" class="search-feedback" style="display:none;">Nenhum game cadastrado ainda. Adicione o primeiro clicando no CTA acima.</p>
      </section>
    </main>
  </div>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const authBtn = document.getElementById("auth-btn");
    const searchForm = document.getElementById("game-search");
    const searchInput = document.getElementById("game-search-input");
    const searchFeedback = document.getElementById("search-feedback");
    const searchSuggestions = document.getElementById("search-suggestions");
    const gamesGrid = document.getElementById("games-grid");
    const gamesEmpty = document.getElementById("games-empty");
    const viewAllGamesBtn = document.getElementById("view-all-games");
    const createListingBtn = document.getElementById("create-listing-btn");

    let supabase;
    let currentUser = null;
    let games = [];

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        searchFeedback.textContent = "Configure SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js.";
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.textContent = "Sair";
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        return;
      }
      authBtn.textContent = "Entrar com Google";
      if (createListingBtn) createListingBtn.style.display = "none";
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        if (currentUser) {
          await supabase.auth.signOut();
          currentUser = null;
          updateAuthUI();
          return;
        }
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
        searchFeedback.textContent = err?.message || "Erro ao autenticar.";
        authBtn.disabled = false;
      }
    }

    async function bootstrapAuth() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
        searchFeedback.textContent = "Erro ao carregar sessão.";
      }
    }

    async function fetchGames() {
      try {
        ensureClient();
        // Primeiro tenta "servers", depois "games" como fallback silencioso.
        try {
          const servers = await loadGamesFromTable(
            "servers",
            (row) => ({
              id: row.id,
              name: row.name,
              description: row.description,
              cover_url: row.banner_url || row.cover_url,
              website: row.official_site,
              category: row.game_type || "Game",
            })
          );
          if (servers && servers.length > 0) {
            games = await enhanceCovers(servers);
            renderGames(games);
            return;
          }
        } catch (serverErr) {
          console.warn("Falha ao ler tabela servers, tentando games.", serverErr);
        }
        try {
          const primary = await loadGamesFromTable("games");
          games = await enhanceCovers(primary);
          renderGames(games);
        } catch (gameErr) {
          if (isMissingTableError(gameErr)) {
            games = [];
            renderGames(games);
            gamesEmpty.textContent = "Nenhum game cadastrado ainda.";
            return;
          }
          throw gameErr;
        }
      } catch (err) {
        console.error(err);
        gamesGrid.innerHTML = "";
        gamesEmpty.style.display = "block";
        gamesEmpty.textContent = err?.message || "Erro ao carregar games.";
      }
    }

    function isMissingTableError(err) {
      const message = err?.message || "";
      return message.includes("Could not find the table") || message.includes("schema cache");
    }

    async function loadGamesFromTable(table, mapFn) {
      const { data, error } = await supabase
        .from(table)
        .select("*")
        .order("name", { ascending: true });
      if (error) throw error;
      return (data || []).map(mapFn || ((row) => ({
        id: row.id,
        name: row.name,
        description: row.description,
        cover_url: row.banner_url || row.cover_url || row.image || row.image_url || row.photo,
        website: row.website || row.site || row.official_site,
        category: row.category || row.type || row.game_type || "Game",
      })));
    }

    async function enhanceCovers(list) {
      if (!list || list.length === 0) return [];
      return Promise.all(list.map(async (game) => {
        if (!game.cover_url) return game;
        const signed = await getSignedCoverUrl(game.cover_url);
        return { ...game, cover_url: signed || game.cover_url };
      }));
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/public/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const [bucket, ...pathParts] = rest.split("/");
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    async function getSignedCoverUrl(urlString) {
      const parsed = parseStoragePath(urlString);
      if (!parsed) return urlString;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || urlString;
      } catch (err) {
        console.warn("Falha ao assinar cover", err);
        return urlString;
      }
    }

    function renderGames(list) {
      gamesGrid.innerHTML = "";
      if (!list || list.length === 0) {
        gamesEmpty.style.display = "block";
        return;
      }
      gamesEmpty.style.display = "none";
      list.forEach((game) => {
        const card = document.createElement("article");
        card.className = "game-card";
        card.dataset.gameId = game.id;

        const cover = game.cover_url
          ? `<div class="game-cover"><img src="${encodeURI(game.cover_url)}" alt="${game.name}" loading="lazy" /></div>`
          : "";

        card.innerHTML = `
          <div class=\"game-meta\">
            ${game.website ? `<a href="${game.website}" target="_blank" rel="noopener" class="pill pill-link">Site oficial</a>` : `<span class="pill">Site indisponível</span>`}
            <span class=\"pill\">Marketplace ativo</span>
          </div>
          ${cover}
          <h3>${game.name}</h3>
        `;
        gamesGrid.appendChild(card);
      });
    }

    function renderSuggestions(term) {
      if (!searchSuggestions) return;
      if (!term || term.length < 2) {
        searchSuggestions.style.display = "none";
        searchSuggestions.innerHTML = "";
        return;
      }
      const matches = games.filter((g) => g.name.toLowerCase().includes(term.toLowerCase()));
      if (matches.length === 0) {
        searchSuggestions.style.display = "none";
        searchSuggestions.innerHTML = "";
        return;
      }
      searchSuggestions.innerHTML = matches
        .map((g) => `<div class=\"suggestion-item\" data-game-id=\"${g.id}\" data-game-name=\"${g.name}\">${g.name}<span class=\"badge\">Ver</span></div>`)
        .join("");
      searchSuggestions.style.display = "block";
    }

    function handleSuggestionClick(event) {
      const item = event.target.closest(".suggestion-item");
      if (!item) return;
      const gameId = item.getAttribute("data-game-id");
      const gameName = item.getAttribute("data-game-name");
      if (gameName && searchInput) searchInput.value = gameName;
      searchSuggestions.style.display = "none";
      if (gameId) {
        window.location.href = `game.html?id=${encodeURIComponent(gameId)}`;
      }
    }

    function scrollToGameCard(gameId) {
      if (!gameId) return;
      const el = document.querySelector(`[data-game-id=\"${gameId}\"]`);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        el.classList.add("pulse");
        setTimeout(() => el.classList.remove("pulse"), 800);
      }
    }

    searchForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const term = searchInput?.value.trim();
      if (!term) {
        searchFeedback.textContent = "Digite o nome de um game para começar.";
        return;
      }
      const match = games.find((g) => g.name.toLowerCase() === term.toLowerCase());
      if (match) {
        searchFeedback.textContent = `Encontramos ${match.name}. Abrindo a página do game.`;
        window.location.href = `game.html?id=${encodeURIComponent(match.id)}`;
        searchSuggestions.style.display = "none";
      } else {
        searchFeedback.innerHTML = `Não encontramos \"${term}\". <a href="#" class="link-ghost" data-action="game-submit">Clique aqui</a> para cadastrar um novo game.`;
      }
    });

    searchInput?.addEventListener("input", (event) => {
      const term = event.target.value.trim();
      renderSuggestions(term);
    });

    searchSuggestions?.addEventListener("click", handleSuggestionClick);

    gamesGrid?.addEventListener("click", (event) => {
      const link = event.target.closest("a");
      if (link) return;
      const card = event.target.closest(".game-card");
      if (!card) return;
      const gameId = card.dataset.gameId;
      if (!gameId) return;
      window.location.href = `game.html?id=${encodeURIComponent(gameId)}`;
    });

    searchFeedback?.addEventListener("click", (event) => {
      const link = event.target.closest('a[data-action="game-submit"]');
      if (!link) return;
      event.preventDefault();
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "game-submit.html";
    });

    viewAllGamesBtn?.addEventListener("click", () => {
      if (!games || games.length === 0) {
        searchFeedback.textContent = "Nenhum game cadastrado ainda.";
        return;
      }
      scrollToGameCard(games[0].id);
    });

    authBtn?.addEventListener("click", handleAuthClick);
    createListingBtn?.addEventListener("click", () => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "listing-create.html";
    });
    document.getElementById("anchor-cadastro-game")?.addEventListener("click", (event) => {
      event.preventDefault();
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "game-submit.html";
    });
    bootstrapAuth();
    fetchGames();
  </script>
</body>
</html>
