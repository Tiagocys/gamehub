<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gamehub - Marketplace seguro</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #101a2e;
      --muted: #8ea0bf;
      --text: #e8eefc;
      --accent: #7cf6c4;
      --accent-2: #76a8ff;
      --danger: #f58ea8;
      --border: rgba(255,255,255,0.08);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(118,168,255,0.15), transparent 40%),
                  radial-gradient(circle at 80% 10%, rgba(124,246,196,0.15), transparent 35%),
                  var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }
    header {
      padding: 18px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11, 18, 32, 0.9);
    }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: 0.5px; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(118,168,255,0.12);
      color: var(--accent-2);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    main { max-width: 1140px; margin: 0 auto; padding: 28px 20px 60px; display: grid; gap: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    h1 { margin: 0 0 12px; font-size: 30px; }
    h2 { margin: 0 0 12px; font-size: 20px; }
    h3 { margin: 10px 0 8px; }
    p { color: var(--muted); margin: 6px 0 12px; }
    ul { padding-left: 18px; color: var(--muted); margin-top: 6px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(118,168,255,0.4);
      box-shadow: 0 0 0 3px rgba(118,168,255,0.12);
    }
    textarea { resize: vertical; min-height: 90px; }
    button {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s;
      color: #081019;
      background: linear-gradient(135deg, var(--accent), #5ce0ff);
      box-shadow: 0 12px 30px rgba(124,246,196,0.25);
    }
    button.secondary {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      box-shadow: none;
      border: 1px solid var(--border);
    }
    button:active { transform: translateY(1px); }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #f6d87c; }
    .dot.ok { background: var(--accent); }
    .muted { color: var(--muted); font-size: 13px; }
    .notice { padding: 10px 12px; border-radius: 10px; background: rgba(118,168,255,0.08); border: 1px solid var(--border); font-size: 13px; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .hide { display: none; }
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      background: rgba(124,246,196,0.12);
      color: var(--accent);
      font-size: 12px;
      margin-left: 8px;
    }
    .error { color: var(--danger); font-size: 13px; min-height: 18px; }
    .success { color: var(--accent); font-size: 13px; min-height: 18px; }
    .hero {
      position: relative;
      overflow: hidden;
    }
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 60% 20%, rgba(124,246,196,0.12), transparent 45%),
                  radial-gradient(circle at 20% 80%, rgba(118,168,255,0.08), transparent 40%);
      pointer-events: none;
    }
    .hero-content { position: relative; z-index: 1; display: grid; gap: 12px; }
    .mini-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 10px; }
    .pill-strong {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(124,246,196,0.2);
      color: var(--text);
      border: 1px solid rgba(124,246,196,0.35);
      font-weight: 700;
      font-size: 12px;
    }
    .list-inline { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
    .list-inline span {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span style="font-size:20px;">üéÆ</span>
      Gamehub (beta)
      <span class="pill">Supabase + Cloudflare</span>
    </div>
    <div class="status">
      <div class="dot" id="status-dot"></div>
      <span id="status-text">Desconectado</span>
    </div>
  </header>

  <main>
    <section class="card hero">
      <div class="hero-content">
        <span class="pill-strong">Marketplace seguro para servidores alternativos</span>
        <h1>Venda e compre itens com escrow, chat privado e disputas moderadas.</h1>
        <p>Login s√≥ com Google para simplificar. Dados ficam no Supabase; automa√ß√µes e webhooks rodam em Cloudflare Workers.</p>
        <div class="actions">
          <button id="google-btn">Entrar com Google</button>
          <button class="secondary" id="signout-btn">Sair</button>
          <span class="muted" id="session-status">Sem sess√£o.</span>
        </div>
        <div class="mini-grid">
          <div class="notice">
            <strong>Fluxo:</strong> an√∫ncios ‚Üí compra ‚Üí pagamento via Stripe ‚Üí entrega no chat ‚Üí libera√ß√£o ‚Üí avalia√ß√µes.
          </div>
          <div class="notice">
            <strong>Seguran√ßa:</strong> JWT do Supabase, RLS ligada, logs de eventos na transa√ß√£o, e limite de quem cria servidores (somente admins).
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h2>Painel r√°pido</h2>
        <p id="profile-info">Fa√ßa login para ver seu perfil.</p>
        <div class="list-inline">
          <span>Auth: Google</span>
          <span>Banco: Supabase</span>
          <span>Storage: listing_media</span>
          <span>Webhook: Cloudflare Worker</span>
        </div>
        <div class="notice">
          Apenas administradores podem criar novos servidores. Para marcar algu√©m como admin, use a service key e atualize <code>public.users.is_admin</code>.
        </div>
      </section>

      <section class="card">
        <h2>Criar an√∫ncio <span class="tag">Requer login</span></h2>
        <p>Escolha um servidor j√° aprovado ou, se for admin, crie um novo.</p>
        <form id="listing-form">
          <div class="row">
            <div>
              <label for="server-select">Servidor existente</label>
              <select id="server-select">
                <option value="">Selecione um servidor</option>
              </select>
            </div>
            <div id="server-create-fields">
              <label for="server-name">Criar servidor (admins)</label>
              <input id="server-name" placeholder="Nome do servidor" />
            </div>
          </div>
          <label for="server-site">Site oficial (opcional)</label>
          <input id="server-site" placeholder="https://..." />

          <label for="server-description">Descri√ß√£o do servidor (opcional)</label>
          <textarea id="server-description" placeholder="Breve resumo do servidor..."></textarea>

          <div class="divider" style="height:1px;background:var(--border);margin:16px 0;"></div>

          <label for="title">T√≠tulo do an√∫ncio</label>
          <input id="title" placeholder="Conta premium, set, coins..." />

          <label for="description">Descri√ß√£o</label>
          <textarea id="description" placeholder="Detalhes do item/conta/servi√ßo..."></textarea>

          <div class="row">
            <div>
              <label for="category">Categoria</label>
              <select id="category">
                <option value="account">Conta</option>
                <option value="item">Item</option>
                <option value="currency">Moeda</option>
                <option value="service">Servi√ßo</option>
                <option value="other">Outro</option>
              </select>
            </div>
            <div>
              <label for="price">Pre√ßo</label>
              <input id="price" type="number" step="0.01" min="0" placeholder="0,00" />
            </div>
            <div>
              <label for="currency">Moeda</label>
              <select id="currency">
                <option value="BRL">BRL</option>
                <option value="USD">USD</option>
              </select>
            </div>
          </div>

          <label for="images">Imagens (URLs separadas por v√≠rgula)</label>
          <input id="images" placeholder="https://... , https://..." />

          <button type="submit" style="margin-top:16px;">Salvar an√∫ncio</button>
          <div class="error" id="listing-error"></div>
          <div class="success" id="listing-success"></div>
        </form>
      </section>
    </div>

    <section class="card">
      <h2>Como funciona na pr√°tica</h2>
      <div class="mini-grid">
        <div>
          <h3>Escrow + webhooks</h3>
          <p>Stripe captura ‚Üí Worker valida ‚Üí atualiza transa√ß√£o para paid/delivered/completed.</p>
        </div>
        <div>
          <h3>Chat privado</h3>
          <p>Cria chat vinculado √† transa√ß√£o; mensagens filtradas; anexo s√≥ imagem.</p>
        </div>
        <div>
          <h3>Disputas e auditoria</h3>
          <p>Eventos ficam em <code>transactions.events</code>; admins revisam e decidem.</p>
        </div>
        <div>
          <h3>RLS ativa</h3>
          <p>Listings vis√≠veis a todos; transa√ß√µes e mensagens s√≥ para participantes; servers apenas admins criam.</p>
        </div>
      </div>
    </section>
  </main>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const sessionStatus = document.getElementById("session-status");
    const profileInfo = document.getElementById("profile-info");
    const googleBtn = document.getElementById("google-btn");
    const signoutBtn = document.getElementById("signout-btn");
    const listingForm = document.getElementById("listing-form");
    const listingError = document.getElementById("listing-error");
    const listingSuccess = document.getElementById("listing-success");
    const serverSelect = document.getElementById("server-select");
    const serverCreateFields = document.getElementById("server-create-fields");

    let supabase;
    let profile = null;

    function setStatus(ok, text) {
      statusDot.classList.toggle("ok", ok);
      statusText.textContent = text;
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        setStatus(false, "Defina SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js");
        throw new Error("Supabase URL/key n√£o configurados");
      }
      supabase = supabase || createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setStatus(true, "Conectado");
      return supabase;
    }

    async function upsertProfile(user) {
      const payload = {
        id: user.id,
        username: user.user_metadata?.full_name?.split(" ")?.[0] || user.email.split("@")[0],
        email: user.email,
        avatar_url: user.user_metadata?.avatar_url ?? null
      };
      const { error } = await supabase.from("users").upsert(payload, { onConflict: "id" });
      if (error) throw error;
    }

    async function fetchProfile(userId) {
      const { data, error } = await supabase.from("users").select("id, username, is_admin").eq("id", userId).single();
      if (error && error.code !== "PGRST116") throw error;
      return data;
    }

    async function refreshSession() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        const session = data.session;
        if (session?.user) {
          const user = session.user;
          await upsertProfile(user);
          profile = await fetchProfile(user.id);
          sessionStatus.textContent = `Logado como ${user.email}`;
          profileInfo.textContent = profile
            ? `Perfil: ${profile.username} ${profile.is_admin ? "(admin)" : ""}`
            : "Perfil n√£o encontrado.";
          serverCreateFields.classList.toggle("hide", !profile?.is_admin);
          await loadServers();
        } else {
          profile = null;
          sessionStatus.textContent = "Sem sess√£o.";
          profileInfo.textContent = "Fa√ßa login para ver seu perfil.";
          serverCreateFields.classList.add("hide");
          serverSelect.innerHTML = '<option value=\"\">Selecione um servidor</option>';
        }
      } catch (err) {
        console.error(err);
        sessionStatus.textContent = "Erro ao checar sess√£o.";
      }
    }

    async function loadServers() {
      const { data, error } = await supabase
        .from("servers")
        .select("id,name,status")
        .order("created_at", { ascending: false })
        .limit(50);
      if (error) {
        console.error(error);
        return;
      }
      serverSelect.innerHTML = '<option value=\"\">Selecione um servidor</option>';
      data?.forEach((srv) => {
        const opt = document.createElement("option");
        opt.value = srv.id;
        opt.textContent = `${srv.name} ¬∑ ${srv.status}`;
        serverSelect.appendChild(opt);
      });
    }

    googleBtn.addEventListener("click", async () => {
      try {
        ensureClient();
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: window.location.origin }
        });
        if (error) throw error;
      } catch (err) {
        console.error(err);
        alert(err?.message || "Falha no OAuth.");
      }
    });

    signoutBtn.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        await refreshSession();
      } catch (err) {
        console.error(err);
      }
    });

    listingForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      listingError.textContent = "";
      listingSuccess.textContent = "";

      try {
        ensureClient();
        const { data: sessionData } = await supabase.auth.getSession();
        const user = sessionData.session?.user;
        if (!user) {
          listingError.textContent = "Fa√ßa login para criar an√∫ncios.";
          return;
        }

        const isAdmin = profile?.is_admin === true;
        const formValues = {
          serverId: document.getElementById("server-select").value || null,
          serverName: document.getElementById("server-name").value.trim(),
          serverSite: document.getElementById("server-site").value.trim() || null,
          serverDescription: document.getElementById("server-description").value.trim() || null,
          title: document.getElementById("title").value.trim(),
          description: document.getElementById("description").value.trim(),
          category: document.getElementById("category").value,
          price: parseFloat(document.getElementById("price").value || "0"),
          currency: document.getElementById("currency").value,
          images: document.getElementById("images").value.split(",").map((s) => s.trim()).filter(Boolean)
        };

        if (!formValues.title || !formValues.category) {
          listingError.textContent = "Preencha t√≠tulo e categoria.";
          return;
        }

        let serverId = formValues.serverId;
        if (!serverId) {
          if (!isAdmin) {
            listingError.textContent = "Somente admins podem criar servidores. Selecione um existente.";
            return;
          }
          if (!formValues.serverName) {
            listingError.textContent = "Informe o nome do servidor para criar.";
            return;
          }
          const { data: newServer, error: serverErr } = await supabase
            .from("servers")
            .insert({
              name: formValues.serverName,
              game_type: "general",
              official_site: formValues.serverSite,
              description: formValues.serverDescription,
              owner_id: user.id
            })
            .select("id")
            .single();
          if (serverErr) throw serverErr;
          serverId = newServer.id;
          await loadServers();
          serverSelect.value = serverId;
        }

        const { error: listingErr } = await supabase.from("listings").insert({
          server_id: serverId,
          user_id: user.id,
          category: formValues.category,
          title: formValues.title,
          description: formValues.description,
          price: formValues.price || 0,
          currency: formValues.currency,
          images: formValues.images,
          status: "active"
        });
        if (listingErr) throw listingErr;

        listingSuccess.textContent = "An√∫ncio criado!";
        listingForm.reset();
        document.getElementById("currency").value = "BRL";
      } catch (err) {
        console.error(err);
        listingError.textContent = err?.message || "Erro ao salvar an√∫ncio.";
      }
    });

    // Inicializa
    try {
      ensureClient();
      refreshSession();
      supabase.auth.onAuthStateChange(() => refreshSession());
    } catch (err) {
      console.warn(err.message);
    }
  </script>
</body>
</html>
