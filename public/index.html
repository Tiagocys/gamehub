<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gimerr - Marketplace gamer</title>
  <link rel="stylesheet" href="css/global.css" />
</head>
<body>
  <div class="page">
    <header class="site-nav">
      <a href="index.html" class="brand">
        <img src="img/logo.png" alt="Gimerr" class="brand-logo" />
        <div class="brand-copy">
          <span class="brand-name">Gimerr</span>
          <span class="brand-tagline">Players no comando</span>
        </div>
      </a>
      <button id="auth-btn" class="btn btn-primary">Entrar com Google</button>
    </header>

    <main>
      <section class="hero">
        <div class="hero-grid">
          <div class="hero-copy">
            <h1>Encontre freelancers, itens e contas do seu game favorito.</h1>
            <p class="lede">Gamers freelancers publicam gigs, entregam itens raros e vendem contas verificadas. Cada game tem seu próprio marketplace operado 100% por players.</p>
            <form class="search" id="game-search">
              <div class="search-bar">
                <input id="game-search-input" class="search-input" type="search" placeholder="Pesquise aqui um game" aria-label="Pesquise aqui um game" autocomplete="off" />
                <button type="submit" class="btn btn-ghost">Buscar</button>
              </div>
              <div class="suggestions">
                <div id="search-suggestions" class="suggestions-panel" style="display:none;"></div>
              </div>
              <p id="search-feedback" class="search-feedback">Digite o nome de um game e veja se já temos um marketplace ativo.</p>
            </form>
            <div class="cta-inline">
              não encontrou um game que procurava?
              <button type="button" class="link-ghost" id="cta-cadastrar-game">Cadastre ele clicando aqui</button>
            </div>
            <div class="pill-trail">
              <span class="pill">Boost de rank</span>
              <span class="pill">Mercado de itens</span>
              <span class="pill">Contas verificadas</span>
              <span class="pill">Coaching</span>
            </div>
            <div class="session-pill" id="session-status">Você está navegando como convidado. Faça login para salvar favoritos e publicar gigs.</div>
          </div>
          <div class="hero-panel">
            <div class="hero-card outline">
              <div class="badge">Play to earn</div>
              <ul class="hero-list">
                <li>
                  <span>Boosters verificam identidade</span>
                  <span class="badge">Verificado</span>
                </li>
                <li>
                  <span>Itens raros com prova de entrega</span>
                  <span class="badge">Escrow</span>
                </li>
                <li>
                  <span>Contas smurf prontas para jogar</span>
                  <span class="badge">Seguro</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <section class="section popular">
        <div class="section-header">
          <div>
            <span class="eyebrow">Primeira sessão</span>
            <h2>Games mais populares agora</h2>
            <p class="section-sub">Escolha um título e navegue no marketplace alimentado pela própria comunidade.</p>
          </div>
          <button class="btn btn-ghost" type="button" id="view-all-games">Ver todos os games</button>
        </div>
        <div id="games-grid" class="games-grid"></div>
        <p id="games-empty" class="search-feedback" style="display:none;">Nenhum game cadastrado ainda. Adicione o primeiro clicando no CTA acima.</p>
      </section>

      <section class="section">
        <div class="hero-card">
          <h3>Escrow e entregas seguras</h3>
          <p>Pagamentos ficam protegidos até a entrega no chat. Cada novo usuário aprende o fluxo de pagamento antes de negociar.</p>
          <div class="stat-row">
            <div class="stat">
              <strong>Stripe</strong>
              <span>Checkout e proteção</span>
            </div>
            <div class="stat">
              <strong>Timeline</strong>
              <span>Entrega → liberação</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const authBtn = document.getElementById("auth-btn");
    const sessionStatus = document.getElementById("session-status");
    const searchForm = document.getElementById("game-search");
    const searchInput = document.getElementById("game-search-input");
    const searchFeedback = document.getElementById("search-feedback");
    const searchSuggestions = document.getElementById("search-suggestions");
    const gamesGrid = document.getElementById("games-grid");
    const gamesEmpty = document.getElementById("games-empty");
    const ctaCadastrarGame = document.getElementById("cta-cadastrar-game");
    const viewAllGamesBtn = document.getElementById("view-all-games");

    let supabase;
    let currentUser = null;
    let games = [];

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        sessionStatus.textContent = "Configure SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js.";
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.textContent = "Sair";
        sessionStatus.textContent = "Sessão ativa.";
        return;
      }
      authBtn.textContent = "Entrar com Google";
      sessionStatus.textContent = "Você está navegando como convidado. Faça login para salvar favoritos e publicar gigs.";
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        if (currentUser) {
          await supabase.auth.signOut();
          currentUser = null;
          updateAuthUI();
          return;
        }
        await supabase.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: window.location.href.split("#")[0],
            queryParams: { prompt: "select_account" }
          }
        });
      } catch (err) {
        console.error(err);
        sessionStatus.textContent = err?.message || "Erro ao autenticar.";
        authBtn.disabled = false;
      }
    }

    async function bootstrapAuth() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
        sessionStatus.textContent = "Erro ao carregar sessão.";
      }
    }

    async function fetchGames() {
      try {
        ensureClient();
        const primary = await loadGamesFromTable("games");
        games = primary;
        renderGames(games);
      } catch (primaryErr) {
        console.warn("Falha ao ler tabela games, tentando servers.", primaryErr);
        try {
          const fallback = await loadGamesFromTable(
            "servers",
            (row) => ({
              id: row.id,
              name: row.name,
              description: row.description,
              cover_url: row.cover_url,
              website: row.official_site,
              category: row.game_type || "Game",
            })
          );
          games = fallback;
          renderGames(games);
        } catch (err) {
          console.error(err);
          gamesGrid.innerHTML = "";
          gamesEmpty.style.display = "block";
          gamesEmpty.textContent = err?.message || "Erro ao carregar games.";
        }
      }
    }

    async function loadGamesFromTable(table, mapFn) {
      const { data, error } = await supabase
        .from(table)
        .select("*")
        .order("name", { ascending: true });
      if (error) throw error;
      return (data || []).map(mapFn || ((row) => ({
        id: row.id,
        name: row.name,
        description: row.description,
        cover_url: row.cover_url || row.image || row.image_url || row.photo,
        website: row.website || row.site || row.official_site,
        category: row.category || row.type || row.game_type || "Game",
      })));
    }

    function renderGames(list) {
      gamesGrid.innerHTML = "";
      if (!list || list.length === 0) {
        gamesEmpty.style.display = "block";
        return;
      }
      gamesEmpty.style.display = "none";
      list.forEach((game) => {
        const card = document.createElement("article");
        card.className = "game-card";
        card.dataset.gameId = game.id;

        const cover = game.cover_url
          ? `<div style=\"width:100%;height:150px;border-radius:12px;background:url('${game.cover_url}') center/cover no-repeat;border:1px solid var(--border);\"></div>`
          : "";

        card.innerHTML = `
          <div class=\"game-meta\">
            <span class=\"tag\">${game.category || "Game"}</span>
            <span class=\"pill\">Marketplace ativo</span>
          </div>
          <h3>${game.name}</h3>
          <p>${game.description || "Marketplace operado pela comunidade."}</p>
          ${cover}
          <div class=\"game-tags\">
            ${game.website ? `<a href=\"${game.website}\" target=\"_blank\" rel=\"noopener\" class=\"pill\">Site oficial</a>` : "<span>Site indisponível</span>"}
          </div>
        `;
        gamesGrid.appendChild(card);
      });
    }

    function renderSuggestions(term) {
      if (!searchSuggestions) return;
      if (!term || term.length < 2) {
        searchSuggestions.style.display = "none";
        searchSuggestions.innerHTML = "";
        return;
      }
      const matches = games.filter((g) => g.name.toLowerCase().includes(term.toLowerCase()));
      if (matches.length === 0) {
        searchSuggestions.style.display = "none";
        searchSuggestions.innerHTML = "";
        return;
      }
      searchSuggestions.innerHTML = matches
        .map((g) => `<div class=\"suggestion-item\" data-game-id=\"${g.id}\" data-game-name=\"${g.name}\">${g.name}<span class=\"badge\">Ver</span></div>`)
        .join("");
      searchSuggestions.style.display = "block";
    }

    function handleSuggestionClick(event) {
      const item = event.target.closest(".suggestion-item");
      if (!item) return;
      const gameId = item.getAttribute("data-game-id");
      const gameName = item.getAttribute("data-game-name");
      if (gameName && searchInput) searchInput.value = gameName;
      searchSuggestions.style.display = "none";
      scrollToGameCard(gameId);
    }

    function scrollToGameCard(gameId) {
      if (!gameId) return;
      const el = document.querySelector(`[data-game-id=\"${gameId}\"]`);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
        el.classList.add("pulse");
        setTimeout(() => el.classList.remove("pulse"), 800);
      }
    }

    searchForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const term = searchInput?.value.trim();
      if (!term) {
        searchFeedback.textContent = "Digite o nome de um game para começar.";
        return;
      }
      const match = games.find((g) => g.name.toLowerCase() === term.toLowerCase());
      if (match) {
        searchFeedback.textContent = `Encontramos ${match.name}. Rolando até o marketplace.`;
        scrollToGameCard(match.id);
        searchSuggestions.style.display = "none";
      } else {
        searchFeedback.textContent = `Não encontramos \"${term}\". Cadastre ou sugira o game.`;
      }
    });

    searchInput?.addEventListener("input", (event) => {
      const term = event.target.value.trim();
      renderSuggestions(term);
    });

    searchSuggestions?.addEventListener("click", handleSuggestionClick);

    ctaCadastrarGame?.addEventListener("click", async () => {
      try {
        ensureClient();
        if (!currentUser) {
          await supabase.auth.signInWithOAuth({
            provider: "google",
            options: { redirectTo: new URL("game-submit.html", window.location.href).href }
          });
          return;
        }
        window.location.href = "game-submit.html";
      } catch (err) {
        console.error(err);
        sessionStatus.textContent = err?.message || "Erro ao redirecionar.";
      }
    });

    viewAllGamesBtn?.addEventListener("click", () => {
      if (!games || games.length === 0) {
        searchFeedback.textContent = "Nenhum game cadastrado ainda.";
        return;
      }
      scrollToGameCard(games[0].id);
    });

    authBtn?.addEventListener("click", handleAuthClick);
    bootstrapAuth();
    fetchGames();
  </script>
</body>
</html>
