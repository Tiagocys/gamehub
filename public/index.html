<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Marketplace gamer</title>
  <link rel="stylesheet" href="css/global.css" />
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <site-navbar></site-navbar>

    <main>
      <section class="hero">
        <video class="hero-video" autoplay muted loop playsinline>
          <source src="videos/bg.webm" type="video/webm" />
        </video>
        <div class="hero-overlay"></div>
        <div class="hero-grid single">
          <div class="hero-copy">
            <h1 style="font-size: 80px; text-align: center;">Encontre seu jogo</h1>
            <p class="lede">Cada game tem seu próprio marketplace operado 100% por players.</p>
            <form class="search" id="game-search">
              <div class="search-bar">
                <input id="game-search-input" class="search-input" type="search" placeholder="Pesquise aqui um game" aria-label="Pesquise aqui um game" autocomplete="off" />
                <button type="submit" class="btn btn-ghost">Buscar</button>
              </div>
              <div class="suggestions">
                <div id="search-suggestions" class="suggestions-panel" style="display:none;"></div>
              </div>
            </form>
            <div class="pill-trail">
              <span class="pill">Itens</span>
              <span class="pill">Serviços</span>
              <span class="pill">Contas e personagens</span>
            </div>
          </div>
        </div>
      </section>

      <section class="section popular">
        <div class="section-header">
          <div>
            <h2>Games mais populares agora</h2>
            <p class="section-sub">Escolha um título e navegue no marketplace alimentado pela própria comunidade.</p>
          </div>
        </div>
        <div id="games-grid" class="games-grid"></div>
        <p id="games-empty" class="search-feedback" style="display:none;">Nenhum game cadastrado ainda. Adicione o primeiro clicando no CTA acima.</p>
      </section>

    </main>

    <site-footer></site-footer>
  </div>

  <script src="env.js"></script>
  <script src="js/site-navbar.js"></script>
  <script src="js/site-footer.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    await (window.__NAVBAR_READY__ || Promise.resolve());

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const profileLink = document.getElementById("profile-link");
    const searchForm = document.getElementById("game-search");
    const searchInput = document.getElementById("game-search-input");
    const searchSuggestions = document.getElementById("search-suggestions");
    const gamesGrid = document.getElementById("games-grid");
    const gamesEmpty = document.getElementById("games-empty");
    const createListingBtn = document.getElementById("create-listing-btn");

    let supabase;
    let currentUser = null;
    let games = [];
    let allSortedGames = [];
    let loadedGameCards = [];
    const GAMES_PAGE_SIZE = 10;
    let gamesOffset = 0;
    let gamesHasMore = true;
    let gamesLoading = false;
    let avatarLoaded = false;
    if (avatarImg) {
      avatarImg.referrerPolicy = "no-referrer";
      avatarImg.addEventListener("error", () => {
        if (avatarImg.dataset.fallbackApplied === "1") return;
        avatarImg.dataset.fallbackApplied = "1";
        avatarImg.src = "img/avatar.svg";
      });
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        showSuggestionMessage("Configure SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js.");
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        if (profileLink) profileLink.href = `user.html?id=${encodeURIComponent(currentUser.id)}`;
        loadUserAvatar();
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        return;
      }
      authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (profileLink) profileLink.href = "profile.html";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      avatarLoaded = false;
      markAvatarReady();
    }

    async function setAvatarImage(src) {
      if (!avatarImg) return;
      const normalizedSrc = typeof src === "string" ? src.trim() : "";
      const finalSrc = normalizedSrc && normalizedSrc !== "null" && normalizedSrc !== "undefined"
        ? normalizedSrc
        : "img/avatar.svg";
      avatarImg.dataset.fallbackApplied = "0";
      avatarImg.src = finalSrc;
      try {
        await avatarImg.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          avatarImg.src = "img/avatar.svg";
          try {
            await avatarImg.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      } finally {
        markAvatarReady();
      }
    }

    async function loadUserAvatar() {
      if (!avatarImg || !currentUser || avatarLoaded) return;
      try {
        ensureClient();
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatar);
        } catch (_innerErr) {
          await setAvatarImage("img/avatar.svg");
        }
      } finally {
        avatarLoaded = true;
      }
    }

    async function handleAuthClick() {
      try {
        await startOAuthLikeNavbar();
      } catch (err) {
        console.error(err);
        showSuggestionMessage(err?.message || "Erro ao autenticar.");
        authBtn.disabled = false;
      }
    }

    async function startOAuthLikeNavbar(targetPath = null) {
      ensureClient();
      const normalizedPath = targetPath
        ? (String(targetPath).startsWith("/") ? String(targetPath) : `/${String(targetPath)}`)
        : `${window.location.pathname}${window.location.search || ""}`;
      const redirectTo = `${window.location.origin}${normalizedPath}`;
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo },
      });
      if (error) throw error;
    }

    async function bootstrapAuth() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
        showSuggestionMessage("Erro ao carregar sessão.");
        markAvatarReady();
      }
    }

    function mapServerRow(row) {
      return {
        id: row.id,
        name: row.name,
        description: row.description,
        cover_url: row.banner_url || row.cover_url || row.image || row.image_url || row.photo,
        website: row.website || row.site || row.official_site,
        category: row.category || row.type || row.game_type || "Game",
      };
    }

    function buildPopularityMap(listings) {
      const map = new Map();
      (listings || []).forEach((row) => {
        const key = String(row?.server_id || "").trim();
        if (!key) return;
        map.set(key, (map.get(key) || 0) + 1);
      });
      return map;
    }

    function sortGamesByPopularity(servers, popularityMap) {
      return [...(servers || [])].sort((a, b) => {
        const countA = popularityMap.get(String(a.id)) || 0;
        const countB = popularityMap.get(String(b.id)) || 0;
        if (countB !== countA) return countB - countA;
        return String(a.name || "").localeCompare(String(b.name || ""), "pt-BR", { sensitivity: "base" });
      });
    }

    async function fetchGamesCatalog() {
      ensureClient();
      const [{ data: serverData, error: serverError }, { data: listingData, error: listingError }] = await Promise.all([
        supabase
          .from("servers")
          .select("*")
          .eq("status", "active"),
        supabase
          .from("listings")
          .select("server_id")
          .eq("status", "active"),
      ]);
      if (serverError) throw serverError;
      if (listingError) throw listingError;

      const mappedServers = (serverData || []).map(mapServerRow);
      const popularityMap = buildPopularityMap(listingData || []);
      allSortedGames = sortGamesByPopularity(mappedServers, popularityMap);
      games = allSortedGames.map((item) => ({ id: item.id, name: item.name }));
    }

    async function fetchGamesPage(reset = false) {
      if (gamesLoading) return;
      if (!gamesHasMore && !reset) return;

      let shouldAutoloadNext = false;
      try {
        ensureClient();
        gamesLoading = true;

        if (reset) {
          gamesGrid.innerHTML = "";
          loadedGameCards = [];
          allSortedGames = [];
          games = [];
          gamesOffset = 0;
          gamesHasMore = true;
          gamesEmpty.style.display = "none";
          await fetchGamesCatalog();
        }

        const rows = allSortedGames.slice(gamesOffset, gamesOffset + GAMES_PAGE_SIZE);
        const enhanced = await enhanceCovers(rows);
        loadedGameCards = [...loadedGameCards, ...enhanced];
        appendGames(enhanced);
        gamesOffset += rows.length;
        gamesHasMore = gamesOffset < allSortedGames.length;
        gamesEmpty.style.display = loadedGameCards.length === 0 ? "block" : "none";
        if (loadedGameCards.length === 0) {
          gamesEmpty.textContent = "Nenhum game cadastrado ainda. Adicione o primeiro clicando no CTA acima.";
        }

        shouldAutoloadNext = !!gamesGrid && gamesHasMore && gamesGrid.scrollWidth <= gamesGrid.clientWidth + 16;
      } catch (err) {
        console.error(err);
        if (loadedGameCards.length === 0) {
          gamesGrid.innerHTML = "";
          gamesEmpty.style.display = "block";
          gamesEmpty.textContent = err?.message || "Erro ao carregar games.";
        }
      } finally {
        gamesLoading = false;
        if (shouldAutoloadNext) {
          fetchGamesPage(false);
        }
      }
    }

    async function enhanceCovers(list) {
      if (!list || list.length === 0) return [];
      return Promise.all(list.map(async (game) => {
        if (!game.cover_url) return game;
        const signed = await getSignedCoverUrl(game.cover_url);
        return { ...game, cover_url: signed || game.cover_url };
      }));
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/public/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const [bucket, ...pathParts] = rest.split("/");
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    function showSuggestionMessage(message) {
      if (!searchSuggestions) return;
      searchSuggestions.innerHTML = `
        <div class="suggestion-empty">${message}</div>
      `;
      searchSuggestions.style.display = "block";
    }

    async function getSignedCoverUrl(urlString) {
      const parsed = parseStoragePath(urlString);
      if (!parsed) return urlString;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || urlString;
      } catch (err) {
        console.warn("Falha ao assinar cover", err);
        return urlString;
      }
    }

    function appendGames(list) {
      if (!list || list.length === 0) {
        if (loadedGameCards.length === 0) {
          gamesEmpty.style.display = "block";
        }
        return;
      }
      gamesEmpty.style.display = "none";
      list.forEach((game) => {
        const card = createGameCard(game);
        gamesGrid.appendChild(card);
      });
    }

    function createGameCard(game) {
      const card = document.createElement("article");
      card.className = "game-card";
      card.dataset.gameId = game.id;

      const cover = game.cover_url
        ? `<div class="game-cover"><img src="${encodeURI(game.cover_url)}" alt="${game.name}" loading="lazy" /></div>`
        : "";

      card.innerHTML = `
        <div class=\"game-meta\">
          <span class="pill game-name-pill" title="${game.name}">${game.name}</span>
        </div>
        ${cover}
        <div class="game-footer">
          ${game.website ? `<a href="${game.website}" target="_blank" rel="noopener" class="pill pill-link">Site oficial</a>` : `<span class="pill">Site indisponível</span>`}
        </div>
      `;
      return card;
    }

    function handleGamesGridScroll() {
      if (!gamesGrid || gamesLoading || !gamesHasMore) return;
      const nearRightEdge = gamesGrid.scrollLeft + gamesGrid.clientWidth >= gamesGrid.scrollWidth - 140;
      if (nearRightEdge) {
        fetchGamesPage(false);
      }
    }

    function renderSuggestions(term) {
      if (!searchSuggestions) return;
      if (!term || term.length < 2) {
        searchSuggestions.style.display = "none";
        searchSuggestions.innerHTML = "";
        return;
      }
      const matches = games.filter((g) => g.name.toLowerCase().includes(term.toLowerCase()));
      if (matches.length === 0) {
        searchSuggestions.innerHTML = `
          <div class="suggestion-empty">
            Não encontrou o game que procurava?
            <a class="link-ghost" href="game-submit.html" data-action="game-submit">Clique aqui</a> para cadastrar um novo game.
          </div>
        `;
        searchSuggestions.style.display = "block";
        return;
      }
      const items = matches
        .map((g) => `<div class=\"suggestion-item\" data-game-id=\"${g.id}\" data-game-name=\"${g.name}\">${g.name}<span class=\"badge\">Ver</span></div>`)
        .join("");
      const footer = `
        <div class="suggestion-footer">
          Não encontrou o game que procurava?
          <a class="link-ghost" href="game-submit.html" data-action="game-submit">Clique aqui</a> para cadastrar um novo game.
        </div>
      `;
      searchSuggestions.innerHTML = `${items}${footer}`;
      searchSuggestions.style.display = "block";
    }

    function handleSuggestionClick(event) {
      const item = event.target.closest(".suggestion-item");
      if (!item) return;
      const gameId = item.getAttribute("data-game-id");
      const gameName = item.getAttribute("data-game-name");
      if (gameName && searchInput) searchInput.value = gameName;
      searchSuggestions.style.display = "none";
      if (gameId) {
        window.location.href = `game.html?id=${encodeURIComponent(gameId)}`;
      }
    }

    searchForm?.addEventListener("submit", (event) => {
      event.preventDefault();
      const term = searchInput?.value.trim();
      if (!term) {
        showSuggestionMessage("Digite o nome de um game para começar.");
        return;
      }
      const match = games.find((g) => g.name.toLowerCase() === term.toLowerCase());
      if (match) {
        window.location.href = `game.html?id=${encodeURIComponent(match.id)}`;
        searchSuggestions.style.display = "none";
      } else {
        searchSuggestions.innerHTML = `
          <div class="suggestion-empty">
            Não encontramos "${term}".
            <a href="game-submit.html" class="link-ghost" data-action="game-submit">Clique aqui</a> para cadastrar um novo game.
          </div>
        `;
        searchSuggestions.style.display = "block";
      }
    });

    searchInput?.addEventListener("input", (event) => {
      const term = event.target.value.trim();
      renderSuggestions(term);
    });

    searchSuggestions?.addEventListener("click", handleSuggestionClick);
    searchSuggestions?.addEventListener("click", (event) => {
      const link = event.target.closest('a[data-action="game-submit"]');
      if (!link) return;
      event.preventDefault();
      if (!currentUser) {
        startOAuthLikeNavbar("game-submit.html").catch((err) => {
          console.error(err);
          showSuggestionMessage(err?.message || "Erro ao iniciar login com Google.");
        });
        return;
      }
      window.location.href = "game-submit.html";
    });

    gamesGrid?.addEventListener("click", (event) => {
      const link = event.target.closest("a");
      if (link) return;
      const card = event.target.closest(".game-card");
      if (!card) return;
      const gameId = card.dataset.gameId;
      if (!gameId) return;
      window.location.href = `game.html?id=${encodeURIComponent(gameId)}`;
    });
    gamesGrid?.addEventListener("scroll", handleGamesGridScroll, { passive: true });

    authBtn?.addEventListener("click", handleAuthClick);
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
      }
    });
    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "index.html";
        return;
      }
      window.location.href = "listing-create.html";
    }

    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });
    bootstrapAuth();
    fetchGamesPage(true);
    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let avatarReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !avatarReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });
  </script>
</body>
</html>
