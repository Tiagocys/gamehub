<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gimerr - Login</title>
  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --muted: #5f6f8c;
      --text: #0f2557;
      --accent: #1b4fd3;
      --accent-2: #4e7dff;
      --danger: #e2526d;
      --border: rgba(15, 37, 87, 0.08);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }
    header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 255, 255, 0.92);
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo img { width: 110px; height: auto; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(27,79,211,0.1);
      color: var(--accent-2);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .header-actions { display: flex; align-items: center; gap: 14px; }
    .header-actions { display: flex; align-items: center; gap: 14px; }
    main { max-width: 960px; margin: 0 auto; padding: 32px 20px 60px; display: grid; gap: 18px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 12px 30px rgba(15,37,87,0.08);
    }
    h1 { margin: 0 0 12px; font-size: 32px; color: #0d1b3b; }
    h2 { margin: 0 0 12px; font-size: 20px; }
    p { color: var(--muted); margin: 6px 0 14px; }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s;
      color: #f8fbff;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 24px rgba(27,79,211,0.25);
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    button:active { transform: translateY(1px); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #f6d87c; }
    .dot.ok { background: var(--accent); }
    .notice { padding: 12px 14px; border-radius: 10px; background: rgba(118,168,255,0.08); border: 1px solid var(--border); font-size: 13px; }
    .list-inline { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
    .list-inline span {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="img/logo.png" alt="Gimerr" />
      <span class="pill">Login</span>
    </div>
    <div class="header-actions">
      <div class="status">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">Desconectado</span>
      </div>
      <button id="header-auth-btn" class="secondary">Entrar</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Entre com Google para começar</h1>
      <p>Use sua conta Google para acessar o <strong>Gimerr</strong>, onde gamers compram e vendem contas, itens e serviços com segurança.</p>
      <div class="actions">
        <button id="google-btn">Entrar com Google</button>
        <a href="index.html" class="secondary" style="text-decoration:none; padding:12px 18px; border-radius:999px; border:1px solid var(--border);">Ir para Home</a>
      </div>
      <div class="notice" id="session-status">Sem sessão.</div>
    </section>

    <section class="card">
      <h2>Como funciona</h2>
      <div class="list-inline">
        <span>Home: anúncios</span>
        <span>Admin: servidores</span>
        <span>Escrow com Stripe</span>
        <span>Chats & disputas</span>
      </div>
      <p>Assim que o login for confirmado nós te levamos automaticamente para a área certa: compradores e vendedores caem na Home; administradores seguem para a central de servidores.</p>
      <div class="notice" id="profile-info">Faça login para carregar seu perfil.</div>
    </section>
  </main>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const sessionStatus = document.getElementById("session-status");
    const profileInfo = document.getElementById("profile-info");
    const googleBtn = document.getElementById("google-btn");
    const headerAuthBtn = document.getElementById("header-auth-btn");

    const SESSION_STORAGE_KEY = "gimerr-auth-session";
    let supabase;
    let authListenerAttached = false;
    let redirectTriggered = false;

    function setStatus(ok, text) {
      statusDot.classList.toggle("ok", ok);
      statusText.textContent = text;
    }

    function persistLocalSession(session) {
      if (session) {
        localStorage.setItem(
          SESSION_STORAGE_KEY,
          JSON.stringify({
            access_token: session.access_token,
            refresh_token: session.refresh_token,
          }),
        );
      } else {
        localStorage.removeItem(SESSION_STORAGE_KEY);
      }
    }

    async function restoreSessionFromStorage() {
      const raw = localStorage.getItem(SESSION_STORAGE_KEY);
      if (!raw) return null;
      try {
        const saved = JSON.parse(raw);
        if (!saved.access_token || !saved.refresh_token) return null;
        const { data, error } = await supabase.auth.setSession({
          access_token: saved.access_token,
          refresh_token: saved.refresh_token,
        });
        if (error) {
          console.error(error);
          localStorage.removeItem(SESSION_STORAGE_KEY);
          return null;
        }
        return data.session;
      } catch (err) {
        console.error(err);
        localStorage.removeItem(SESSION_STORAGE_KEY);
        return null;
      }
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        setStatus(false, "Defina SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js");
        throw new Error("Supabase URL/key não configurados");
      }
      supabase = supabase || createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storageKey: "gimerr-auth-token",
        },
      });
      if (!authListenerAttached) {
        supabase.auth.onAuthStateChange((_event, session) => {
          persistLocalSession(session);
          refreshSession();
        });
        authListenerAttached = true;
      }
      return supabase;
    }

    async function upsertProfile(user) {
      const payload = {
        id: user.id,
        username: user.user_metadata?.full_name?.split(" ")?.[0] || user.email.split("@")[0],
        email: user.email,
        avatar_url: user.user_metadata?.avatar_url ?? null
      };
      const { error } = await supabase.from("users").upsert(payload, { onConflict: "id" });
      if (error) throw error;
    }

    async function fetchProfile(userId) {
      const { data, error } = await supabase.from("users").select("username, is_admin").eq("id", userId).single();
      if (error && error.code !== "PGRST116") throw error;
      return data;
    }

    function redirectAfterLogin(profile) {
      if (redirectTriggered) return;
      const destination = profile?.is_admin ? "admin.html" : "index.html";
      const current = window.location.pathname.split("/").pop();
      if (current === destination) return;
      redirectTriggered = true;
      sessionStatus.textContent = "Redirecionando...";
      window.location.href = destination;
    }

    function configureHeaderButton(isLogged) {
      if (!headerAuthBtn) return;
      headerAuthBtn.disabled = false;
      if (isLogged) {
        headerAuthBtn.textContent = "Sair";
        headerAuthBtn.onclick = async () => {
          try {
            ensureClient();
            headerAuthBtn.disabled = true;
            await supabase.auth.signOut();
            setStatus(false, "Sessão encerrada");
            sessionStatus.textContent = "Sessão encerrada.";
            profileInfo.textContent = "Faça login para carregar seu perfil.";
            redirectTriggered = false;
            await refreshSession();
          } catch (err) {
            console.error(err);
            headerAuthBtn.disabled = false;
          }
        };
      } else {
      headerAuthBtn.textContent = "Entrar";
      headerAuthBtn.onclick = () => googleBtn.click();
      }
    }

    async function refreshSession() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        let session = data.session;
        if (!session) {
          session = await restoreSessionFromStorage();
        }
        if (session?.user) {
          const user = session.user;
          await upsertProfile(user);
          const profile = await fetchProfile(user.id);
          setStatus(true, "Sessão ativa");
          sessionStatus.textContent = `Logado como ${user.email}`;
          profileInfo.textContent = profile
            ? `Perfil carregado: ${profile.username} ${profile.is_admin ? "(admin)" : ""}`
            : "Perfil não encontrado.";
          configureHeaderButton(true);
          redirectAfterLogin(profile);
        } else {
          setStatus(false, "Sem sessão");
          sessionStatus.textContent = "Sem sessão.";
          profileInfo.textContent = "Faça login para carregar seu perfil.";
          configureHeaderButton(false);
        }
      } catch (err) {
        console.error(err);
        setStatus(false, "Erro");
        sessionStatus.textContent = err?.message || "Erro ao checar sessão.";
      }
    }

    googleBtn.addEventListener("click", async () => {
      try {
        ensureClient();
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: window.location.origin + "/login.html" }
        });
        if (error) throw error;
      } catch (err) {
        console.error(err);
        alert(err?.message || "Falha no OAuth.");
      }
    });

    try {
      ensureClient();
      refreshSession();
    } catch (err) {
      console.warn(err.message);
    }
  </script>
</body>
</html>
