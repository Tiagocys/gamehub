<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gimerr - Login</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Kanit:wght@500;600;700&display=swap');

    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --muted: #5f6f8c;
      --text: #0f2557;
      --accent: #1b4fd3;
      --accent-2: #4e7dff;
      --danger: #e2526d;
      --border: rgba(15, 37, 87, 0.08);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background:
        radial-gradient(circle at 15% 20%, rgba(27, 79, 211, 0.08), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(78, 125, 255, 0.08), transparent 40%),
        linear-gradient(140deg, #f8faff 0%, #eef2fb 55%, #f9fbff 100%);
      color: var(--text);
      font-family: "Space Grotesk", "Kanit", sans-serif;
      min-height: 100vh;
    }
    header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 255, 255, 0.92);
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo img { width: 110px; height: auto; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(27,79,211,0.1);
      color: var(--accent-2);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .header-actions { display: flex; align-items: center; gap: 14px; }
    .header-actions { display: flex; align-items: center; gap: 14px; }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 60px;
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: stretch;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 12px 30px rgba(15,37,87,0.08);
    }
    h1 { margin: 0 0 12px; font-size: 30px; color: #0d1b3b; font-family: "Kanit", "Space Grotesk", sans-serif; }
    h2 { margin: 0 0 12px; font-size: 20px; font-family: "Kanit", "Space Grotesk", sans-serif; }
    p { color: var(--muted); margin: 6px 0 14px; }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s;
      color: #f8fbff;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 24px rgba(27,79,211,0.25);
    }
    .google-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .google-btn img {
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      padding: 3px;
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    button:active { transform: translateY(1px); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #f6d87c; }
    .dot.ok { background: var(--accent); }
    .notice { padding: 12px 14px; border-radius: 10px; background: rgba(118,168,255,0.08); border: 1px solid var(--border); font-size: 13px; }
    .list-inline { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
    .list-inline span {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .role-card {
      position: relative;
      overflow: hidden;
    }
    .role-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(27,79,211,0.12), transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }
    .role-card > * { position: relative; z-index: 1; }
    .login-card {
      display: flex;
      flex-direction: column;
      gap: 14px;
      justify-content: center;
    }
    .login-card .actions { margin-top: 4px; }
    .helper-link {
      text-decoration: underline;
      color: var(--accent);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="img/logo.png" alt="Gimerr" />
      <span class="pill">Login</span>
    </div>
    <div class="header-actions">
      <div class="status">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">Desconectado</span>
      </div>
      <button id="header-auth-btn" class="secondary">Entrar</button>
    </div>
  </header>

  <main>
    <section class="card role-card">
      <h1>Sou vendedor!</h1>
      <p>Crie ou faça login na sua conta para anunciar itens rapidamente!</p>
      <p>Você também pode oferecer serviços para outros usuários que procurarem pelo que você faz.</p>
    </section>

    <section class="card role-card">
      <h1>Sou comprador!</h1>
      <p>Encontre ofertas de itens raros para seu personagem ou personagens de nível mais alto à venda.</p>
      <p>Você também pode contratar outros players para completar tasks e avançar o nível do seu personagem.</p>
    </section>

    <section class="card login-card">
      <h2>Entrar com Google</h2>
      <p>Use sua conta Google para acessar o Gimerr com segurança.</p>
      <div class="actions">
        <button id="google-btn" class="google-btn">
          <img src="img/google.svg" alt="" />
          Entrar com Google
        </button>
        <a href="index.html" class="secondary helper-link">Ir para Home</a>
      </div>
    </section>
  </main>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const statusDot = document.getElementById("status-dot");
    const statusText = document.getElementById("status-text");
    const sessionStatus = document.getElementById("session-status");
    const profileInfo = document.getElementById("profile-info");
    const googleBtn = document.getElementById("google-btn");
    const headerAuthBtn = document.getElementById("header-auth-btn");

    const SESSION_STORAGE_KEY = "gimerr-auth-session";
    let supabase;
    let authListenerAttached = false;
    let redirectTriggered = false;

    function setStatus(ok, text) {
      statusDot.classList.toggle("ok", ok);
      statusText.textContent = text;
    }

    function persistLocalSession(session) {
      if (session) {
        localStorage.setItem(
          SESSION_STORAGE_KEY,
          JSON.stringify({
            access_token: session.access_token,
            refresh_token: session.refresh_token,
          }),
        );
      } else {
        localStorage.removeItem(SESSION_STORAGE_KEY);
      }
    }

    async function restoreSessionFromStorage() {
      const raw = localStorage.getItem(SESSION_STORAGE_KEY);
      if (!raw) return null;
      try {
        const saved = JSON.parse(raw);
        if (!saved.access_token || !saved.refresh_token) return null;
        const { data, error } = await supabase.auth.setSession({
          access_token: saved.access_token,
          refresh_token: saved.refresh_token,
        });
        if (error) {
          console.error(error);
          localStorage.removeItem(SESSION_STORAGE_KEY);
          return null;
        }
        return data.session;
      } catch (err) {
        console.error(err);
        localStorage.removeItem(SESSION_STORAGE_KEY);
        return null;
      }
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        setStatus(false, "Defina SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js");
        throw new Error("Supabase URL/key não configurados");
      }
      supabase = supabase || createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storageKey: "gimerr-auth-token",
        },
      });
      if (!authListenerAttached) {
        supabase.auth.onAuthStateChange((_event, session) => {
          persistLocalSession(session);
          refreshSession();
        });
        authListenerAttached = true;
      }
      return supabase;
    }

    async function upsertProfile(user) {
      const payload = {
        id: user.id,
        username: user.user_metadata?.full_name?.split(" ")?.[0] || user.email.split("@")[0],
        email: user.email,
        avatar_url: user.user_metadata?.avatar_url ?? null
      };
      const { error } = await supabase.from("users").upsert(payload, { onConflict: "id" });
      if (error) throw error;
    }

    async function fetchProfile(userId) {
      const { data, error } = await supabase.from("users").select("username, is_admin").eq("id", userId).single();
      if (error && error.code !== "PGRST116") throw error;
      return data;
    }

    function redirectAfterLogin(profile) {
      if (redirectTriggered) return;
      const destination = profile?.is_admin ? "admin.html" : "index.html";
      const current = window.location.pathname.split("/").pop();
      if (current === destination) return;
      redirectTriggered = true;
      if (sessionStatus) sessionStatus.textContent = "Redirecionando...";
      window.location.href = destination;
    }

    function configureHeaderButton(isLogged) {
      if (!headerAuthBtn) return;
      headerAuthBtn.disabled = false;
      if (isLogged) {
        headerAuthBtn.textContent = "Sair";
        headerAuthBtn.onclick = async () => {
          try {
            ensureClient();
            headerAuthBtn.disabled = true;
            await supabase.auth.signOut();
            setStatus(false, "Sessão encerrada");
            if (sessionStatus) sessionStatus.textContent = "Sessão encerrada.";
            if (profileInfo) profileInfo.textContent = "Faça login para carregar seu perfil.";
            redirectTriggered = false;
            await refreshSession();
          } catch (err) {
            console.error(err);
            headerAuthBtn.disabled = false;
          }
        };
      } else {
      headerAuthBtn.textContent = "Entrar";
      headerAuthBtn.onclick = () => googleBtn.click();
      }
    }

    async function refreshSession() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        let session = data.session;
        if (!session) {
          session = await restoreSessionFromStorage();
        }
        if (session?.user) {
          const user = session.user;
          await upsertProfile(user);
          const profile = await fetchProfile(user.id);
          setStatus(true, "Sessão ativa");
          if (sessionStatus) sessionStatus.textContent = `Logado como ${user.email}`;
          if (profileInfo) {
            profileInfo.textContent = profile
              ? `Perfil carregado: ${profile.username} ${profile.is_admin ? "(admin)" : ""}`
              : "Perfil não encontrado.";
          }
          configureHeaderButton(true);
          redirectAfterLogin(profile);
        } else {
          setStatus(false, "Sem sessão");
          if (sessionStatus) sessionStatus.textContent = "Sem sessão.";
          if (profileInfo) profileInfo.textContent = "Faça login para carregar seu perfil.";
          configureHeaderButton(false);
        }
      } catch (err) {
        console.error(err);
        setStatus(false, "Erro");
        if (sessionStatus) sessionStatus.textContent = err?.message || "Erro ao checar sessão.";
      }
    }

    googleBtn.addEventListener("click", async () => {
      try {
        ensureClient();
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: window.location.origin + "/login.html" }
        });
        if (error) throw error;
      } catch (err) {
        console.error(err);
        alert(err?.message || "Falha no OAuth.");
      }
    });

    try {
      ensureClient();
      refreshSession();
    } catch (err) {
      console.warn(err.message);
    }
  </script>
</body>
</html>
