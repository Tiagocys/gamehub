<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Login</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Kanit:wght@500;600;700&display=swap');

    :root {
      --bg: #f4f7ff;
      --card: #ffffff;
      --muted: #5f6f8c;
      --text: #0f2557;
      --accent: #1b4fd3;
      --accent-2: #4e7dff;
      --border: rgba(15, 37, 87, 0.08);
      --radius: 16px;
      --shadow: 0 20px 45px rgba(15, 37, 87, 0.12);
    }
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background:
        radial-gradient(circle at 15% 20%, rgba(27, 79, 211, 0.08), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(78, 125, 255, 0.08), transparent 40%),
        linear-gradient(140deg, #f8faff 0%, #eef2fb 55%, #f9fbff 100%);
      color: var(--text);
      font-family: "Space Grotesk", "Kanit", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .login-page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 20px 34px;
      display: grid;
      gap: 14px;
      width: 100%;
      flex: 1 0 auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand a {
      display: inline-flex;
      align-items: center;
    }

    .brand img {
      width: 122px;
      height: auto;
    }

    .brand-tag {
      padding: 5px 11px;
      border-radius: 999px;
      background: rgba(27,79,211,0.1);
      color: var(--accent-2);
      font-size: 13px;
      border: 1px solid var(--border);
    }

    .auth-top {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
    }

    .auth-top h1 {
      margin: 0;
      font-size: clamp(24px, 4vw, 34px);
      line-height: 1;
      font-family: "Kanit", "Space Grotesk", sans-serif;
      letter-spacing: -0.02em;
    }

    .auth-top p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .auth-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 14px;
      flex-wrap: wrap;
    }

    .cards-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .site-footer-login {
      max-width: 1120px;
      margin: 0 auto 16px;
      padding: 0 20px;
      display: grid;
      gap: 10px;
    }

    .site-footer-login nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .site-footer-login a {
      display: inline-flex;
      align-items: center;
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 12px;
      font-weight: 700;
      text-decoration: none;
    }

    .site-footer-login p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .feature-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .feature-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(140deg, rgba(27,79,211,0.12), transparent 55%);
      pointer-events: none;
    }

    .feature-card > * {
      position: relative;
      z-index: 1;
    }

    .feature-card h2 {
      margin: 0 0 10px;
      font-size: 24px;
      line-height: 1;
      font-family: "Kanit", "Space Grotesk", sans-serif;
      letter-spacing: -0.02em;
    }

    .feature-card p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    button {
      padding: 12px 16px;
      border: none;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s;
      color: #f8fbff;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 24px rgba(27,79,211,0.25);
    }

    .google-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .google-btn img {
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      padding: 3px;
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    button:active { transform: translateY(1px); }

    .page-loader {
      position: fixed;
      inset: 0;
      background: #ffffff;
      z-index: 9999;
      display: grid;
      place-items: center;
    }
    .page-loader.hidden { display: none; }
    .page-loader img { width: 120px; height: auto; }

    @media (max-width: 640px) {
      .login-page {
        padding-top: 14px;
        padding-bottom: 22px;
      }
      .auth-top {
        padding: 14px;
      }
      .auth-top h1 {
        font-size: 26px;
      }
      .feature-card h2 {
        font-size: 22px;
      }
      button {
        width: 100%;
      }
      .auth-row {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <main class="login-page">
    <div class="brand">
      <a href="index.html" aria-label="Ir para a página inicial">
        <img src="img/logo.png" alt="Gimerr" />
      </a>
      <span class="brand-tag">Login</span>
    </div>

    <section class="auth-top">
      <h1>Entre na sua conta</h1>
      <p>Use sua conta Google para começar a anunciar.</p>
      <div class="auth-row">
        <button id="google-btn" class="google-btn">
          <img src="img/google.svg" alt="" />
          Entrar com Google
        </button>
      </div>
    </section>

    <section class="cards-grid">
      <article class="feature-card">
        <h2>Play to earn</h2>
        <p>Anuncie itens, contas e personagens do seu game favorito! Ofereça serviços no maior marketplace para gamers que já existiu!</p>
      </article>
      <article class="feature-card">
        <h2>Pay to win</h2>
        <p>Encontre tudo que você precisa para ser o top server no seu jogo!</p>
      </article>
    </section>
  </main>

  <footer class="site-footer-login">
    <p>Community marketplace powered by gamers.</p>
    <nav aria-label="Links úteis">
      <a href="index.html">Início</a>
      <a href="game-submit.html">Cadastrar game</a>
      <a href="listing-create.html">Criar anúncio</a>
      <a href="my-listings.html">Meus anúncios</a>
      <a href="profile.html">Meu perfil</a>
      <a href="partner.html">Área de parceiros</a>
      <a href="politica-anuncios.html">Política de anúncios</a>
      <a href="parcerias.html">Termos de uso</a>
    </nav>
  </footer>

  <script src="env.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";

    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let avatarReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !avatarReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });

    const googleBtn = document.getElementById("google-btn");

    const SESSION_STORAGE_KEY = "gimerr-auth-session";
    let supabase;
    let authListenerAttached = false;
    let redirectTriggered = false;

    function setStatus(_ok, _text) {}

    function persistLocalSession(session) {
      if (session) {
        localStorage.setItem(
          SESSION_STORAGE_KEY,
          JSON.stringify({
            access_token: session.access_token,
            refresh_token: session.refresh_token,
          }),
        );
      } else {
        localStorage.removeItem(SESSION_STORAGE_KEY);
      }
    }

    async function restoreSessionFromStorage() {
      const raw = localStorage.getItem(SESSION_STORAGE_KEY);
      if (!raw) return null;
      try {
        const saved = JSON.parse(raw);
        if (!saved.access_token || !saved.refresh_token) return null;
        const { data, error } = await supabase.auth.setSession({
          access_token: saved.access_token,
          refresh_token: saved.refresh_token,
        });
        if (error) {
          console.error(error);
          localStorage.removeItem(SESSION_STORAGE_KEY);
          return null;
        }
        return data.session;
      } catch (err) {
        console.error(err);
        localStorage.removeItem(SESSION_STORAGE_KEY);
        return null;
      }
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        setStatus(false, "Defina SUPABASE_URL e SUPABASE_ANON_KEY em public/env.js");
        throw new Error("Supabase URL/key não configurados");
      }
      supabase = supabase || createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storageKey: "gimerr-auth-token",
        },
      });
      if (!authListenerAttached) {
        supabase.auth.onAuthStateChange((_event, session) => {
          persistLocalSession(session);
          refreshSession();
        });
        authListenerAttached = true;
      }
      return supabase;
    }

    function parseUserName(user) {
      const meta = user.user_metadata || {};
      const given = meta.given_name || meta.first_name || null;
      const family = meta.family_name || meta.last_name || null;
      if (given || family) {
        return { firstName: given || "", lastName: family || "" };
      }
      const full = meta.full_name || meta.name || "";
      if (!full) return { firstName: "", lastName: "" };
      const parts = full.trim().split(/\s+/);
      if (parts.length === 1) return { firstName: parts[0], lastName: "" };
      return { firstName: parts[0], lastName: parts.slice(1).join(" ") };
    }

    function baseUsernameFromUser(user) {
      const fromName = user.user_metadata?.full_name?.split(" ")?.[0];
      if (fromName) return fromName.toLowerCase();
      return user.email.split("@")[0].toLowerCase();
    }

    function isMissingStatusColumnError(error) {
      if (!error) return false;
      return error.code === "42703" || String(error.message || "").toLowerCase().includes("status");
    }

    async function upsertProfile(user) {
      const names = parseUserName(user);
      const baseUsername = baseUsernameFromUser(user);
      let existingProfile = null;
      let hasStatusColumn = true;

      const existingWithStatus = await supabase
        .from("users")
        .select("username,status")
        .eq("id", user.id)
        .maybeSingle();
      if (existingWithStatus.error) {
        if (isMissingStatusColumnError(existingWithStatus.error)) {
          hasStatusColumn = false;
          const fallback = await supabase
            .from("users")
            .select("username")
            .eq("id", user.id)
            .maybeSingle();
          if (fallback.error && fallback.error.code !== "PGRST116") throw fallback.error;
          existingProfile = fallback.data || null;
        } else if (existingWithStatus.error.code !== "PGRST116") {
          throw existingWithStatus.error;
        }
      } else {
        existingProfile = existingWithStatus.data || null;
      }

      const normalizedBase = (baseUsername || "user").replace(/[^a-z0-9._-]/g, "").slice(0, 32) || "user";
      const candidates = Array.from(new Set([
        existingProfile?.username || "",
        normalizedBase,
        `${normalizedBase}-${Math.floor(Math.random() * 9000 + 1000)}`,
        `${normalizedBase}-${crypto.randomUUID().slice(0, 6)}`,
      ].filter(Boolean)));

      const nextStatus = existingProfile?.status === "banned" ? "banned" : "active";

      let lastError = null;
      for (const candidate of candidates) {
        const payload = {
          id: user.id,
          username: candidate,
          email: user.email,
          avatar_url: user.user_metadata?.avatar_url ?? user.user_metadata?.picture ?? null,
          first_name: names.firstName || null,
          last_name: names.lastName || null,
        };
        if (hasStatusColumn) {
          payload.status = nextStatus;
        }
        const { error } = await supabase.from("users").upsert(payload, { onConflict: "id" });
        if (!error) return;
        if (hasStatusColumn && isMissingStatusColumnError(error)) {
          hasStatusColumn = false;
          delete payload.status;
          const retry = await supabase.from("users").upsert(payload, { onConflict: "id" });
          if (!retry.error) return;
          if (retry.error.code !== "23505") {
            throw retry.error;
          }
          lastError = retry.error;
          continue;
        }
        if (error.code !== "23505") {
          throw error;
        }
        lastError = error;
      }
      if (lastError) throw lastError;
    }

    async function fetchProfile(userId) {
      const { data, error } = await supabase.from("users").select("username, is_admin").eq("id", userId).single();
      if (error && error.code !== "PGRST116") throw error;
      return data;
    }

    function redirectAfterLogin(profile) {
      if (redirectTriggered) return;
      const destination = profile?.is_admin ? "admin.html" : "index.html";
      const current = window.location.pathname.split("/").pop();
      if (current === destination) return;
      redirectTriggered = true;
      window.location.href = destination;
    }

    async function refreshSession() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        let session = data.session;
        if (!session) {
          session = await restoreSessionFromStorage();
        }
        if (session?.user) {
          const user = session.user;
          await upsertProfile(user);
          const profile = await fetchProfile(user.id);
          setStatus(true, "Sessão ativa");
          redirectAfterLogin(profile);
        } else {
          setStatus(false, "Sem sessão");
        }
      } catch (err) {
        console.error(err);
        setStatus(false, "Erro");
      } finally {
        markAvatarReady();
      }
    }

    googleBtn.addEventListener("click", async () => {
      try {
        ensureClient();
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: window.location.origin + "/login.html" }
        });
        if (error) throw error;
      } catch (err) {
        console.error(err);
        alert(err?.message || "Falha no OAuth.");
      }
    });

    try {
      ensureClient();
      refreshSession();
    } catch (err) {
      console.warn(err.message);
    }
  </script>
</body>
</html>
