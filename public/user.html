<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Perfil público</title>
  <link rel="stylesheet" href="css/global.css" />
  <style id="user-guard-style">html{visibility:hidden;}</style>
  <style>
    .user-public-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: minmax(0, 1fr);
      align-items: start;
    }

    .user-public-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 16px;
      align-items: center;
      position: relative;
    }

    .user-public-avatar {
      width: 92px;
      height: 92px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: #fff;
      display: block;
    }

    .user-public-copy {
      display: grid;
      gap: 8px;
      min-width: 0;
    }

    .user-public-name {
      font-size: clamp(22px, 3vw, 30px);
      line-height: 1.15;
      word-break: break-word;
    }

    .user-public-reco {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    .recommend-count-btn {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      text-decoration: none;
      color: #0ea5e9;
    }

    .recommend-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--ink);
      font-weight: 700;
      padding: 10px 14px;
      cursor: pointer;
    }

    .recommend-btn[disabled] {
      opacity: 0.7;
      cursor: default;
    }

    .recommend-icon {
      width: 18px;
      height: 18px;
      object-fit: contain;
      display: block;
    }

    .recommenders-modal {
      position: fixed;
      inset: 0;
      z-index: 12000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(12, 21, 51, 0.56);
    }

    .recommenders-modal.open {
      display: flex;
    }

    .recommenders-modal-card {
      width: min(560px, 100%);
      max-height: min(80vh, 640px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .recommenders-modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }

    .recommenders-modal-head h3 {
      font-size: 18px;
    }

    .recommenders-modal-close {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .recommenders-wrap {
      overflow-y: auto;
      display: grid;
      gap: 0;
    }

    .recommender-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: var(--ink);
    }

    .recommender-item:last-child {
      border-bottom: none;
    }

    .recommender-item:hover {
      background: rgba(14, 165, 233, 0.08);
    }

    .recommender-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      object-fit: cover;
      background: #fff;
      display: block;
    }

    .recommender-name {
      font-weight: 700;
      font-size: 13px;
      line-height: 1.2;
    }

    .recommenders-empty {
      padding: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .recommenders-loading {
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--border);
      background: rgba(12, 21, 51, 0.02);
    }

    .user-public-games {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .user-public-about {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .user-contact-trigger {
      padding: 8px 14px;
      font-size: 13px;
    }

    .user-card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 2;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .user-contact-corner {
      position: static;
      z-index: auto;
    }

    .user-contact-panel {
      margin-top: 6px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(12, 21, 51, 0.02);
      display: grid;
      gap: 8px;
    }

    .user-contact-discord {
      margin: 0;
      font-size: 13px;
      color: var(--ink);
      font-weight: 700;
      word-break: break-word;
    }

    .discord-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      font-weight: 700;
      color: var(--ink);
      word-break: break-word;
    }

    .discord-inline-icon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      display: block;
    }

    .report-trigger {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .report-icon-btn {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
    }

    .report-icon-btn:hover {
      background: rgba(12, 21, 51, 0.05);
    }

    .report-icon {
      width: 16px;
      height: 16px;
      object-fit: contain;
      display: block;
    }

    .report-form {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(12, 21, 51, 0.03);
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .report-form textarea {
      min-height: 92px;
      resize: vertical;
    }

    .report-feedback {
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
    }

    .user-listings-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .user-listings-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

    .user-listings-grid .listing-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(12, 21, 51, 0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      height: 100%;
      text-decoration: none;
      color: var(--ink);
      transition: transform 0.12s ease, box-shadow 0.2s ease;
    }

    .user-listings-grid .listing-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 28px rgba(12, 21, 51, 0.1);
    }

    .user-listings-grid .listing-media {
      height: auto;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow: hidden;
      display: grid;
      place-items: center;
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
      background: radial-gradient(circle at 20% 20%, rgba(27,79,211,0.08), rgba(15,37,87,0.02));
    }

    .user-listings-grid .listing-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .user-listing-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .user-listings-grid .listing-body {
      padding: 0;
      gap: 6px;
      display: grid;
    }

    .user-listings-grid .listing-body h3 {
      font-size: 13px;
      line-height: 1.2;
      margin: 0;
      font-weight: 700;
      min-height: 30px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .user-listings-grid .listing-server {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      line-height: 1.2;
    }

    .user-listings-grid .listing-body .helper {
      font-size: 12px;
      line-height: 1.2;
    }

    @media (min-width: 980px) {
      .user-public-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .user-public-card,
      .user-listings-card,
      #public-feedback {
        grid-column: 1 / -1;
      }

      .user-about-card {
        grid-column: 1;
      }

      .user-games-card {
        grid-column: 2;
      }
    }

    @media (max-width: 700px) {
      .user-public-card {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script>
    (() => {
      try {
        const hasSession = localStorage.getItem("gimerr-auth-token") || localStorage.getItem("gimerr-auth-session");
        if (!hasSession) {
          window.location.replace("login.html");
        }
      } catch (_err) {
        window.location.replace("login.html");
      }
    })();
  </script>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <site-navbar></site-navbar>

    <main class="section user-public-grid">
      <section class="user-public-card">
        <img id="public-avatar" class="user-public-avatar" src="img/avatar.svg" alt="Foto do usuário" />
        <div class="user-card-actions">
          <button id="contact-toggle-btn" class="btn btn-ghost user-contact-trigger user-contact-corner" type="button" style="display:none;">conversar</button>
          <button id="report-user-btn" class="report-icon-btn" type="button" style="display:none;" aria-label="Denunciar perfil">
            <img src="img/flag.png" alt="" class="report-icon" />
          </button>
        </div>
        <div class="user-public-copy">
          <h1 id="public-name" class="user-public-name">Carregando perfil...</h1>
          <p id="public-discord" class="helper discord-inline" style="display:none;"></p>
          <div class="inline-actions">
            <button id="recommend-btn" class="recommend-btn" type="button" style="display:none;">
              <img src="img/rec.png" alt="" class="recommend-icon" />
              Recomendar usuário
            </button>
            <button id="recommend-count" class="user-public-reco recommend-count-btn" type="button" aria-expanded="false">0 recomendações</button>
          </div>
          <div id="report-user-form" class="report-form" style="display:none;">
            <label for="report-user-reason">Descreva o problema</label>
            <textarea id="report-user-reason" placeholder="Explique por que este perfil deve ser analisado."></textarea>
            <label for="report-user-files">Anexos (opcional, até 4 imagens)</label>
            <input id="report-user-files" class="input" type="file" accept="image/*" multiple />
            <div id="report-user-files-info" class="helper">Nenhuma imagem selecionada.</div>
            <div class="inline-actions">
              <button id="report-user-submit" class="btn btn-primary" type="button">Enviar denúncia</button>
              <button id="report-user-cancel" class="btn btn-ghost" type="button">Cancelar</button>
            </div>
            <div id="report-user-feedback" class="report-feedback"></div>
          </div>
          <div id="contact-panel" class="user-contact-panel" style="display:none;">
            <p id="contact-discord" class="user-contact-discord" style="display:none;"></p>
            <div class="inline-actions">
              <a id="contact-telegram" class="btn btn-telegram" href="#" target="_blank" rel="noopener" style="display:none;">
                Conversar via Telegram
                <img src="img/telegram.webp" alt="" class="btn-icon" />
              </a>
              <a id="contact-whatsapp" class="btn btn-whatsapp" href="#" target="_blank" rel="noopener" style="display:none;">
                Conversar via WhatsApp
                <img src="img/wtsp.png" alt="" class="btn-icon" />
              </a>
            </div>
          </div>
          <p id="self-profile-hint" class="helper" style="display:none;">
            Este é seu perfil público.
          </p>
          <a id="edit-profile-btn" class="btn btn-ghost" href="profile.html" style="display:none;">Editar perfil</a>
        </div>
      </section>

      <section class="hero-card user-about-card">
        <h3>Sobre mim</h3>
        <p id="public-about" class="helper user-public-about">Sem informações adicionais.</p>
      </section>

      <section class="hero-card user-games-card">
        <h3>Games com anúncios deste usuário</h3>
        <div id="public-games" class="user-public-games"></div>
        <p id="public-games-empty" class="helper" style="display:none;">Nenhum game vinculado ainda.</p>
      </section>

      <section class="hero-card user-listings-card">
        <div class="user-listings-header">
          <h3>Anúncios ativos</h3>
          <p id="public-listings-count" class="helper"></p>
        </div>
        <div id="public-listings" class="listing-grid user-listings-grid"></div>
        <p id="public-listings-empty" class="helper" style="display:none;">Este usuário ainda não possui anúncios ativos.</p>
      </section>
      <p id="public-feedback" class="helper"></p>
    </main>

    <site-footer></site-footer>
  </div>
  <div id="recommenders-modal" class="recommenders-modal" aria-hidden="true">
    <div class="recommenders-modal-card">
      <div class="recommenders-modal-head">
        <h3>Usuários que recomendaram</h3>
        <button id="recommenders-modal-close" class="recommenders-modal-close" type="button" aria-label="Fechar">×</button>
      </div>
      <div id="recommenders-wrap" class="recommenders-wrap">
        <div id="recommenders-list"></div>
        <div id="recommenders-loading" class="recommenders-loading" style="display:none;">Carregando mais perfis...</div>
      </div>
      <p id="recommenders-empty" class="recommenders-empty" style="display:none;">Nenhuma recomendação ainda.</p>
    </div>
  </div>

  <script src="env.js"></script>
  <script src="js/site-navbar.js"></script>
  <script src="js/site-footer.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    await (window.__NAVBAR_READY__ || Promise.resolve());

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
    const R2_PUBLIC_URL = env.R2_PUBLIC_URL || "";
    const R2_BUCKET = env.R2_BUCKET || "";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const createListingBtn = document.getElementById("create-listing-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const profileLink = document.getElementById("profile-link");

    const publicAvatar = document.getElementById("public-avatar");
    const publicName = document.getElementById("public-name");
    const publicDiscord = document.getElementById("public-discord");
    const publicAbout = document.getElementById("public-about");
    const publicGames = document.getElementById("public-games");
    const publicGamesEmpty = document.getElementById("public-games-empty");
    const publicListings = document.getElementById("public-listings");
    const publicListingsCount = document.getElementById("public-listings-count");
    const publicListingsEmpty = document.getElementById("public-listings-empty");
    const recommendBtn = document.getElementById("recommend-btn");
    const reportUserBtn = document.getElementById("report-user-btn");
    const reportUserForm = document.getElementById("report-user-form");
    const reportUserReason = document.getElementById("report-user-reason");
    const reportUserFiles = document.getElementById("report-user-files");
    const reportUserFilesInfo = document.getElementById("report-user-files-info");
    const reportUserSubmit = document.getElementById("report-user-submit");
    const reportUserCancel = document.getElementById("report-user-cancel");
    const reportUserFeedback = document.getElementById("report-user-feedback");
    const contactToggleBtn = document.getElementById("contact-toggle-btn");
    const contactPanel = document.getElementById("contact-panel");
    const contactDiscord = document.getElementById("contact-discord");
    const contactTelegram = document.getElementById("contact-telegram");
    const contactWhatsapp = document.getElementById("contact-whatsapp");
    const recommendCount = document.getElementById("recommend-count");
    const recommendersModal = document.getElementById("recommenders-modal");
    const recommendersModalClose = document.getElementById("recommenders-modal-close");
    const recommendersWrap = document.getElementById("recommenders-wrap");
    const recommendersList = document.getElementById("recommenders-list");
    const recommendersLoadingEl = document.getElementById("recommenders-loading");
    const recommendersEmpty = document.getElementById("recommenders-empty");
    const selfProfileHint = document.getElementById("self-profile-hint");
    const editProfileBtn = document.getElementById("edit-profile-btn");
    const feedback = document.getElementById("public-feedback");

    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let navAvatarReady = false;
    let contentReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !navAvatarReady || !contentReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markNavAvatarReady() {
      navAvatarReady = true;
      hideLoader();
    }

    function markContentReady() {
      contentReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });

    let supabase;
    let currentUser = null;
    let currentUserProfile = null;
    let targetUserId = null;
    let recommendationGiven = false;
    let recommendersOffset = 0;
    let recommendersHasMore = true;
    let recommendersLoading = false;
    let recommendersFetched = false;
    let contactPanelVisible = false;
    let currentPublicProfile = null;
    const RECOMMENDERS_PAGE_SIZE = 8;
    const REPORT_MAX_ATTACHMENTS = 4;
    const REPORT_MAX_FILE_BYTES = 6 * 1024 * 1024;
    const REPORT_MAX_DIMENSION = 1600;
    const REPORT_WEBP_QUALITY = 0.82;
    if (avatarImg) avatarImg.referrerPolicy = "no-referrer";
    if (publicAvatar) publicAvatar.referrerPolicy = "no-referrer";

    function revealPage() {
      document.documentElement.style.visibility = "visible";
      const guard = document.getElementById("user-guard-style");
      if (guard) guard.remove();
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        feedback.textContent = "Supabase não configurado.";
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          currentUserProfile = null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        if (profileLink) profileLink.href = `user.html?id=${encodeURIComponent(currentUser.id)}`;
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        loadUserAvatar();
        return;
      }
      currentUserProfile = null;
      authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (profileLink) profileLink.href = "profile.html";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      markNavAvatarReady();
    }

    function getReportFiles() {
      return Array.from(reportUserFiles?.files || []).slice(0, REPORT_MAX_ATTACHMENTS);
    }

    function updateReportFilesInfo() {
      if (!reportUserFilesInfo) return;
      const rawCount = reportUserFiles?.files?.length || 0;
      if (rawCount === 0) {
        reportUserFilesInfo.textContent = "Nenhuma imagem selecionada.";
        return;
      }
      if (rawCount > REPORT_MAX_ATTACHMENTS) {
        reportUserFilesInfo.textContent = `Você selecionou ${rawCount} imagens. Serão enviadas apenas ${REPORT_MAX_ATTACHMENTS}.`;
        return;
      }
      reportUserFilesInfo.textContent = `${rawCount} imagem(ns) selecionada(s).`;
    }

    async function convertImageToWebp(file) {
      if (!file?.type || !file.type.startsWith("image/")) {
        throw new Error("Selecione apenas imagens válidas nos anexos.");
      }
      if (file.size > REPORT_MAX_FILE_BYTES) {
        throw new Error("Cada imagem anexa deve ter no máximo 6MB.");
      }
      const bitmap = await createImageBitmap(file);
      const maxSide = Math.max(bitmap.width, bitmap.height);
      const scale = Math.min(1, REPORT_MAX_DIMENSION / maxSide);
      const canvas = document.createElement("canvas");
      canvas.width = Math.max(1, Math.round(bitmap.width * scale));
      canvas.height = Math.max(1, Math.round(bitmap.height * scale));
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("Falha ao processar imagem anexa.");
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/webp", REPORT_WEBP_QUALITY));
      if (!blob) throw new Error("Falha ao converter anexo para WebP.");
      const baseName = file.name.replace(/\.[^.]+$/, "") || "report";
      return new File([blob], `${baseName}.webp`, { type: "image/webp" });
    }

    async function requestReportSignedUpload(file) {
      ensureClient();
      const { data } = await supabase.auth.getSession();
      const token = data.session?.access_token;
      if (!token) throw new Error("Sessão expirada. Faça login novamente.");

      const extension = (file.name.split(".").pop() || "").toLowerCase();
      const response = await fetch(`${SUPABASE_URL}/functions/v1/r2_sign_upload`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          apikey: SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({
          contentType: file.type || "application/octet-stream",
          extension,
          userToken: token,
          assetType: "report",
        }),
      });
      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        throw new Error(payload?.error || "Erro ao solicitar upload de anexo.");
      }
      return response.json();
    }

    async function uploadReportEvidence(files, onProgress) {
      const uploaded = [];
      for (let index = 0; index < files.length; index += 1) {
        const webp = await convertImageToWebp(files[index]);
        const signed = await requestReportSignedUpload(webp);
        const uploadRes = await fetch(signed.uploadUrl, {
          method: "PUT",
          headers: {
            "Content-Type": webp.type || "application/octet-stream",
          },
          body: webp,
        });
        if (!uploadRes.ok) throw new Error("Falha ao enviar anexo da denúncia.");
        uploaded.push(signed.publicUrl);
        if (typeof onProgress === "function") onProgress(index + 1, files.length);
      }
      return uploaded.filter(Boolean);
    }

    async function setAvatarImage(target, src) {
      if (!target) return;
      const finalSrc = src || "img/avatar.svg";
      target.src = finalSrc;
      try {
        await target.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          target.src = "img/avatar.svg";
          try {
            await target.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      }
    }

    async function loadUserAvatar() {
      if (!avatarImg || !currentUser) return;
      try {
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatarImg, avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatarImg, avatar);
        } catch (_innerErr) {
          await setAvatarImage(avatarImg, "img/avatar.svg");
        }
      } finally {
        markNavAvatarReady();
      }
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
      }
    }

    function formatDate(value) {
      try {
        return new Intl.DateTimeFormat("pt-BR", { dateStyle: "medium" }).format(new Date(value));
      } catch (_err) {
        return "";
      }
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const parts = rest.split("/");
        if (parts.length === 0) return null;
        let bucket = parts[0];
        let pathParts = parts.slice(1);
        if (bucket === "public" || bucket === "authenticated" || bucket === "sign") {
          bucket = parts[1];
          pathParts = parts.slice(2);
        }
        if (!bucket || pathParts.length === 0) return null;
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    function normalizeR2PublicUrl(urlString) {
      try {
        const url = new URL(urlString);
        if (R2_PUBLIC_URL) {
          const publicHost = new URL(R2_PUBLIC_URL).host;
          if (url.hostname.endsWith(".r2.dev") && url.hostname !== publicHost) {
            return `${R2_PUBLIC_URL.replace(/\/$/, "")}${url.pathname}`;
          }
        }
        if (!url.hostname.endsWith(".r2.cloudflarestorage.com")) return urlString;
        const parts = url.pathname.split("/").filter(Boolean);
        if (parts.length === 0) return urlString;
        const accountId = url.hostname.split(".")[0];
        let bucket = R2_BUCKET;
        let keyParts = parts;
        if (bucket) {
          if (parts[0] === bucket) {
            keyParts = parts.slice(1);
          }
        } else {
          bucket = parts[0];
          keyParts = parts.slice(1);
        }
        if (!bucket || keyParts.length === 0) return urlString;
        const base = R2_PUBLIC_URL ? R2_PUBLIC_URL.replace(/\/$/, "") : `https://${bucket}.${accountId}.r2.dev`;
        return `${base}/${keyParts.join("/")}`;
      } catch (_err) {
        return urlString;
      }
    }

    async function resolveImageUrl(urlString) {
      if (!urlString) return urlString;
      const normalized = normalizeR2PublicUrl(urlString);
      if (!normalized.includes(SUPABASE_URL) || !normalized.includes("/storage/v1/object/")) {
        return normalized;
      }
      const parsed = parseStoragePath(normalized);
      if (!parsed) return normalized;
      try {
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 3);
        if (error) throw error;
        return data?.signedUrl || normalized;
      } catch (_err) {
        return normalized;
      }
    }

    async function resolveImageUrls(images) {
      const list = Array.isArray(images) ? images : [];
      const resolved = await Promise.all(list.map((url) => resolveImageUrl(url)));
      return resolved.filter(Boolean);
    }

    function getServerFromListing(listing) {
      const serverData = Array.isArray(listing?.servers) ? listing.servers[0] : listing?.servers;
      return {
        id: serverData?.id || listing?.server_id || null,
        name: serverData?.name || "Servidor",
      };
    }

    async function fetchPublicProfile() {
      const { data, error } = await supabase
        .from("users")
        .select("id,status,first_name,last_name,discord_username,about_me,avatar_url,phone,phone_verified,show_whatsapp_button,show_contacts_on_public_profile")
        .eq("id", targetUserId)
        .single();
      if (error) throw error;
      return data;
    }

    async function fetchCurrentUserProfile() {
      if (!currentUser?.id) return null;
      const { data, error } = await supabase
        .from("users")
        .select("id,phone_verified")
        .eq("id", currentUser.id)
        .maybeSingle();
      if (error && error.code !== "PGRST116") throw error;
      return data || null;
    }

    async function fetchUserListings() {
      try {
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,status,created_at,server_id,categories,category,servers(id,name)")
          .eq("user_id", targetUserId)
          .order("created_at", { ascending: false });
        if (error) throw error;
        const withImages = await Promise.all((data || []).map(async (listing) => ({
          ...listing,
          images: await resolveImageUrls(listing.images),
        })));
        return withImages;
      } catch (_err) {
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,status,created_at,server_id,categories,category")
          .eq("user_id", targetUserId)
          .order("created_at", { ascending: false });
        if (error) throw error;
        const serverIds = Array.from(new Set((data || []).map((item) => item.server_id).filter(Boolean)));
        let serverMap = new Map();
        if (serverIds.length > 0) {
          const { data: serversData } = await supabase
            .from("servers")
            .select("id,name")
            .in("id", serverIds);
          serverMap = new Map((serversData || []).map((server) => [server.id, server]));
        }
        const withImages = await Promise.all((data || []).map(async (listing) => ({
          ...listing,
          servers: serverMap.get(listing.server_id) || null,
          images: await resolveImageUrls(listing.images),
        })));
        return withImages;
      }
    }

    async function fetchRecommendationState() {
      const countPromise = supabase
        .from("recommendations")
        .select("id", { count: "exact", head: true })
        .eq("user_id", targetUserId);
      const votePromise = currentUser && currentUser.id !== targetUserId
        ? supabase
            .from("recommendations")
            .select("id")
            .eq("user_id", targetUserId)
            .eq("author_id", currentUser.id)
            .maybeSingle()
        : Promise.resolve({ data: null, error: null });

      const [{ count, error: countError }, { data: voteData, error: voteError }] = await Promise.all([countPromise, votePromise]);
      if (countError) throw countError;
      if (voteError && voteError.code !== "PGRST116") throw voteError;
      return {
        total: count || 0,
        didRecommend: !!voteData?.id,
      };
    }

    function renderRecommendersEmpty(show) {
      if (recommendersEmpty) {
        recommendersEmpty.style.display = show ? "block" : "none";
      }
      if (recommendersWrap) {
        recommendersWrap.style.display = show ? "none" : "block";
      }
    }

    function openRecommendersModal() {
      if (!recommendersModal) return;
      recommendersModal.classList.add("open");
      recommendersModal.setAttribute("aria-hidden", "false");
      document.body.classList.add("no-scroll");
      if (recommendCount) {
        recommendCount.setAttribute("aria-expanded", "true");
      }
    }

    function closeRecommendersModal() {
      if (!recommendersModal) return;
      recommendersModal.classList.remove("open");
      recommendersModal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("no-scroll");
      if (recommendCount) {
        recommendCount.setAttribute("aria-expanded", "false");
      }
    }

    function setRecommendersLoading(show) {
      if (recommendersLoadingEl) {
        recommendersLoadingEl.style.display = show ? "block" : "none";
      }
    }

    function appendRecommenderItem(rating, user) {
      if (!recommendersList) return;
      const link = document.createElement("a");
      link.className = "recommender-item";
      link.href = `user.html?id=${encodeURIComponent(rating.author_id)}`;

      const avatar = document.createElement("img");
      avatar.className = "recommender-avatar";
      avatar.src = user?.avatar_url || "img/avatar.svg";
      avatar.alt = "Avatar do usuário";
      avatar.referrerPolicy = "no-referrer";
      avatar.loading = "lazy";
      avatar.addEventListener("error", () => {
        avatar.src = "img/avatar.svg";
      });

      const copy = document.createElement("div");
      const firstName = (user?.first_name || "").trim();
      const lastName = (user?.last_name || "").trim();
      const fullName = `${firstName} ${lastName}`.trim() || "Usuário da comunidade";
      const nameEl = document.createElement("div");
      nameEl.className = "recommender-name";
      nameEl.textContent = fullName;
      copy.appendChild(nameEl);

      link.appendChild(avatar);
      link.appendChild(copy);
      recommendersList.appendChild(link);
    }

    async function loadMoreRecommenders({ reset = false } = {}) {
      if (!targetUserId || recommendersLoading) return;
      if (!reset && !recommendersHasMore) return;

      if (reset) {
        recommendersOffset = 0;
        recommendersHasMore = true;
        if (recommendersList) recommendersList.innerHTML = "";
      }

      recommendersLoading = true;
      setRecommendersLoading(true);
      try {
        const from = recommendersOffset;
        const to = recommendersOffset + RECOMMENDERS_PAGE_SIZE - 1;
        const { data, error } = await supabase
          .from("recommendations")
          .select("id,author_id,created_at")
          .eq("user_id", targetUserId)
          .order("created_at", { ascending: false })
          .range(from, to);
        if (error) throw error;

        const rows = data || [];
        if (reset && rows.length === 0) {
          renderRecommendersEmpty(true);
          recommendersHasMore = false;
          return;
        }

        renderRecommendersEmpty(false);
        recommendersOffset += rows.length;
        if (rows.length < RECOMMENDERS_PAGE_SIZE) {
          recommendersHasMore = false;
        }

        const authorIds = Array.from(new Set(rows.map((row) => row.author_id).filter(Boolean)));
        let usersMap = new Map();
        if (authorIds.length > 0) {
          const { data: usersData, error: usersError } = await supabase
            .from("users")
            .select("id,first_name,last_name,avatar_url")
            .in("id", authorIds);
          if (usersError) throw usersError;
          usersMap = new Map((usersData || []).map((user) => [user.id, user]));
        }

        rows.forEach((row) => {
          appendRecommenderItem(row, usersMap.get(row.author_id));
        });
      } catch (err) {
        console.error(err);
        feedback.textContent = err?.message || "Erro ao carregar recomendações.";
      } finally {
        recommendersLoading = false;
        setRecommendersLoading(false);
      }
    }

    async function refreshRecommendationUI() {
      const state = await fetchRecommendationState();
      recommendationGiven = state.didRecommend;
      recommendCount.textContent = state.total === 1
        ? "1 recomendação"
        : `${state.total} recomendações`;
      if (!recommendBtn) return;
      if (!currentUser || currentUser.id === targetUserId) {
        recommendBtn.style.display = "none";
        return;
      }
      if (!currentUserProfile) {
        try {
          currentUserProfile = await fetchCurrentUserProfile();
        } catch (_err) {
          currentUserProfile = null;
        }
      }
      const canRecommend = !!currentUserProfile?.phone_verified;
      recommendBtn.style.display = "inline-flex";
      recommendBtn.disabled = !canRecommend;
      if (!canRecommend) {
        recommendBtn.title = "Apenas usuários com telefone verificado podem recomendar.";
        recommendBtn.innerHTML = `<img src="img/rec.png" alt="" class="recommend-icon" /> Verifique seu telefone para recomendar`;
        return;
      }
      recommendBtn.title = "";
      recommendBtn.disabled = false;
      recommendBtn.innerHTML = state.didRecommend
        ? `<img src="img/rec.png" alt="" class="recommend-icon" /> Não recomendar usuário`
        : `<img src="img/rec.png" alt="" class="recommend-icon" /> Recomendar usuário`;
    }

    function renderProfile(profile) {
      const firstName = (profile?.first_name || "").trim();
      const lastName = (profile?.last_name || "").trim();
      const displayName = `${firstName} ${lastName}`.trim() || "Usuário da comunidade";
      const discord = String(profile?.discord_username || "").trim();
      const profileStatus = String(profile?.status || "active");
      publicName.textContent = displayName;

      if (reportUserBtn) {
        const ownProfile = !!currentUser && currentUser.id === targetUserId;
        const canReport = !ownProfile && profileStatus === "active";
        reportUserBtn.style.display = canReport ? "inline-flex" : "none";
      }
      if (reportUserForm) reportUserForm.style.display = "none";
      if (reportUserReason) reportUserReason.value = "";
      if (reportUserFeedback) reportUserFeedback.textContent = "";
      if (reportUserFiles) reportUserFiles.value = "";
      updateReportFilesInfo();

      if (discord) {
        publicDiscord.innerHTML = "";
        const icon = document.createElement("img");
        icon.src = "img/discord.svg";
        icon.alt = "";
        icon.className = "discord-inline-icon";
        const value = document.createElement("span");
        value.textContent = discord;
        publicDiscord.appendChild(icon);
        publicDiscord.appendChild(value);
        publicDiscord.style.display = "inline-flex";
      } else {
        publicDiscord.style.display = "none";
      }

      if (profile?.about_me) {
        publicAbout.textContent = profile.about_me;
      } else {
        publicAbout.textContent = "Este usuário ainda não adicionou uma descrição.";
      }
    }

    function setupContactPanel(profile) {
      if (!contactToggleBtn || !contactPanel || !contactDiscord || !contactTelegram || !contactWhatsapp) return;
      const isOwnProfile = !!currentUser && currentUser.id === targetUserId;
      const discord = String(profile?.discord_username || "").trim();
      const firstName = String(profile?.first_name || "").trim();
      const phoneDigits = String(profile?.phone || "").replace(/\D/g, "");
      const hasTelegram = !!profile?.phone_verified && phoneDigits.length > 0;
      const hasWhatsapp = hasTelegram && !!profile?.show_whatsapp_button;
      const hasDiscord = !!discord;
      const hasAny = hasDiscord || hasTelegram || hasWhatsapp;
      const showOnPublicProfile = profile?.show_contacts_on_public_profile !== false;
      const baseLabel = `conversar com ${firstName || "usuário"}`;

      contactPanelVisible = false;
      contactPanel.style.display = "none";
      contactToggleBtn.textContent = baseLabel;
      contactToggleBtn.style.display = !isOwnProfile && hasAny && showOnPublicProfile ? "inline-flex" : "none";
      contactToggleBtn.dataset.baseLabel = baseLabel;

      if (isOwnProfile || !hasAny || !showOnPublicProfile) {
        contactDiscord.style.display = "none";
        contactTelegram.style.display = "none";
        contactWhatsapp.style.display = "none";
        return;
      }

      if (hasDiscord) {
        contactDiscord.textContent = `Discord: ${discord}`;
        contactDiscord.style.display = "block";
      } else {
        contactDiscord.style.display = "none";
      }

      if (hasTelegram) {
        contactTelegram.href = `https://t.me/+${phoneDigits}`;
        contactTelegram.style.display = "inline-flex";
      } else {
        contactTelegram.style.display = "none";
      }

      if (hasWhatsapp) {
        contactWhatsapp.href = `https://wa.me/${phoneDigits}`;
        contactWhatsapp.style.display = "inline-flex";
      } else {
        contactWhatsapp.style.display = "none";
      }
    }

    function toggleContactPanel() {
      if (!contactToggleBtn || !contactPanel || contactToggleBtn.style.display === "none") return;
      contactPanelVisible = !contactPanelVisible;
      contactPanel.style.display = contactPanelVisible ? "grid" : "none";
      contactToggleBtn.textContent = contactPanelVisible ? "Fechar contato" : (contactToggleBtn.dataset.baseLabel || "Conversar");
    }

    async function renderPublicAvatar(profile) {
      await setAvatarImage(publicAvatar, profile?.avatar_url || "img/avatar.svg");
    }

    function renderGames(listings) {
      publicGames.innerHTML = "";
      const uniqueGames = new Map();
      listings.forEach((listing) => {
        const server = getServerFromListing(listing);
        if (server.id && !uniqueGames.has(server.id)) {
          uniqueGames.set(server.id, server);
        }
      });
      if (uniqueGames.size === 0) {
        publicGamesEmpty.style.display = "block";
        return;
      }
      publicGamesEmpty.style.display = "none";
      uniqueGames.forEach((server) => {
        const link = document.createElement("a");
        link.className = "pill pill-link";
        link.href = `game.html?id=${encodeURIComponent(server.id)}`;
        link.textContent = server.name;
        publicGames.appendChild(link);
      });
    }

    function renderListings(listings) {
      publicListings.innerHTML = "";
      const activeListings = listings.filter((listing) => listing.status === "active");
      publicListingsCount.textContent = `${activeListings.length} anúncio${activeListings.length === 1 ? "" : "s"} ativo${activeListings.length === 1 ? "" : "s"}`;

      if (activeListings.length === 0) {
        publicListingsEmpty.style.display = "block";
        return;
      }

      publicListingsEmpty.style.display = "none";

      activeListings.forEach((listing) => {
        const card = document.createElement("a");
        card.className = "listing-card user-listing-link";
        card.href = `listing.html?id=${encodeURIComponent(listing.id)}`;

        const media = document.createElement("div");
        media.className = "listing-media";
        const firstImage = Array.isArray(listing.images) ? listing.images.find(Boolean) : null;
        if (firstImage) {
          const image = document.createElement("img");
          image.src = firstImage;
          image.alt = listing.title || "Imagem do anúncio";
          image.loading = "lazy";
          media.appendChild(image);
        } else {
          media.textContent = "Sem imagem";
        }

        const body = document.createElement("div");
        body.className = "listing-body";

        const title = document.createElement("h3");
        title.textContent = listing.title || "Sem título";
        body.appendChild(title);

        const server = getServerFromListing(listing);
        const serverLine = document.createElement("p");
        serverLine.className = "listing-server";
        serverLine.textContent = `${server?.name || "Não informado"}`;
        body.appendChild(serverLine);

        const published = document.createElement("p");
        published.className = "helper";
        published.textContent = `Publicado em ${formatDate(listing.created_at)}`;
        body.appendChild(published);

        card.appendChild(media);
        card.appendChild(body);
        publicListings.appendChild(card);
      });
    }

    async function handleRecommend() {
      if (!currentUser || !targetUserId || currentUser.id === targetUserId) return;
      if (!currentUserProfile) {
        currentUserProfile = await fetchCurrentUserProfile();
      }
      if (!currentUserProfile?.phone_verified) {
        feedback.textContent = "Apenas usuários com telefone verificado podem recomendar outros usuários.";
        return;
      }
      recommendBtn.disabled = true;
      recommendBtn.innerHTML = `<img src="img/rec.png" alt="" class="recommend-icon" /> Processando...`;
      try {
        if (recommendationGiven) {
          const { error } = await supabase
            .from("recommendations")
            .delete()
            .eq("user_id", targetUserId)
            .eq("author_id", currentUser.id);
          if (error) throw error;
        } else {
          const payload = {
            user_id: targetUserId,
            author_id: currentUser.id,
          };
          let { error } = await supabase
            .from("recommendations")
            .upsert(payload, { onConflict: "user_id,author_id" });
          if (error && error.code === "42P10") {
            const { data: existing, error: findError } = await supabase
              .from("recommendations")
              .select("id")
              .eq("user_id", targetUserId)
              .eq("author_id", currentUser.id)
              .maybeSingle();
            if (findError && findError.code !== "PGRST116") {
              throw findError;
            }
            if (!existing) {
              const { error: insertError } = await supabase.from("recommendations").insert(payload);
              if (insertError) throw insertError;
            }
            error = null;
          }
          if (error) throw error;
        }
        await refreshRecommendationUI();
        if (recommendersFetched) {
          await loadMoreRecommenders({ reset: true });
        }
        renderRecommendersEmpty(!recommendersHasMore && (!recommendersList || recommendersList.childElementCount === 0));
      } catch (err) {
        console.error(err);
        feedback.textContent = err?.message || "Erro ao registrar recomendação.";
      } finally {
        recommendBtn.disabled = false;
      }
    }

    async function handleRecommendCountClick() {
      try {
        openRecommendersModal();
        if (!recommendersFetched) {
          recommendersFetched = true;
          await loadMoreRecommenders({ reset: true });
        }
        const shouldShowEmpty = !!recommendersFetched && !recommendersHasMore && (!recommendersList || recommendersList.childElementCount === 0);
        renderRecommendersEmpty(shouldShowEmpty);
      } catch (err) {
        console.error(err);
        feedback.textContent = err?.message || "Erro ao carregar recomendações.";
      }
    }

    function handleRecommendersScroll() {
      if (!recommendersWrap || recommendersLoading || !recommendersHasMore) return;
      const threshold = 24;
      const reachedBottom = recommendersWrap.scrollTop + recommendersWrap.clientHeight >= recommendersWrap.scrollHeight - threshold;
      if (reachedBottom) {
        loadMoreRecommenders();
      }
    }

    async function init() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
        if (!currentUser) {
          window.location.replace("login.html");
          return;
        }

        const params = new URLSearchParams(window.location.search);
        targetUserId = params.get("id") || currentUser.id;

        const [profile, listings, viewerProfile] = await Promise.all([
          fetchPublicProfile(),
          fetchUserListings(),
          fetchCurrentUserProfile(),
        ]);
        currentUserProfile = viewerProfile;
        currentPublicProfile = profile;

        renderProfile(profile);
        setupContactPanel(profile);
        await renderPublicAvatar(profile);
        if (String(profile?.status || "active") !== "active") {
          const isBanned = String(profile?.status) === "banned";
          publicName.textContent = isBanned ? "Perfil banido" : "Perfil desativado";
          publicAbout.textContent = isBanned
            ? "Este perfil foi banido pela moderação."
            : "Este perfil está temporariamente desativado.";
          if (recommendBtn) recommendBtn.style.display = "none";
          if (reportUserBtn) reportUserBtn.style.display = "none";
          if (contactToggleBtn) contactToggleBtn.style.display = "none";
          if (recommendCount) recommendCount.textContent = "0 recomendações";
          renderGames([]);
          renderListings([]);
          if (publicGamesEmpty) publicGamesEmpty.style.display = "block";
          if (publicListingsEmpty) publicListingsEmpty.style.display = "block";
        } else {
          renderGames(listings);
          renderListings(listings);
        }

        if (currentUser.id === targetUserId) {
          selfProfileHint.style.display = "block";
          if (editProfileBtn) editProfileBtn.style.display = "inline-flex";
        } else {
          selfProfileHint.style.display = "none";
          if (editProfileBtn) editProfileBtn.style.display = "none";
        }

        await refreshRecommendationUI();
        renderRecommendersEmpty(false);
        closeRecommendersModal();
        markContentReady();
        revealPage();
      } catch (err) {
        console.error(err);
        feedback.textContent = err?.message || "Erro ao carregar perfil público.";
        publicName.textContent = "Perfil não encontrado.";
        markContentReady();
        revealPage();
      }
    }

    authBtn?.addEventListener("click", handleAuthClick);
    recommendBtn?.addEventListener("click", handleRecommend);
    reportUserBtn?.addEventListener("click", () => {
      if (!currentUser || !targetUserId) return;
      if (currentUser.id === targetUserId) return;
      if (String(currentPublicProfile?.status || "active") !== "active") return;
      if (!reportUserForm) return;
      const showing = reportUserForm.style.display !== "none";
      reportUserForm.style.display = showing ? "none" : "grid";
      if (!showing && reportUserReason) reportUserReason.focus();
    });
    reportUserCancel?.addEventListener("click", () => {
      if (reportUserForm) reportUserForm.style.display = "none";
      if (reportUserReason) reportUserReason.value = "";
      if (reportUserFeedback) reportUserFeedback.textContent = "";
      if (reportUserFiles) reportUserFiles.value = "";
      updateReportFilesInfo();
    });
    reportUserFiles?.addEventListener("change", updateReportFilesInfo);
    reportUserSubmit?.addEventListener("click", async () => {
      try {
        if (!currentUser || !targetUserId) return;
        if (currentUser.id === targetUserId) {
          if (reportUserFeedback) reportUserFeedback.textContent = "Você não pode denunciar seu próprio perfil.";
          return;
        }
        const reason = String(reportUserReason?.value || "").trim();
        if (reason.length < 10) {
          if (reportUserFeedback) reportUserFeedback.textContent = "Descreva o problema com pelo menos 10 caracteres.";
          return;
        }
        const files = getReportFiles();
        reportUserSubmit.disabled = true;
        if (reportUserFeedback) reportUserFeedback.textContent = "Enviando denúncia...";
        let evidenceImages = [];
        if (files.length > 0) {
          evidenceImages = await uploadReportEvidence(files, (done, total) => {
            if (reportUserFeedback) {
              reportUserFeedback.textContent = `Enviando anexos ${done}/${total}...`;
            }
          });
        }
        if (reportUserFeedback) reportUserFeedback.textContent = "Registrando denúncia...";
        const { error } = await supabase.from("reports").insert({
          reporter_id: currentUser.id,
          target_type: "user",
          reported_user_id: targetUserId,
          reason,
          evidence_images: evidenceImages,
        });
        if (error) {
          if (error.code === "23505") {
            throw new Error("Você já possui uma denúncia pendente para este perfil.");
          }
          throw error;
        }
        if (reportUserFeedback) reportUserFeedback.textContent = "Denúncia enviada para análise.";
        if (reportUserReason) reportUserReason.value = "";
        if (reportUserFiles) reportUserFiles.value = "";
        updateReportFilesInfo();
        if (reportUserForm) reportUserForm.style.display = "none";
      } catch (err) {
        console.error(err);
        if (reportUserFeedback) {
          reportUserFeedback.textContent = err?.message || "Erro ao enviar denúncia.";
        }
      } finally {
        if (reportUserSubmit) reportUserSubmit.disabled = false;
      }
    });
    contactToggleBtn?.addEventListener("click", toggleContactPanel);
    recommendCount?.addEventListener("click", handleRecommendCountClick);
    recommendersWrap?.addEventListener("scroll", handleRecommendersScroll);
    recommendersModalClose?.addEventListener("click", closeRecommendersModal);
    recommendersModal?.addEventListener("click", (event) => {
      if (event.target === recommendersModal) {
        closeRecommendersModal();
      }
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && recommendersModal?.classList.contains("open")) {
        closeRecommendersModal();
      }
    });
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
        window.location.href = "index.html";
      } catch (err) {
        console.error(err);
      }
    });

    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }
      window.location.href = "listing-create.html";
    }

    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });

    init();
  </script>
</body>
</html>
