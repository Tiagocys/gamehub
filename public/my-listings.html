<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Meus anúncios</title>
  <link rel="stylesheet" href="css/global.css" />
  <style id="my-listings-guard-style">html{visibility:hidden;}</style>
  <style>
    #my-listings-main.empty-state {
      gap: 10px;
      min-height: 45vh;
      align-content: start;
    }

    #my-listings-main.empty-state #my-listings-header-card {
      display: none;
    }

    #my-listings-main.empty-state #my-listings-empty {
      margin-top: 6px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(12, 21, 51, 0.03);
    }

    #my-listings-feedback {
      display: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(26, 122, 67, 0.25);
      background: rgba(26, 122, 67, 0.08);
      color: #145532;
      font-size: 14px;
    }

    #my-listings-grid {
      margin-top: 0;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    @media (min-width: 980px) {
      #my-listings-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (min-width: 1320px) {
      #my-listings-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    #my-listings-grid .listing-media {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #my-listings-grid .listing-media img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      object-position: center center;
      background: #ffffff;
      display: block;
    }

    #my-listings-grid .listing-description-preview {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 4;
      line-clamp: 4;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: pre-line;
    }

    #my-listings-grid .listing-body {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #my-listings-grid .listing-body .inline-actions {
      margin-top: auto;
      padding-top: 8px;
    }
  </style>
  <script>
    (() => {
      try {
        const hasSession = localStorage.getItem("gimerr-auth-token") || localStorage.getItem("gimerr-auth-session");
        if (!hasSession) {
          window.location.replace("index.html");
        }
      } catch (_err) {
        window.location.replace("index.html");
      }
    })();
  </script>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <site-navbar></site-navbar>

    <main class="section game-page" id="my-listings-main">
      <section class="hero-card" id="my-listings-header-card">
        <h2>Meus anúncios</h2>
        <p class="helper">Gerencie seus anúncios: edite, destaque ou exclua quando quiser.</p>
        <p id="my-listings-feedback"></p>
      </section>
      <section>
        <div id="my-listings-grid" class="listing-grid"></div>
        <p id="my-listings-empty" class="helper" style="display:none;">Você ainda não publicou anúncios.</p>
      </section>
    </main>

    <site-footer></site-footer>
  </div>

  <script src="env.js"></script>
  <script src="js/site-navbar.js"></script>
  <script src="js/site-footer.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    await (window.__NAVBAR_READY__ || Promise.resolve());

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
    const R2_PUBLIC_URL = env.R2_PUBLIC_URL || "";
    const R2_BUCKET = env.R2_BUCKET || "";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const createListingBtn = document.getElementById("create-listing-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const profileLink = document.getElementById("profile-link");

    const listingsGrid = document.getElementById("my-listings-grid");
    const listingsEmpty = document.getElementById("my-listings-empty");
    const myListingsMain = document.getElementById("my-listings-main");
    const feedbackEl = document.getElementById("my-listings-feedback");

    const pageLoader = document.getElementById("page-loader");
    let loaderDone = false;
    let windowLoaded = false;
    let avatarReady = false;

    function hideLoader() {
      if (loaderDone || !pageLoader) return;
      if (!windowLoaded || !avatarReady) return;
      loaderDone = true;
      pageLoader.classList.add("hidden");
      pageLoader.remove();
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    window.addEventListener("load", () => {
      windowLoaded = true;
      hideLoader();
    });

    let supabase;
    let currentUser = null;
    let avatarLoaded = false;
    let myListings = [];

    if (avatarImg) avatarImg.referrerPolicy = "no-referrer";

    const CATEGORY_LABELS = {
      item: "Item ou itens",
      currency: "Moeda do jogo",
      account: "Conta ou personagem",
      service: "Serviço",
      other: "Outro"
    };

    function revealPage() {
      document.documentElement.style.visibility = "visible";
      const guard = document.getElementById("my-listings-guard-style");
      if (guard) guard.remove();
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function showFeedback(message) {
      if (!feedbackEl || !message) return;
      feedbackEl.textContent = message;
      feedbackEl.style.display = "block";
    }

    function updateAuthUI() {
      if (!authBtn) return;
      authBtn.disabled = false;
      if (currentUser) {
        authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        if (profileLink) profileLink.href = `user.html?id=${encodeURIComponent(currentUser.id)}`;
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        loadUserAvatar();
        return;
      }
      authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (profileLink) profileLink.href = "profile.html";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      avatarLoaded = false;
      markAvatarReady();
    }

    async function setAvatarImage(src) {
      if (!avatarImg) return;
      const finalSrc = src || "img/avatar.svg";
      avatarImg.src = finalSrc;
      try {
        await avatarImg.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          avatarImg.src = "img/avatar.svg";
          try {
            await avatarImg.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      } finally {
        markAvatarReady();
      }
    }

    async function loadUserAvatar() {
      if (!avatarImg || !currentUser || avatarLoaded) return;
      try {
        ensureClient();
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatar);
        } catch (_innerErr) {
          await setAvatarImage("img/avatar.svg");
        }
      } finally {
        avatarLoaded = true;
      }
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const parts = rest.split("/");
        if (parts.length === 0) return null;
        let bucket = parts[0];
        let pathParts = parts.slice(1);
        if (bucket === "public" || bucket === "authenticated" || bucket === "sign") {
          bucket = parts[1];
          pathParts = parts.slice(2);
        }
        if (!bucket || pathParts.length === 0) return null;
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    async function resolveImageUrl(rawUrl) {
      if (!rawUrl || typeof rawUrl !== "string") return null;
      if (rawUrl.startsWith("http")) {
        if (R2_PUBLIC_URL && rawUrl.includes(".r2.cloudflarestorage.com/")) {
          try {
            const u = new URL(rawUrl);
            const marker = `/${R2_BUCKET || "img-anuncios"}/`;
            const idx = u.pathname.indexOf(marker);
            if (idx >= 0) {
              const path = u.pathname.substring(idx + marker.length);
              return `${R2_PUBLIC_URL.replace(/\/$/, "")}/${path}`;
            }
          } catch (_e) {
            // ignore and return original
          }
        }
        return rawUrl;
      }
      try {
        ensureClient();
        const { data: signedData, error: signedErr } = await supabase.functions.invoke("r2_sign_upload", {
          body: { mode: "get", key: rawUrl },
        });
        if (!signedErr && signedData?.publicUrl) {
          return signedData.publicUrl;
        }
      } catch (_err) {
        // ignore and fallback
      }
      const parsed = parseStoragePath(rawUrl);
      if (!parsed) return rawUrl;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60);
        if (error) throw error;
        return data?.signedUrl || rawUrl;
      } catch (_err) {
        return rawUrl;
      }
    }

    function formatCategory(category) {
      return CATEGORY_LABELS[category] || "Anúncio";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getListingCategories(listing) {
      const raw = Array.isArray(listing?.categories) ? listing.categories : [];
      const normalized = raw
        .map((value) => String(value || "").trim())
        .filter(Boolean);
      if (normalized.length > 0) return normalized;
      if (listing?.category) return [String(listing.category)];
      return [];
    }

    function isHighlightActive(listing) {
      return Boolean(listing && listing.highlight_status === "active");
    }

    function renderListings(list) {
      listingsGrid.innerHTML = "";
      if (!list || list.length === 0) {
        myListingsMain?.classList.add("empty-state");
        listingsEmpty.style.display = "block";
        return;
      }
      myListingsMain?.classList.remove("empty-state");
      listingsEmpty.style.display = "none";

      list.forEach((listing) => {
        const card = document.createElement("article");
        const highlightActive = isHighlightActive(listing);
        card.className = "listing-card";

        const safeTitle = escapeHtml(listing.title || "Sem título");
        const safeDescription = escapeHtml(listing.description || "Sem descrição.");
        const safeServerName = escapeHtml(listing.server_name || "");

        const imageUrl = listing.imageUrl || listing.images?.[0];
        const image = imageUrl
          ? `<div class="listing-media"><img src="${encodeURI(imageUrl)}" alt="${safeTitle}" loading="lazy" /></div>`
          : `<div class="listing-media empty">Sem imagem</div>`;

        const categoriesHtml = getListingCategories(listing)
          .map((category) => `<span class="pill">${formatCategory(category)}</span>`)
          .join("");

        const promoteLink = (!highlightActive && listing.status === "active")
          ? `<a class="btn btn-primary" href="ad-wallet.html">Destacar anúncio</a>`
          : "";

        card.innerHTML = `
          ${image}
          <div class="listing-body">
            <div class="listing-meta">
              ${safeServerName ? `<span class="pill">${safeServerName}</span>` : '<span class="pill">Game: não informado</span>'}
              ${categoriesHtml || '<span class="pill">Sem categoria</span>'}
            </div>
            <h3>${safeTitle}</h3>
            <p class="listing-description-preserve listing-description-preview">${safeDescription}</p>
            <div class="inline-actions">
              <a class="btn btn-ghost" href="listing.html?id=${encodeURIComponent(listing.id)}">Ver anúncio</a>
              <button class="btn btn-ghost" type="button" data-action="edit" data-id="${listing.id}">Editar</button>
              ${promoteLink}
              <button class="btn btn-ghost" type="button" data-action="delete" data-id="${listing.id}">Excluir</button>
            </div>
          </div>
        `;
        listingsGrid.appendChild(card);
      });
    }

    async function fetchMyListings() {
      ensureClient();
      const { data, error } = await supabase
        .from("listings")
        .select("id,title,description,images,category,categories,status,server_id,user_id,created_at,highlight_status")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });
      if (error) throw error;

      const list = data || [];
      const serverNameById = {};
      const uniqueServerIds = [...new Set(list.map((item) => item.server_id).filter(Boolean))];
      if (uniqueServerIds.length > 0) {
        const { data: serverRows, error: serverError } = await supabase
          .from("servers")
          .select("id,name")
          .in("id", uniqueServerIds);
        if (!serverError && Array.isArray(serverRows)) {
          serverRows.forEach((row) => {
            if (row?.id) {
              serverNameById[row.id] = row.name || "";
            }
          });
        }
      }

      const resolved = await Promise.all(
        list.map(async (item) => ({
          ...item,
          server_name: item.server_id ? (serverNameById[item.server_id] || "") : "",
          imageUrl: item.images?.[0] ? await resolveImageUrl(item.images[0]) : null,
        }))
      );
      myListings = resolved;
      renderListings(myListings);
    }

    async function deleteListing(listingId) {
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token || "";
      const { data, error } = await supabase.functions.invoke("listing_delete", {
        body: { listingId },
        headers: token
          ? {
              Authorization: `Bearer ${token}`,
              apikey: SUPABASE_ANON_KEY,
            }
          : {},
      });
      if (error) throw error;
      if (!data?.ok) {
        throw new Error(data?.error || "Erro ao excluir anúncio.");
      }
      await fetchMyListings();
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        authBtn.disabled = true;
        window.location.href = "index.html";
      } catch (_err) {
        // ignore
      }
    }

    listingsGrid?.addEventListener("click", async (event) => {
      const button = event.target.closest("button[data-action]");
      if (!button) return;
      const action = button.dataset.action;
      const id = button.dataset.id;
      if (!action || !id) return;
      const originalLabel = button.textContent;
      try {
        button.disabled = true;
        if (action === "edit") {
          window.location.href = `listing-create.html?edit=${encodeURIComponent(id)}`;
        } else if (action === "delete") {
          button.textContent = "Aguarde...";
          await deleteListing(id);
        }
      } catch (err) {
        console.error(err);
        alert(err?.message || "Erro ao gerenciar anúncio.");
      } finally {
        if (action === "edit") {
          button.disabled = false;
          return;
        }
        // Em exclusão bem-sucedida o card some no re-render.
        if (listingsGrid.contains(button)) {
          button.disabled = false;
          button.textContent = originalLabel;
        }
      }
    });

    authBtn?.addEventListener("click", handleAuthClick);
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
        window.location.href = "index.html";
      } catch (_err) {
        // ignore
      }
    });

    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "index.html";
        return;
      }
      window.location.href = "listing-create.html";
    }

    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });

    (async function init() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
        if (!currentUser) {
          window.location.replace("index.html");
          return;
        }
        await fetchMyListings();

        const params = new URLSearchParams(window.location.search);
        if (params.get("highlight_activated") === "1") {
          showFeedback("Destaque ativado com sucesso para o anúncio selecionado.");
        } else if (params.get("highlight") === "success") {
          showFeedback("Pagamento confirmado. Seu saldo de anúncios foi atualizado.");
        } else if (params.get("highlight") === "cancel") {
          showFeedback("Pagamento cancelado.");
        }
      } catch (err) {
        console.error(err);
        listingsEmpty.style.display = "block";
        listingsEmpty.textContent = err?.message || "Erro ao carregar seus anúncios.";
      } finally {
        revealPage();
      }
    })();
  </script>
</body>
</html>
