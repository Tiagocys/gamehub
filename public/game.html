<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta property="og:image:alt" content="Gimerr" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://gamehub-d35.pages.dev/img/meta.png" />
  <meta name="twitter:image:alt" content="Gimerr" />
  <link rel="icon" type="image/png" href="img/favicon.png" />
  <title>Gimerr - Game</title>
  <link rel="stylesheet" href="css/global.css" />
  <style>
    .game-hero-card {
      padding: 16px 18px;
      gap: 14px;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: center;
      min-height: 126px;
    }

    .game-hero-shell,
    .game-toolbar-shell {
      padding-bottom: 0;
    }

    .game-hero-copy {
      display: grid;
      gap: 8px;
    }

    .game-hero-head {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px 14px;
    }

    .game-hero-copy h1 {
      margin: 0;
      font-size: clamp(24px, 3vw, 34px);
      line-height: 1.05;
    }

    .game-description {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .game-logo-frame {
      width: 92px;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
    }

    #game-logo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .feed-toolbar {
      margin-top: 10px;
      display: grid;
      gap: 10px;
      width: 100%;
      min-height: 132px;
      align-content: start;
    }

    .section-header {
      display: block;
    }

    .section-header > div {
      width: min(820px, 100%);
      margin-inline: auto;
    }

    .feed-search {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(14, 165, 233, 0.35);
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      box-shadow: 0 12px 26px rgba(14, 165, 233, 0.14);
      padding: 12px 14px;
    }

    .feed-search-icon {
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #1287bc;
      flex: 0 0 auto;
    }

    .feed-search-icon svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .feed-search input {
      flex: 1;
      min-width: 0;
      border: none;
      outline: none;
      background: transparent;
      color: var(--ink);
      font-size: 14px;
      font-weight: 600;
    }

    .feed-search-meta {
      font-size: 12px;
      color: var(--muted);
      min-height: 18px;
      text-align: center;
    }

    .feed-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .feed-sort {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .feed-filter-btn {
      border: 1px solid var(--border);
      background: rgba(12, 21, 51, 0.04);
      color: var(--ink);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.16s ease;
    }

    .feed-filter-btn.active {
      border-color: rgba(27, 79, 211, 0.45);
      background: rgba(27, 79, 211, 0.16);
      color: #18408a;
    }

    .listing-feed {
      margin-top: 18px;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

    .game-feed-shell {
      position: relative;
      min-height: 220px;
    }

    .feed-loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 4;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(244, 248, 255, 0.98));
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .feed-loading-overlay.open {
      display: flex;
    }

    .feed-loading-overlay img {
      width: 108px;
      height: auto;
      opacity: 0.28;
      animation: feed-logo-pulse 1.2s ease-in-out infinite;
    }

    @keyframes feed-logo-pulse {
      0%, 100% { transform: scale(1); opacity: 0.22; }
      50% { transform: scale(1.04); opacity: 0.36; }
    }

    .listing-feed.is-refreshing {
      opacity: 0.9;
    }

    .feed-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(12, 21, 51, 0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      height: 100%;
      text-decoration: none;
      color: var(--ink);
    }

    .feed-card.matched {
      border-color: rgba(14, 165, 233, 0.48);
      box-shadow: 0 16px 26px rgba(14, 165, 233, 0.14);
    }

    .feed-media {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--border);
      background: radial-gradient(circle at 20% 20%, rgba(27,79,211,0.08), rgba(15,37,87,0.02));
      display: grid;
      place-items: center;
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
      align-items: center;
      justify-content: center;
    }

    .feed-highlight-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 2;
      padding: 4px 8px;
      border-radius: 999px;
      background: linear-gradient(120deg, #0ea5e9, #1d4ed8);
      color: #fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.01em;
      box-shadow: 0 8px 18px rgba(13, 79, 180, 0.3);
    }

    .feed-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .feed-media img.feed-media-fallback-logo {
      width: 68%;
      height: 68%;
      object-fit: contain;
      opacity: 0.18;
      filter: grayscale(100%);
      pointer-events: none;
      user-select: none;
    }

    .feed-title {
      font-size: 13px;
      color: var(--ink);
      margin: 0;
      line-height: 1.2;
      font-weight: 700;
      min-height: 30px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .feed-sentinel {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding: 8px;
    }

    @media (max-width: 860px) {
      .game-hero-card {
        grid-template-columns: 1fr;
        min-height: 0;
      }

      .game-logo-frame {
        width: 82px;
        margin-left: 0;
      }

      .feed-search {
        padding: 10px;
      }

      .feed-toolbar {
        min-height: 0;
      }

      .listing-feed {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .feed-media img:not(.feed-media-fallback-logo) {
        width: auto !important;
        height: auto !important;
        max-width: 100% !important;
        max-height: 100% !important;
        object-fit: unset !important;
        object-position: center center !important;
        background: #fff;
      }
    }
  </style>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <img src="img/logo.png" alt="Carregando" />
  </div>
  <div class="page">
    <site-navbar></site-navbar>

    <section class="section game-hero-shell">
      <div class="game-hero-card">
        <div class="game-hero-copy">
          <div class="game-hero-head">
            <h1 id="game-title">Carregando...</h1>
            <div id="game-actions" class="game-actions"></div>
          </div>
          <p id="game-description" class="game-description" style="display:none;"></p>
        </div>
        <div class="game-logo-frame">
          <img id="game-logo" alt="Logo do game" />
        </div>
      </div>
    </section>

    <section class="section game-toolbar-shell">
      <div class="section-header">
        <div>
          <div class="feed-toolbar">
            <div class="feed-search">
              <span class="feed-search-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="11" cy="11" r="6.5" stroke="currentColor" stroke-width="2"></circle>
                  <path d="M16 16L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                </svg>
              </span>
              <input
                id="listing-search"
                type="search"
                placeholder="O que você está procurando?"
                autocomplete="off"
              />
            </div>
            <div id="listing-search-meta" class="feed-search-meta"></div>
            <div id="category-filters" class="feed-filters"></div>
            <div id="sort-filters" class="feed-sort"></div>
          </div>
        </div>
      </div>
    </section>

    <main class="game-page">
      <section class="section">
        <div id="game-feed-shell" class="game-feed-shell">
          <div id="listing-feed" class="listing-feed"></div>
          <div id="feed-sentinel" class="feed-sentinel" style="display:none;">Role para carregar mais</div>
          <p id="listing-empty" class="search-feedback" style="display:none;">Nenhum anúncio para este game ainda.</p>
          <div id="feed-loading-overlay" class="feed-loading-overlay" aria-hidden="true">
            <img src="img/logo.png" alt="Carregando anúncios" />
          </div>
        </div>
      </section>
    </main>

    <site-footer></site-footer>
  </div>

  <script src="env.js"></script>
  <script src="js/site-navbar.js"></script>
  <script src="js/site-footer.js"></script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.40.0";

    await (window.__NAVBAR_READY__ || Promise.resolve());

    const env = window.__ENV || {};
    const SUPABASE_URL = env.SUPABASE_URL || "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || "YOUR_SUPABASE_ANON_KEY";
    const R2_PUBLIC_URL = env.R2_PUBLIC_URL || "";
    const R2_BUCKET = env.R2_BUCKET || "";

    const authBtn = document.getElementById("auth-btn");
    const userMenu = document.getElementById("user-menu");
    const avatarBtn = document.getElementById("avatar-btn");
    const avatarImg = document.getElementById("avatar-img");
    const logoutBtn = document.getElementById("logout-btn");
    const createListingBtn = document.getElementById("create-listing-btn");
    const menuCreateListing = document.getElementById("menu-create-listing");
    const profileLink = document.getElementById("profile-link");
    const titleEl = document.getElementById("game-title");
    const descriptionEl = document.getElementById("game-description");
    const logoEl = document.getElementById("game-logo");
    const actionsEl = document.getElementById("game-actions");
    const listingSearchInput = document.getElementById("listing-search");
    const listingSearchMeta = document.getElementById("listing-search-meta");
    const listingFeed = document.getElementById("listing-feed");
    const categoryFilters = document.getElementById("category-filters");
    const sortFilters = document.getElementById("sort-filters");
    const feedSentinel = document.getElementById("feed-sentinel");
    const listingEmpty = document.getElementById("listing-empty");
    const gameFeedShell = document.getElementById("game-feed-shell");
    const feedLoadingOverlay = document.getElementById("feed-loading-overlay");

    const pageLoader = document.getElementById("page-loader");
    let initialLoaderCompleted = false;
    let transientLoaderCount = 0;
    let windowLoaded = false;
    let avatarReady = false;
    let contentReady = false;

    function hideLoader() {
      if (!pageLoader) return;
      if (!windowLoaded || !avatarReady || !contentReady) return;
      initialLoaderCompleted = true;
      if (transientLoaderCount > 0) {
        pageLoader.classList.remove("hidden");
        return;
      }
      pageLoader.classList.add("hidden");
    }

    function showTransientLoader() {
      if (!pageLoader || !initialLoaderCompleted) return;
      transientLoaderCount += 1;
      pageLoader.classList.remove("hidden");
    }

    function hideTransientLoader() {
      if (!pageLoader || !initialLoaderCompleted) return;
      transientLoaderCount = Math.max(0, transientLoaderCount - 1);
      if (transientLoaderCount === 0) {
        pageLoader.classList.add("hidden");
      }
    }

    function setFeedInlineLoading(isLoading) {
      if (!feedLoadingOverlay || !listingFeed) return;
      if (isLoading) {
        if (gameFeedShell && listingFeed) {
          const currentHeight = Math.max(220, gameFeedShell.offsetHeight || listingFeed.offsetHeight || 0);
          gameFeedShell.style.minHeight = `${currentHeight}px`;
        }
        feedLoadingOverlay.classList.add("open");
        feedLoadingOverlay.setAttribute("aria-hidden", "false");
        listingFeed.style.visibility = "hidden";
        if (feedSentinel) feedSentinel.style.visibility = "hidden";
        if (listingEmpty) listingEmpty.style.visibility = "hidden";
        return;
      }
      listingFeed.style.visibility = "";
      if (feedSentinel) feedSentinel.style.visibility = "";
      if (listingEmpty) listingEmpty.style.visibility = "";
      feedLoadingOverlay.classList.remove("open");
      feedLoadingOverlay.setAttribute("aria-hidden", "true");
      if (gameFeedShell) gameFeedShell.style.minHeight = "";
    }

    function waitForImageWithTimeout(img, timeoutMs = 1600) {
      if (!img) return Promise.resolve();
      if (img.complete) return Promise.resolve();
      return new Promise((resolve) => {
        let done = false;
        const finish = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve();
        };
        const timer = setTimeout(finish, timeoutMs);
        img.addEventListener("load", finish, { once: true });
        img.addEventListener("error", finish, { once: true });
      });
    }

    async function waitForVisibleFeedCards(maxImages = 16) {
      if (!listingFeed) return;
      const images = Array.from(listingFeed.querySelectorAll(".feed-card img")).slice(0, maxImages);
      if (images.length === 0) return;
      await Promise.all(images.map((img) => waitForImageWithTimeout(img)));
    }

    function markAvatarReady() {
      avatarReady = true;
      hideLoader();
    }

    function markContentReady() {
      contentReady = true;
      hideLoader();
    }

    setTimeout(() => {
      if (!avatarReady) markAvatarReady();
      if (!contentReady) markContentReady();
    }, 5000);

    function markWindowReady() {
      if (windowLoaded) return;
      windowLoaded = true;
      hideLoader();
    }

    document.addEventListener("DOMContentLoaded", markWindowReady, { once: true });
    window.addEventListener("load", markWindowReady, { once: true });
    setTimeout(markWindowReady, 4500);

    let supabase;
    let currentUser = null;
    let avatarLoaded = false;
    let allListings = [];
    let orderedListings = [];
    let visibleCount = 0;
    let activeCategoryFilter = "all";
    let activeSortFilter = "recent";
    let searchQuery = "";
    let feedObserver = null;
    let isRenderingBatch = false;
    if (avatarImg) avatarImg.referrerPolicy = "no-referrer";

    const CARD_MIN_WIDTH_DESKTOP = 180;
    const CARD_ESTIMATED_HEIGHT = 238;
    const FEED_MIN_BATCH_SIZE = 16;
    const FEED_MAX_BATCH_SIZE = 84;
    let feedPageSize = 24;
    const FILTER_OPTIONS = [
      { value: "all", label: "Todas" },
      { value: "currency", label: "Moeda do jogo" },
      { value: "item", label: "Item ou itens" },
      { value: "account", label: "Conta ou personagem" },
      { value: "service", label: "Serviço" },
    ];
    const SORT_OPTIONS = [
      { value: "relevant", label: "Mais relevantes" },
      { value: "recent", label: "Mais recentes" },
    ];

    function computeFeedPageSize() {
      const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 1024;
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 800;
      const feedWidth = listingFeed?.clientWidth || viewportWidth;
      const columns = viewportWidth <= 860
        ? 2
        : Math.max(2, Math.floor(feedWidth / CARD_MIN_WIDTH_DESKTOP));
      const reservedHeight = viewportWidth <= 860 ? 360 : 330;
      const usableHeight = Math.max(320, viewportHeight - reservedHeight);
      const visibleRows = Math.max(2, Math.ceil(usableHeight / CARD_ESTIMATED_HEIGHT));
      const preloadRows = 2;
      const computed = columns * (visibleRows + preloadRows);
      return Math.max(FEED_MIN_BATCH_SIZE, Math.min(FEED_MAX_BATCH_SIZE, computed));
    }

    function ensureClient() {
      if (!SUPABASE_URL || SUPABASE_URL.startsWith("YOUR_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("YOUR_")) {
        titleEl.textContent = "Supabase não configurado.";
        if (authBtn) authBtn.disabled = true;
        throw new Error("Supabase não configurado");
      }
      if (!supabase) {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storageKey: "gimerr-auth-token",
          },
        });
        supabase.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAuthUI();
        });
      }
      return supabase;
    }

    function updateAuthUI() {
      if (authBtn) authBtn.disabled = false;
      if (currentUser) {
        if (authBtn) authBtn.style.display = "none";
        if (userMenu) userMenu.style.display = "inline-flex";
        if (profileLink) profileLink.href = `user.html?id=${encodeURIComponent(currentUser.id)}`;
        if (!avatarImg) {
          markAvatarReady();
        } else {
          loadUserAvatar();
        }
        if (createListingBtn) createListingBtn.style.display = "inline-flex";
        if (menuCreateListing) menuCreateListing.style.display = "";
        return;
      }
      if (authBtn) authBtn.style.display = "inline-flex";
      if (userMenu) userMenu.style.display = "none";
      if (profileLink) profileLink.href = "profile.html";
      if (createListingBtn) createListingBtn.style.display = "none";
      if (menuCreateListing) menuCreateListing.style.display = "none";
      avatarLoaded = false;
      markAvatarReady();
    }

    async function setAvatarImage(src) {
      if (!avatarImg) return;
      const finalSrc = src || "img/avatar.svg";
      avatarImg.src = finalSrc;
      try {
        await avatarImg.decode();
      } catch (_err) {
        if (finalSrc !== "img/avatar.svg") {
          avatarImg.src = "img/avatar.svg";
          try {
            await avatarImg.decode();
          } catch (_innerErr) {
            // ignore
          }
        }
      } finally {
        markAvatarReady();
      }
    }

    async function loadUserAvatar() {
      if (!currentUser || avatarLoaded) return;
      if (!avatarImg) {
        markAvatarReady();
        return;
      }
      try {
        ensureClient();
        const { data } = await supabase
          .from("users")
          .select("avatar_url")
          .eq("id", currentUser.id)
          .single();
        let avatar = data?.avatar_url;
        if (!avatar) {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
        }
        await setAvatarImage(avatar);
      } catch (_err) {
        try {
          const { data: authData } = await supabase.auth.getUser();
          const meta = authData?.user?.user_metadata || {};
          const avatar = meta.avatar_url || meta.picture || currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
          await setAvatarImage(avatar);
        } catch (_innerErr) {
          await setAvatarImage("img/avatar.svg");
        }
      } finally {
        avatarLoaded = true;
      }
    }

    async function handleAuthClick() {
      try {
        ensureClient();
        if (authBtn) authBtn.disabled = true;
        window.location.href = "index.html";
      } catch (err) {
        console.error(err);
      }
    }

    function parseStoragePath(urlString) {
      try {
        const url = new URL(urlString);
        const marker = "/storage/v1/object/";
        const idx = url.pathname.indexOf(marker);
        if (idx === -1) return null;
        const rest = url.pathname.substring(idx + marker.length);
        const parts = rest.split("/");
        if (parts.length === 0) return null;
        let bucket = parts[0];
        let pathParts = parts.slice(1);
        if (bucket === "public" || bucket === "authenticated" || bucket === "sign") {
          bucket = parts[1];
          pathParts = parts.slice(2);
        }
        if (!bucket || pathParts.length === 0) return null;
        return { bucket, path: pathParts.join("/") };
      } catch (_err) {
        return null;
      }
    }

    function normalizeR2PublicUrl(urlString) {
      try {
        const url = new URL(urlString);
        if (R2_PUBLIC_URL) {
          const publicHost = new URL(R2_PUBLIC_URL).host;
          if (url.hostname.endsWith(".r2.dev") && url.hostname !== publicHost) {
            return `${R2_PUBLIC_URL.replace(/\/$/, "")}${url.pathname}`;
          }
        }
        if (!url.hostname.endsWith(".r2.cloudflarestorage.com")) return urlString;
        const parts = url.pathname.split("/").filter(Boolean);
        if (parts.length === 0) return urlString;
        const accountId = url.hostname.split(".")[0];
        let bucket = R2_BUCKET;
        let keyParts = parts;
        if (bucket) {
          if (parts[0] === bucket) {
            keyParts = parts.slice(1);
          }
        } else {
          bucket = parts[0];
          keyParts = parts.slice(1);
        }
        if (!bucket || keyParts.length === 0) return urlString;
        const base = R2_PUBLIC_URL ? R2_PUBLIC_URL.replace(/\/$/, "") : `https://${bucket}.${accountId}.r2.dev`;
        return `${base}/${keyParts.join("/")}`;
      } catch (_err) {
        return urlString;
      }
    }

    async function resolveImageUrl(urlString) {
      if (!urlString) return urlString;
      const normalized = normalizeR2PublicUrl(urlString);
      if (!normalized.includes(SUPABASE_URL) || !normalized.includes("/storage/v1/object/")) {
        return normalized;
      }
      const parsed = parseStoragePath(normalized);
      if (!parsed) return normalized;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || normalized;
      } catch (err) {
        console.warn("Falha ao assinar imagem do anuncio", err);
        return normalized;
      }
    }

    async function getSignedCoverUrl(urlString) {
      const parsed = parseStoragePath(urlString);
      if (!parsed) return urlString;
      try {
        ensureClient();
        const { data, error } = await supabase.storage
          .from(parsed.bucket)
          .createSignedUrl(parsed.path, 60 * 60 * 6);
        if (error) throw error;
        return data?.signedUrl || urlString;
      } catch (err) {
        console.warn("Falha ao assinar cover", err);
        return urlString;
      }
    }

    async function fetchGameById(id) {
      try {
        ensureClient();
        const { data, error } = await supabase
          .from("servers")
          .select("id,name,official_site,banner_url,description")
          .eq("id", id)
          .single();
        if (error) throw error;
        return data ? {
          id: data.id,
          name: data.name,
          website: data.official_site,
          cover_url: data.banner_url,
          description: data.description,
        } : null;
      } catch (err) {
        console.warn("Falha ao buscar em servers, tentando games.", err);
        const { data, error } = await supabase
          .from("games")
          .select("id,name,website,cover_url")
          .eq("id", id)
          .single();
        if (error) throw error;
        return data ? {
          id: data.id,
          name: data.name,
          website: data.website,
          cover_url: data.cover_url,
          description: null,
        } : null;
      }
    }

    function renderGame(game) {
      if (!game) {
        titleEl.textContent = "Game não encontrado.";
        logoEl.style.display = "none";
        if (descriptionEl) descriptionEl.style.display = "none";
        return;
      }
      titleEl.textContent = game.name;
      if (descriptionEl) {
        const text = String(game.description || "").trim();
        if (text) {
          descriptionEl.textContent = text;
          descriptionEl.style.display = "block";
        } else {
          descriptionEl.textContent = "";
          descriptionEl.style.display = "none";
        }
      }
      if (game.cover_url) {
        logoEl.src = game.cover_url;
        logoEl.style.display = "block";
      } else {
        logoEl.style.display = "none";
      }
      actionsEl.innerHTML = game.website
        ? `<a class="pill pill-link" href="${game.website}" target="_blank" rel="noopener">Site oficial</a>`
        : `<span class="pill">Site indisponível</span>`;
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getListingCategories(listing) {
      const raw = Array.isArray(listing?.categories) ? listing.categories : [];
      const normalized = raw
        .map((value) => String(value || "").trim())
        .filter(Boolean);
      if (normalized.length > 0) return normalized;
      if (listing?.category) return [String(listing.category)];
      return [];
    }

    function isHighlightActive(listing) {
      return Boolean(listing && listing.highlight_status === "active");
    }

    function getListingRelevanceScore(listing) {
      return Number(listing?.user_recommendations_count || 0);
    }

    function listingHasCategory(listing, category) {
      if (category === "all") return true;
      return getListingCategories(listing).includes(category);
    }

    function listingMatchesQuery(listing, query) {
      const normalizedQuery = String(query || "").trim().toLowerCase();
      if (!normalizedQuery) return true;
      const haystack = `${listing?.title || ""} ${listing?.description || ""}`.toLowerCase();
      return haystack.includes(normalizedQuery);
    }

    function getCardImageUrl(listing) {
      const list = Array.isArray(listing?.images) ? listing.images : [];
      return list.find(Boolean) || "";
    }

    function waitForImageElement(img, timeoutMs = 1800) {
      if (!img) return Promise.resolve();
      const src = img.getAttribute("src");
      if (!src) return Promise.resolve();
      if (img.complete) return Promise.resolve();
      return new Promise((resolve) => {
        let done = false;
        const finish = () => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          resolve();
        };
        const timer = setTimeout(finish, timeoutMs);
        img.addEventListener("load", finish, { once: true });
        img.addEventListener("error", finish, { once: true });
      });
    }

    async function waitForCriticalVisuals() {
      const criticalImages = Array.from(
        document.querySelectorAll("#game-logo, #listing-feed .feed-card:nth-child(-n+2) img"),
      );
      await Promise.all(criticalImages.map((img) => waitForImageElement(img)));
    }

    function compareListingBySort(a, b) {
      if (activeSortFilter === "relevant") {
        const relevanceDiff = getListingRelevanceScore(b) - getListingRelevanceScore(a);
        if (relevanceDiff !== 0) return relevanceDiff;
      }
      return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
    }

    function buildOrderedFeed(list) {
      if (!Array.isArray(list) || list.length === 0) return [];
      const highlighted = [];
      const normal = [];

      list.forEach((item) => {
        if (isHighlightActive(item)) {
          highlighted.push(item);
        } else {
          normal.push(item);
        }
      });

      for (let i = highlighted.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [highlighted[i], highlighted[j]] = [highlighted[j], highlighted[i]];
      }

      normal.sort(compareListingBySort);

      const merged = [];
      const maxLen = Math.max(highlighted.length, normal.length);
      for (let i = 0; i < maxLen; i += 1) {
        if (highlighted[i]) merged.push(highlighted[i]);
        if (normal[i]) merged.push(normal[i]);
      }

      return merged;
    }

    function renderCategoryFilters() {
      if (!categoryFilters) return;
      categoryFilters.innerHTML = FILTER_OPTIONS
        .map((option) => `
          <button
            type="button"
            class="feed-filter-btn${activeCategoryFilter === option.value ? " active" : ""}"
            data-category="${option.value}">
            ${option.label}
          </button>
        `)
        .join("");
    }

    function renderSortFilters() {
      if (!sortFilters) return;
      sortFilters.innerHTML = SORT_OPTIONS
        .map((option) => `
          <button
            type="button"
            class="feed-filter-btn${activeSortFilter === option.value ? " active" : ""}"
            data-sort="${option.value}">
            ${option.label}
          </button>
        `)
        .join("");
    }

    async function attachRecommendationsScore(listings) {
      const items = Array.isArray(listings) ? listings : [];
      const userIds = Array.from(new Set(
        items
          .map((item) => String(item?.user_id || "").trim())
          .filter(Boolean),
      ));
      if (userIds.length === 0) {
        return items.map((item) => ({ ...item, user_recommendations_count: 0 }));
      }

      const scoreMap = new Map();
      await Promise.all(userIds.map(async (userId) => {
        try {
          const { count, error } = await supabase
            .from("recommendations")
            .select("id", { count: "exact", head: true })
            .eq("user_id", userId);
          if (error) throw error;
          scoreMap.set(userId, Number(count || 0));
        } catch (_err) {
          scoreMap.set(userId, 0);
        }
      }));

      return items.map((item) => ({
        ...item,
        user_recommendations_count: scoreMap.get(String(item?.user_id || "").trim()) || 0,
      }));
    }

    async function ensureCardImageResolved(listing) {
      const rawImage = getCardImageUrl(listing);
      if (!rawImage) {
        listing._cardImageSource = "";
        listing.cardImage = "";
        return listing;
      }

      if (listing._cardImageSource === rawImage && typeof listing.cardImage === "string") {
        return listing;
      }

      const resolvedImage = await resolveImageUrl(rawImage);
      listing._cardImageSource = rawImage;
      listing.cardImage = resolvedImage || "";
      return listing;
    }

    function createListingCard(listing) {
      const card = document.createElement("a");
      card.className = "feed-card";
      card.href = `listing.html?id=${encodeURIComponent(listing.id)}`;
      const matched = listingMatchesQuery(listing, searchQuery);
      card.classList.toggle("matched", matched && String(searchQuery || "").trim().length > 0);
      const highlightBadge = isHighlightActive(listing)
        ? `<span class="feed-highlight-badge">Em destaque</span>`
        : "";
      const media = listing.cardImage
        ? `<div class="feed-media">${highlightBadge}<img src="${encodeURI(listing.cardImage)}" alt="Imagem do anúncio ${escapeHtml(listing.title || "Anúncio")}" loading="lazy" /></div>`
        : `<div class="feed-media empty">${highlightBadge}<img src="img/logo.png" alt="" class="feed-media-fallback-logo" loading="lazy" /></div>`;
      card.innerHTML = `
        ${media}
        <h3 class="feed-title">${escapeHtml(listing.title || "Anúncio")}</h3>
      `;
      return card;
    }

    function updateFeedState() {
      if (!listingEmpty || !feedSentinel) return;
      if (orderedListings.length === 0) {
        listingEmpty.style.display = "block";
        listingEmpty.textContent = String(searchQuery || "").trim()
          ? `Nenhum anúncio encontrado para "${searchQuery.trim()}".`
          : "Nenhum anúncio para este game ainda.";
        feedSentinel.style.display = "none";
        return;
      }
      listingEmpty.style.display = "none";
      feedSentinel.style.display = "block";
      if (visibleCount >= orderedListings.length) {
        feedSentinel.textContent = "Fim dos anúncios.";
      } else {
        feedSentinel.textContent = "Role para carregar mais";
      }
    }

    function updateSearchMeta(total) {
      if (!listingSearchMeta) return;
      const normalizedQuery = String(searchQuery || "").trim();
      if (!normalizedQuery) {
        listingSearchMeta.textContent = `${total} anúncio(s) carregado(s).`;
        return;
      }
      listingSearchMeta.textContent = `${total} resultado(s) para "${normalizedQuery}".`;
    }

    async function renderNextBatch() {
      if (isRenderingBatch || !listingFeed) return;
      if (visibleCount >= orderedListings.length) {
        updateFeedState();
        return;
      }

      isRenderingBatch = true;
      try {
        const batch = orderedListings.slice(visibleCount, visibleCount + feedPageSize);
        await Promise.all(batch.map((item) => ensureCardImageResolved(item)));
        const fragment = document.createDocumentFragment();
        batch.forEach((item) => {
          fragment.appendChild(createListingCard(item));
        });
        listingFeed.appendChild(fragment);
        visibleCount += batch.length;
        updateFeedState();
      } finally {
        isRenderingBatch = false;
      }
    }

    async function resetFeed() {
      if (!listingFeed) return;
      visibleCount = 0;
      if (orderedListings.length === 0) {
        listingFeed.innerHTML = "";
        updateFeedState();
        return;
      }

      const initialBatch = orderedListings.slice(0, feedPageSize);
      listingFeed.classList.add("is-refreshing");
      try {
        await Promise.all(initialBatch.map((item) => ensureCardImageResolved(item)));
        const fragment = document.createDocumentFragment();
        initialBatch.forEach((item) => {
          fragment.appendChild(createListingCard(item));
        });
        listingFeed.innerHTML = "";
        listingFeed.appendChild(fragment);
        visibleCount = initialBatch.length;
        updateFeedState();
        await fillFeedUntilTarget();
      } finally {
        listingFeed.classList.remove("is-refreshing");
      }
    }

    async function fillFeedUntilTarget() {
      while (visibleCount < feedPageSize && visibleCount < orderedListings.length) {
        await renderNextBatch();
      }
    }

    function setupFeedObserver() {
      if (!feedSentinel) return;
      if (feedObserver) feedObserver.disconnect();
      feedObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            renderNextBatch();
          }
        });
      }, {
        root: null,
        rootMargin: "280px 0px 280px 0px",
        threshold: 0.01,
      });
      feedObserver.observe(feedSentinel);
    }

    async function refreshFeed(options = {}) {
      const withLoader = Boolean(options?.withLoader);
      const withInlineLoader = Boolean(options?.inlineLoader);
      if (withLoader) {
        showTransientLoader();
        await new Promise((resolve) => requestAnimationFrame(() => resolve()));
      }
      if (withInlineLoader) {
        setFeedInlineLoading(true);
        await new Promise((resolve) => requestAnimationFrame(() => resolve()));
      }
      try {
        feedPageSize = computeFeedPageSize();
        const filteredByCategory = activeCategoryFilter === "all"
          ? allListings
          : allListings.filter((item) => listingHasCategory(item, activeCategoryFilter));
        const filtered = String(searchQuery || "").trim()
          ? filteredByCategory.filter((item) => listingMatchesQuery(item, searchQuery))
          : filteredByCategory;
        orderedListings = buildOrderedFeed(filtered);
        updateSearchMeta(filtered.length);
        renderCategoryFilters();
        renderSortFilters();
        await resetFeed();
      } finally {
        if (withInlineLoader) {
          await waitForVisibleFeedCards();
          setFeedInlineLoading(false);
        }
        if (withLoader) {
          hideTransientLoader();
        }
      }
    }

    async function fetchListings(gameId) {
      try {
        ensureClient();
        const { data, error } = await supabase
          .from("listings")
          .select("id,title,description,images,category,categories,status,server_id,user_id,created_at,highlight_status,highlight_expires_at")
          .eq("server_id", gameId)
          .eq("status", "active")
          .order("created_at", { ascending: false });
        if (error) throw error;
        allListings = await attachRecommendationsScore(data || []);
        await refreshFeed();
      } catch (err) {
        console.error(err);
        allListings = [];
        orderedListings = [];
        if (listingFeed) listingFeed.innerHTML = "";
        if (listingEmpty) {
          listingEmpty.style.display = "block";
          listingEmpty.textContent = err?.message || "Erro ao carregar anúncios.";
        }
        if (feedSentinel) feedSentinel.style.display = "none";
        setFeedInlineLoading(false);
      }
    }

    async function init() {
      try {
        ensureClient();
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user || null;
        updateAuthUI();
        const params = new URLSearchParams(window.location.search);
        const gameId = params.get("id");
        if (!gameId) {
          titleEl.textContent = "Game não encontrado.";
          logoEl.style.display = "none";
          return;
        }
        const game = await fetchGameById(gameId);
        if (game?.cover_url) {
          game.cover_url = await getSignedCoverUrl(game.cover_url);
        }
        renderGame(game);
        renderCategoryFilters();
        setupFeedObserver();
        await fetchListings(gameId);
      } catch (err) {
        console.error(err);
        titleEl.textContent = "Erro ao carregar game.";
        if (listingSearchMeta) {
          listingSearchMeta.textContent = err?.message || "Tente novamente.";
        }
      } finally {
        try {
          await waitForCriticalVisuals();
        } catch (_err) {
          // ignore image wait errors
        }
        markContentReady();
      }
    }

    authBtn?.addEventListener("click", handleAuthClick);
    avatarBtn?.addEventListener("click", (event) => {
      event.stopPropagation();
      userMenu?.classList.toggle("open");
    });
    document.addEventListener("click", (event) => {
      if (!userMenu) return;
      if (!userMenu.contains(event.target)) {
        userMenu.classList.remove("open");
      }
    });
    categoryFilters?.addEventListener("click", (event) => {
      const button = event.target.closest(".feed-filter-btn");
      if (!button) return;
      if (button.hasAttribute("data-sort")) return;
      const category = button.getAttribute("data-category") || "all";
      if (category === activeCategoryFilter) return;
      activeCategoryFilter = category;
      refreshFeed({ inlineLoader: true });
    });
    sortFilters?.addEventListener("click", (event) => {
      const button = event.target.closest(".feed-filter-btn[data-sort]");
      if (!button) return;
      const sort = button.getAttribute("data-sort") || "recent";
      if (sort === activeSortFilter) return;
      activeSortFilter = sort;
      refreshFeed({ inlineLoader: true });
    });
    listingSearchInput?.addEventListener("input", () => {
      searchQuery = listingSearchInput.value || "";
      refreshFeed();
    });
    window.addEventListener("resize", () => {
      const nextSize = computeFeedPageSize();
      if (nextSize === feedPageSize) return;
      feedPageSize = nextSize;
      if (visibleCount < feedPageSize && visibleCount < orderedListings.length) {
        fillFeedUntilTarget();
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      try {
        ensureClient();
        await supabase.auth.signOut();
        currentUser = null;
        updateAuthUI();
      } catch (err) {
        console.error(err);
      }
    });
    function goToCreateListing() {
      if (!currentUser) {
        window.location.href = "index.html";
        return;
      }
      window.location.href = "listing-create.html";
    }
    createListingBtn?.addEventListener("click", goToCreateListing);
    menuCreateListing?.addEventListener("click", () => {
      userMenu?.classList.remove("open");
      goToCreateListing();
    });
    init();
  </script>
</body>
</html>
